<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Configura√ß√µes - Class Photo Booth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        .avatar-circle {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <span class="display-6 me-2">‚öôÔ∏è</span>
                <div>
                    <div class="fw-bold">Configura√ß√µes</div>
                    <small class="text-white-50 d-block">Gerir dados dos alunos</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                {% if has_data %}
                <a href="{{ url_for('turmas') }}" class="btn btn-light btn-sm rounded-pill px-3" title="Ver Turmas">
                    <i class="bi bi-eye me-1"></i>
                    <span class="d-none d-md-inline">Turmas</span>
                </a>
                {% else %}
                <a href="{{ url_for('turmas') }}" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Voltar">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-md-inline">Voltar</span>
                </a>
                {% endif %}
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conte√∫do principal -->
    <main class="container my-5">
        <!-- Gest√£o de Utilizadores -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2"></i>
                                Gest√£o de Utilizadores
                            </h5>
                            <div>
                                <button type="button" class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus me-1"></i>
                                    Adicionar Utilizador
                                </button>
                                <span class="badge bg-light text-primary">{{ users|length }} utilizador{{ 'es' if users|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50"></th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Permiss√£o</th>
                                        <th>Estado</th>
                                        <th width="120">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>
                                            <div class="avatar-circle">
                                                {{ user.name[0].upper() }}
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ user.name }}</strong>
                                            {% if user.id == current_user.id %}
                                                <span class="badge bg-info ms-1">Voc√™</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            {% if user.role == 'admin' %}
                                                <span class="badge bg-danger">Administrador</span>
                                            {% elif user.role == 'editor' %}
                                                <span class="badge bg-warning">Editor</span>
                                            {% elif user.role == 'viewer' %}
                                                <span class="badge bg-success">Visualizador</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Sem Permiss√µes</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_verified %}
                                                <span class="text-success">
                                                    <i class="bi bi-check-circle"></i> Verificado
                                                </span>
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="bi bi-clock"></i> Pendente
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editUserModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Editar utilizador">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Alterar senha">
                                                    <i class="bi bi-key"></i>
                                                </button>
                                                {% if user.id != current_user.id %}
                                                <button type="button" class="btn btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteUserModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Eliminar utilizador">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if not users %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-people display-4"></i>
                            <p class="mt-2">Nenhum utilizador encontrado</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>




<!-- Se√ß√£o de Gest√£o de Pr√© Utilizadores -->
        {% if preusers %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Pr√© Utilizadores do Sistema
                            </h5>
                            <div>
                                <span class="badge bg-light text-primary">{{ preusers|length }} registo{{ 's' if preusers|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Email</th>
                                        <th>C√≥digo</th>
                                        <th>Motivo</th>
                                        <th>Data</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for preuser in preusers %}
                                    <tr>
                                        <td class="text-muted">#{{ preuser.id }}</td>
                                        <td>{{ preuser._email }}</td>
                                        <td>{{ preuser.code }}</td>
                                        <td>{{ preuser.reason }}</td>
                                        <td>{{ preuser.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('user_management', user_id=preuser.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar o utilizador {{ preuser._email }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_preuser_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Se√ß√£o de Gest√£o de LoginLog -->
        {% if login_logs %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Login Logs
                            </h5>
                            <div>
                                <form action="{{ url_for('login_log_management') }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar TODOS os logs de login? Esta a√ß√£o n√£o pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_login_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Eliminar todos os logs">
                                        <i class="bi bi-trash"></i> Limpar Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-primary">{{ login_logs|length }} registo{{ 's' if login_logs|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>utilizador</th>
                                        <th>Email</th>
                                        <th>Remote addr</th>
                                        <th>Data</th>
                                        <th>Sucesso</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for login in login_logs %}
                                    <tr>
                                        <td class="text-muted">#{{ login.id }}</td>
                                        <td>{{ login.user.email }}</td>
                                        <td>{{ login.user.name }}</td>
                                        <td>{{ login.remote_addr }}</td>
                                        <td>{{ login.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>{{ '‚úì' if login.success else '‚ùå' }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('login_log_management', log_id=login.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar este log de login?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_login_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar log">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Se√ß√£o de Gest√£o de BannedIPs -->
        {% if banned_ips %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                IPs Banidos
                            </h5>
                            <div>
                                <form action="{{ url_for('banned_ip_management') }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja desbanir TODOS os IPs? Esta a√ß√£o n√£o pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_banned_ip_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Desbanir todos os IPs">
                                        <i class="bi bi-unlock"></i> Desbanir Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-danger">{{ banned_ips|length }} IP{{ 's' if banned_ips|length != 1 else '' }} banido{{ 's' if banned_ips|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Endere√ßo IP</th>
                                        <th>Data do Banimento</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for banned_ip in banned_ips %}
                                    <tr>
                                        <td class="text-muted">#{{ banned_ip.id }}</td>
                                        <td><code>{{ banned_ip.remote_addr }}</code></td>
                                        <td>{{ banned_ip.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('banned_ip_management', banned_ip_id=banned_ip.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja desbanir o IP {{ banned_ip.remote_addr }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_banned_ip_delete">
                                                    <button type="submit" class="btn btn-outline-success btn-sm" title="Desbanir IP">
                                                        <i class="bi bi-unlock"></i> Desbanir
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}











        <!-- Modais para Edi√ß√£o e Elimina√ß√£o de Utilizadores -->
        {% for user in users %}
        <!-- Modal de Edi√ß√£o -->
        <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_edit">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editName{{ user.id }}" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="editName{{ user.id }}" 
                                       name="name" value="{{ user.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail{{ user.id }}" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail{{ user.id }}" 
                                       name="email" value="{{ user.email }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRole{{ user.id }}" class="form-label">Permiss√£o</label>
                                <select class="form-select" id="editRole{{ user.id }}" name="role" required>
                                    <option value="none" {% if user.role == 'none' %}selected{% endif %}>Sem Permiss√µes</option>
                                    <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                    <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Altera√ß√µes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Elimina√ß√£o -->
        {% if user.id != current_user.id %}
        <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Eliminar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem a certeza que deseja eliminar o utilizador <strong>{{ user.name }}</strong>?</p>
                        <p class="text-muted small">Esta a√ß√£o n√£o pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form action="{{ url_for('user_management', user_id=user.id) }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="crud_user_delete">
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Modal de Reset de Senha -->
        <div class="modal fade" id="resetPasswordModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Alterar Senha do Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_reset_password">
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Aten√ß√£o:</strong> Vai alterar a senha do utilizador <strong>{{ user.name }}</strong>.
                            </div>
                            <div class="mb-3">
                                <label for="resetPassword{{ user.id }}" class="form-label">Nova Senha *</label>
                                <input type="password" class="form-control" id="resetPassword{{ user.id }}" 
                                       name="new_password" required minlength="6">
                                <div class="form-text">M√≠nimo 6 caracteres. Recomenda-se: mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador dever√° ser informado da nova senha por um canal seguro.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-key me-1"></i>
                                Alterar Senha
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- Modal para Adicionar Novo Utilizador -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar Novo Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_add_new">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="addUserName" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="addUserName" 
                                       name="name" required minlength="2" maxlength="100">
                                <div class="form-text">Nome que ser√° exibido na aplica√ß√£o.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="addUserEmail" 
                                       name="email" required>
                                <div class="form-text">Email ser√° usado para login e comunica√ß√µes.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserPassword" class="form-label">Palavra-passe *</label>
                                <input type="password" class="form-control" id="addUserPassword" 
                                       name="password" required minlength="6">
                                <div class="form-text">M√≠nimo 6 caracteres. Recomenda-se: mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserRole" class="form-label">Permiss√£o *</label>
                                <select class="form-select" id="addUserRole" name="role" required>
                                    <option value="">Selecione a permiss√£o...</option>
                                    <option value="none">Sem Permiss√µes - Acesso negado</option>
                                    <option value="viewer">Visualizador - Apenas consulta</option>
                                    <option value="editor">Editor - Pode editar dados</option>
                                    <option value="admin">Administrador - Acesso completo</option>
                                </select>
                                <div class="form-text">Define o n√≠vel de acesso do utilizador na aplica√ß√£o.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador receber√° um email de boas-vindas com as instru√ß√µes de acesso.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-person-plus me-1"></i>
                                Criar Utilizador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Info sobre formato CSV -->
         <div class="row justify-content-center mb-4">

         </div>
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Gest√£o de Alunos em Lote - Importa√ß√£o de dados no formato do ficheiro CSV:</strong> 
                    <br>Exemplo: 
                    <br><small class="text-muted">turma,numero,processo,nome,email</small>
                    <br><small class="text-muted">5A,1,12345,Jo√£o Silva,joao.silva@escola.pt</small>
                    <br><small class="text-muted">5A,2,67890,Maria Santos,maria.santos@escola.pt</small>
                    <br><small class="text-muted">5B,1,11223,Pedro Costa,pedro.costa@escola.pt</small>
                    <br><small class="text-warning">A coluna "email" √© opcional. Se n√£o existir, ser√° ignorada.</small>
                </div>
            </div>
        </div>

        {% if not has_data %}
        <!-- Mensagem de primeiro acesso -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Primeiro Acesso:</strong> Nenhuma turma foi encontrada. Carregue um ficheiro CSV para come√ßar.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cards das funcionalidades -->
        <div class="row g-4">
            <!-- Card 1: Substituir Dados -->
            {% if can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">üîÑ</div>
                        <h5 class="card-title fw-bold">Substituir Todos os Dados</h5>
                        <p class="card-text text-muted">
                            Carregar novo ficheiro CSV e <strong>eliminar todos os dados existentes</strong>. 
                            As fotos ser√£o mantidas.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="replaceForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="replace">
                            <div class="mb-3">
                                <input type="file" name="file" id="replaceFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100" id="replaceBtn" disabled>
                                <i class="bi bi-arrow-repeat me-2"></i>
                                Substituir Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 2: Atualizar/Adicionar Dados (s√≥ se houver dados) -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-primary mb-3">‚ûï</div>
                        <h5 class="card-title fw-bold">Atualizar/Adicionar Dados</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>merge</strong> com os dados existentes. 
                            Novos alunos ser√£o adicionados, existentes atualizados.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="mergeForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="merge">
                            <div class="mb-3">
                                <input type="file" name="file" id="mergeFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="mergeBtn" disabled>
                                <i class="bi bi-plus-circle me-2"></i>
                                Atualizar Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 3: Atualizar Professores -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">üë®‚Äçüè´</div>
                        <h5 class="card-title fw-bold">Atualizar Professores</h5>
                        <p class="card-text text-muted">
                            Atualizar apenas os <strong>nomes e emails dos professores</strong> respons√°veis pelas turmas. 
                            CSV deve ter colunas: turma, professor, email (opcional).
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="updateProfessorForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="update_professor">
                            <div class="mb-3">
                                <input type="file" name="file" id="updateProfessorFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-info w-100" id="updateProfessorBtn" disabled>
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Atualizar Professores
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 4: Fazer rescan aos ficheiros que j√° existam -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-warning mb-3">üîç</div>
                        <h5 class="card-title fw-bold">Fazer Rescan</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>rescan</strong> das fotos existentes em disco.
                        </p>
                        
                        <form action="{{ url_for('settings_rescan_photos') }}" method="post" id="rescanForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="rescan">
                            
                            <div class="mb-3 text-start">
                                <label class="form-label fw-semibold">Op√ß√µes de marca√ß√£o:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsTaken" value="taken" checked>
                                    <label class="form-check-label" for="markAsTaken">
                                        Marcar todas as fotos encontradas como <strong>tiradas</strong>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsNotTaken" value="not_taken">
                                    <label class="form-check-label" for="markAsNotTaken">
                                        Marcar todas as fotos encontradas como <strong>n√£o tiradas</strong>
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-warning w-100" id="rescanBtn">
                                <i class="bi bi-search me-2"></i>
                                Fazer Rescan
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 5: Backup Total da Base de Dados -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">üíæ</div>
                        <h5 class="card-title fw-bold">Backup Total</h5>
                        <p class="card-text text-muted">
                            Criar <strong>backup completo</strong> da base de dados em formato ZIP com ficheiros CSV.
                        </p>
                        
                        <form action="{{ url_for('settings_backup') }}" method="post" id="backupForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="backup">
                            
                            <div class="mb-3 text-start">
                                <small class="text-muted">
                                    O backup incluir√°:
                                    <ul class="list-unstyled mt-2">
                                        <li>üìÑ <strong>users.csv</strong> - Dados dos utilizadores</li>
                                        <li>üë• <strong>alunos.csv</strong> - Dados dos alunos</li>
                                        <li>üè´ <strong>turmas_professores.csv</strong> - Dados dos professores</li>
                                    </ul>
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-info w-100" id="backupBtn">
                                <i class="bi bi-download me-2"></i>
                                Criar Backup
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 6: Limpeza Completa (s√≥ se houver dados) -->
            {% if has_data and can_system_nuke %}
            <div class="col-lg-4">
                <div class="card h-100 border-danger border-2 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">üóëÔ∏è</div>
                        <h5 class="card-title fw-bold text-danger">Limpeza Completa</h5>
                        <p class="card-text text-muted">
                            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Elimina <strong>TODOS os dados e fotos</strong> 
                            de forma permanente. N√£o pode ser desfeita!
                        </p>
                        
                        <form action="{{ url_for('settings_nuke') }}" method="post" id="nukeForm" onsubmit="return confirmNuke()">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                LIMPAR TUDO
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}


            <!-- Painel Redis -->
             <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Redis</h3>
                    <div class="d-flex align-items-center gap-3">
                    <label class="form-check-label me-2" title="Atualizar automaticamente de 5 em 5 segundos">
                        <input id="redis-autorefresh" type="checkbox" class="form-check-input" checked>
                        Auto (5s)
                    </label>
                    <label class="form-check-label me-2" title="Mostrar todos os dados (INFO completo)">
                        <input id="redis-showall" type="checkbox" class="form-check-input">
                        Tudo
                    </label>
                    <button id="redis-refresh" type="button" class="btn btn-secondary btn-sm">Atualizar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="redis-error" class="text-danger mb-2" hidden></div>
                    <div id="redis-table-container"></div>
                </div>
            </div>
            </div>
            <!-- End Painel Redis -->

        </div>
        

        <!-- Modais de Edi√ß√£o -->
        {% for user in users %}
        <div class="modal fade" id="editModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_edit">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="name{{ user.id }}" class="form-label">Nome</label>
                                        <input type="text" class="form-control" name="name" id="name{{ user.id }}" value="{{ user.name }}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email{{ user.id }}" class="form-label">Email</label>
                                        <input type="email" class="form-control" name="email" id="email{{ user.id }}" value="{{ user.email }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="role{{ user.id }}" class="form-label">Papel</label>
                                <select class="form-select" name="role" id="role{{ user.id }}" required>
                                    <option value="none" {{ 'selected' if user.role == 'none' else '' }}>Sem Permiss√µes</option>
                                    <option value="viewer" {{ 'selected' if user.role == 'viewer' else '' }}>Visualizador</option>
                                    <option value="editor" {{ 'selected' if user.role == 'editor' else '' }}>Editor</option>
                                    <option value="admin" {{ 'selected' if user.role == 'admin' else '' }}>Administrador</option>
                                </select>
                                <div class="form-text">
                                    <small>
                                        <strong>Sem Permiss√µes:</strong> N√£o pode aceder a nenhuma funcionalidade<br>
                                        <strong>Visualizador:</strong> Pode ver turmas e fotos<br>
                                        <strong>Editor:</strong> Pode tirar fotos e gerir alunos<br>
                                        <strong>Administrador:</strong> Acesso total ao sistema
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Altera√ß√µes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </main>


    <!-- Mobile bottom buttons -->
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-6">
                    {% if has_data %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-success w-100 mobile-btn-inline">
                        <i class="bi bi-eye"></i>
                        <small>Ver Turmas</small>
                    </a>
                    {% else %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-arrow-left"></i>
                        <small>Voltar</small>
                    </a>
                    {% endif %}
                </div>
                <div class="col-6">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>





    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- status do REDIS -->
    <script>
(function () {
  const ENDPOINT = '/settings/redis.json';
  const container = document.getElementById('redis-table-container');
  const btn = document.getElementById('redis-refresh');
  const auto = document.getElementById('redis-autorefresh');
  const showAll = document.getElementById('redis-showall');
  const errorBox = document.getElementById('redis-error');

  let timer = null, loading = false;

  // Achata o JSON: {a:{b:1}, c:[2,3]} -> {"a.b":1, "c[0]":2, "c[1]":3}
  function flatten(obj, prefix = '', out = {}) {
    const isObj = v => v !== null && typeof v === 'object';
    if (!isObj(obj)) { out[prefix || '(root)'] = obj; return out; }
    if (Array.isArray(obj)) { obj.forEach((v, i) => flatten(v, `${prefix}[${i}]`, out)); return out; }
    for (const [k, v] of Object.entries(obj)) {
      const key = prefix ? `${prefix}.${k}` : k;
      isObj(v) ? flatten(v, key, out) : (out[key] = v);
    }
    return out;
  }

  function buildTable(kv) {
    const table = document.createElement('table');
    table.className = 'table table-sm table-striped';

    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th style="width:45%">Chave</th><th>Valor</th></tr>';
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const keys = Object.keys(kv).sort((a, b) => {
      const order = k => (k === 'status') ? 0 :
                        (k === 'sessions_count') ? 1 :
                        (k === 'latency_ms') ? 2 :
                        (k === 'generated_at') ? 3 :
                        (k.startsWith('info.')) ? 100 : 50;
      return order(a) - order(b) || a.localeCompare(b);
    });

    for (const k of keys) {
      const tr = document.createElement('tr');
      const tdK = document.createElement('td'); tdK.textContent = k;
      const tdV = document.createElement('td');
      const v = kv[k];
      tdV.textContent = (typeof v === 'object') ? JSON.stringify(v) : String(v);
      tr.append(tdK, tdV);
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
    return table;
  }

  function buildUrl() {
    const params = new URLSearchParams();
    if (showAll && showAll.checked) params.set('data', 'all');
    const qs = params.toString();
    return qs ? `${ENDPOINT}?${qs}` : ENDPOINT;
  }

  async function fetchAndRender() {
    if (loading) return;
    try {
      loading = true;
      btn && (btn.disabled = true);
      errorBox.hidden = true; errorBox.textContent = '';

      const r = await fetch(buildUrl(), { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();

      // Render: achatar TUDO o que vier
      const flat = flatten(data);
      const table = buildTable(flat);

      container.innerHTML = '';
      container.appendChild(table);
    } catch (e) {
      errorBox.hidden = false;
      errorBox.textContent = e.message || 'Erro ao obter estado do Redis.';
      container.innerHTML = '';
    } finally {
      loading = false;
      btn && (btn.disabled = false);
    }
  }

  function startAuto(){ stopAuto(); timer = setInterval(fetchAndRender, 5000); }
  function stopAuto(){ if (timer) { clearInterval(timer); timer = null; } }

  btn && btn.addEventListener('click', fetchAndRender);
  auto && auto.addEventListener('change', () => auto.checked ? startAuto() : stopAuto());
  showAll && showAll.addEventListener('change', fetchAndRender); // muda entre resumo/Tudo

  fetchAndRender();
  if (auto && auto.checked) startAuto();

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopAuto();
    else if (auto && auto.checked) startAuto();
  });
})();
</script>




    <script>
        // Valida√ß√£o do formul√°rio de adicionar utilizador
        document.addEventListener('DOMContentLoaded', function() {
            const addUserForm = document.querySelector('#addUserModal form');
            const passwordField = document.getElementById('addUserPassword');
            const confirmPasswordField = document.getElementById('addUserPasswordConfirm');

            if (addUserForm) {
                addUserForm.addEventListener('submit', function(e) {
                    const password = passwordField.value;
                    const confirmPassword = confirmPasswordField.value;

                    // Verificar se as palavras-passe coincidem
                    if (password !== confirmPassword) {
                        e.preventDefault();
                        alert('As palavras-passe n√£o coincidem. Por favor, verifique.');
                        confirmPasswordField.focus();
                        return false;
                    }

                    // Valida√ß√£o de for√ßa da palavra-passe
                    if (password.length < 6) {
                        e.preventDefault();
                        alert('A palavra-passe deve ter pelo menos 6 caracteres.');
                        passwordField.focus();
                        return false;
                    }

                    return true;
                });

                // Valida√ß√£o em tempo real da confirma√ß√£o da palavra-passe
                confirmPasswordField.addEventListener('input', function() {
                    const password = passwordField.value;
                    const confirmPassword = this.value;
                    
                    if (confirmPassword && password !== confirmPassword) {
                        this.setCustomValidity('As palavras-passe n√£o coincidem');
                        this.classList.add('is-invalid');
                    } else {
                        this.setCustomValidity('');
                        this.classList.remove('is-invalid');
                    }
                });
            }
        });

        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '{{ url_for("logout") }}';
            }
        }

        // Habilitar bot√µes quando arquivo for selecionado
        document.getElementById('replaceFile').addEventListener('change', function() {
            document.getElementById('replaceBtn').disabled = !this.files.length;
        });

        {% if can_upload_csv %}
        document.getElementById('replaceFile').addEventListener('change', function() {
            document.getElementById('replaceBtn').disabled = !this.files.length;
        });
        {% endif %}

        {% if has_data and can_upload_csv %}
        document.getElementById('mergeFile').addEventListener('change', function() {
            document.getElementById('mergeBtn').disabled = !this.files.length;
        });
        
        document.getElementById('updateProfessorFile').addEventListener('change', function() {
            document.getElementById('updateProfessorBtn').disabled = !this.files.length;
        });
        {% endif %}

        // Confirma√ß√£o para limpeza completa
        function confirmNuke() {
            return confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: LIMPEZA COMPLETA ‚ö†Ô∏è\n\n' +
                'Esta opera√ß√£o ir√° eliminar TODOS os dados e fotos!\n' +
                'ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\n' +
                'Tem certeza que pretende continuar?'
            );
        }
    </script>
</body>
</html>
