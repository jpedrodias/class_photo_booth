<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Configura√ß√µes - Class Photo Booth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2b2b2b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Class Photo Booth">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='student_icon.jpg') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3 fixed-top">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center"  
                onclick="location.href='{{ url_for('index') }}'"
                style="cursor: pointer;">
                <span class="display-6 me-2">‚öôÔ∏è</span>
                <div>
                    <div class="fw-bold">Configura√ß√µes</div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                {% if has_data %}
                <a href="{{ url_for('turmas') }}" class="btn btn-light btn-sm rounded-pill px-3" title="Ver Turmas">
                    <i class="bi bi-eye me-1"></i>
                    <span class="d-none d-md-inline">Turmas</span>
                </a>
                {% else %}
                <a href="{{ url_for('turmas') }}" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Voltar">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-md-inline">Voltar</span>
                </a>
                {% endif %}
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Espa√ßo para compensar navbar fixo -->
    <div class="navbar-spacer"></div>

    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conte√∫do principal -->
    <main class="container my-5">
        <!-- Gest√£o de Utilizadores -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2"></i>
                                Gest√£o de Utilizadores
                            </h5>
                            <div>
                                <a href="{{ url_for('departamentos_crud') }}" class="btn btn-outline-light btn-sm me-2" title="Gerir Departamentos">
                                    <i class="bi bi-building me-1"></i>
                                    Departamentos
                                </a>
                                <button type="button" class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus me-1"></i>
                                    Adicionar Utilizador
                                </button>
                                <span class="badge bg-light text-primary" id="userCountBadge">{{ users|length }} utilizador{{ 'es' if users|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="card-body border-bottom">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="searchUsers" class="form-label small">Procurar utilizadores</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchUsers" placeholder="Nome ou email...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label for="filterDepartment" class="form-label small">Departamento</label>
                                <select class="form-select" id="filterDepartment">
                                    <option value="">Todos os departamentos</option>
                                    {% for departamento in departamentos %}
                                    <option value="{{ departamento.name }}">{{ departamento.fullname }}</option>
                                    {% endfor %}
                                    <option value="_none">Sem departamento</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterRole" class="form-label small">Permiss√£o</label>
                                <select class="form-select" id="filterRole">
                                    <option value="">Todas as permiss√µes</option>
                                    <option value="admin">Administrador</option>
                                    <option value="editor">Editor</option>
                                    <option value="viewer">Visualizador</option>
                                    <option value="none">Sem Permiss√µes</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" id="clearFilters">
                                    <i class="bi bi-x-lg"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover mb-0" id="usersTable">
                                <thead class="table-light position-sticky top-0" style="z-index: 10;">
                                    <tr>
                                        <th width="50"></th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Permiss√£o</th>
                                        <th>Departamentos</th>
                                        <th>Estado</th>
                                        <th width="120">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    {% for user in users %}
                                    <tr class="user-row" 
                                        data-name="{{ user.name|lower }}" 
                                        data-email="{{ user.email|lower }}"
                                        data-role="{{ user.role or 'none' }}"
                                        data-departments="{% for dept in user.departamentos %}{{ dept.name }}{% if not loop.last %},{% endif %}{% endfor %}"
                                        data-has-departments="{{ 'true' if user.departamentos else 'false' }}">
                                        <td>
                                            <div class="avatar-circle" id="avatar-user-{{ user.id }}">
                                                {{ user.name[0].upper() }}
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ user.name }}</strong>
                                            {% if user.id == current_user.id %}
                                                <span class="badge bg-info ms-1">Voc√™</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            {% if user.role == 'admin' %}
                                                <span class="badge bg-danger">Administrador</span>
                                            {% elif user.role == 'editor' %}
                                                <span class="badge bg-warning">Editor</span>
                                            {% elif user.role == 'viewer' %}
                                                <span class="badge bg-success">Visualizador</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Sem Permiss√µes</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.departamentos %}
                                                {% for departamento in user.departamentos %}
                                                    <span class="badge bg-light text-dark me-1" title="{{ departamento.fullname }}">
                                                        {{ departamento.name }}
                                                    </span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">Nenhum</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_verified %}
                                                <span class="text-success">
                                                    <i class="bi bi-check-circle"></i> Verificado
                                                </span>
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="bi bi-clock"></i> Pendente
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editUserModal{{ user.id }}"
                                                        title="Editar utilizador">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal{{ user.id }}"
                                                        title="Alterar senha">
                                                    <i class="bi bi-key"></i>
                                                </button>
                                                {% if user.id != current_user.id %}
                                                <button type="button" class="btn btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteUserModal{{ user.id }}"
                                                        title="Eliminar utilizador">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagina√ß√£o -->
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small" id="paginationInfo">
                                        A mostrar <span id="showingFrom">1</span> a <span id="showingTo">10</span> de <span id="totalUsers">{{ users|length }}</span> utilizadores
                                    </span>
                                </div>
                                <nav aria-label="Pagina√ß√£o de utilizadores">
                                    <ul class="pagination pagination-sm mb-0" id="pagination">
                                        <!-- Bot√µes de pagina√ß√£o ser√£o inseridos via JavaScript -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        
                        {% if not users %}
                        <div class="text-center py-4 text-muted" id="noUsersMessage">
                            <i class="bi bi-people display-4"></i>
                            <p class="mt-2">Nenhum utilizador encontrado</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>




        <!-- Se√ß√£o de Gest√£o de Pr√© Utilizadores -->
        {% if preusers %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Pr√© Utilizadores do Sistema
                            </h5>
                            <div>
                                <span class="badge bg-light text-primary">{{ preusers|length }} registo{{ 's' if preusers|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Email</th>
                                        <th>C√≥digo</th>
                                        <th>Motivo</th>
                                        <th>Data</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for preuser in preusers %}
                                    <tr>
                                        <td class="text-muted">#{{ preuser.id }}</td>
                                        <td>{{ preuser._email }}</td>
                                        <td>{{ preuser.code }}</td>
                                        <td>{{ preuser.reason }}</td>
                                        <td>{{ preuser.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('user_management', user_id=preuser.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar o utilizador {{ preuser._email }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_preuser_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Se√ß√£o de Gest√£o de LoginLog -->
        {% if login_logs %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Login Logs
                            </h5>
                            <div>
                                <form action="{{ url_for('login_log_management') }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja eliminar TODOS os logs de login? Esta a√ß√£o n√£o pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_login_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Eliminar todos os logs">
                                        <i class="bi bi-trash"></i> Limpar Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-primary">{{ login_logs|length }} registo{{ 's' if login_logs|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>utilizador</th>
                                        <th>Email</th>
                                        <th>Remote addr</th>
                                        <th>Data (UTC)</th>
                                        <th>Sucesso</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for login in login_logs %}
                                    <tr>
                                        <td class="text-muted">#{{ login.id }}</td>
                                        <td>{{ login.user.email }}</td>
                                        <td>{{ login.user.name }}</td>
                                        <td>{{ login.remote_addr }}</td>
                                        <td>{{ login.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>{{ '‚úì' if login.success else '‚ùå' }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('login_log_management', log_id=login.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar este log de login?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_login_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar log">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Se√ß√£o de Gest√£o de BannedIPs -->
        {% if banned_ips %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                IPs Banidos
                            </h5>
                            <div>
                                <form action="{{ url_for('banned_ip_management') }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja desbanir TODOS os IPs? Esta a√ß√£o n√£o pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_banned_ip_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Desbanir todos os IPs">
                                        <i class="bi bi-unlock"></i> Desbanir Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-danger">{{ banned_ips|length }} IP{{ 's' if banned_ips|length != 1 else '' }} banido{{ 's' if banned_ips|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Endere√ßo IP</th>
                                        <th>Data do Banimento</th>
                                        <th class="text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for banned_ip in banned_ips %}
                                    <tr>
                                        <td class="text-muted">#{{ banned_ip.id }}</td>
                                        <td><code>{{ banned_ip.remote_addr }}</code></td>
                                        <td>{{ banned_ip.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('banned_ip_management', banned_ip_id=banned_ip.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja desbanir o IP {{ banned_ip.remote_addr }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_banned_ip_delete">
                                                    <button type="submit" class="btn btn-outline-success btn-sm" title="Desbanir IP">
                                                        <i class="bi bi-unlock"></i> Desbanir
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Modais para Edi√ß√£o e Elimina√ß√£o de Utilizadores -->
        {% for user in users %}
        <!-- Modal de Edi√ß√£o -->
        <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_edit">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editName{{ user.id }}" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="editName{{ user.id }}" 
                                       name="name" value="{{ user.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail{{ user.id }}" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail{{ user.id }}" 
                                       name="email" value="{{ user.email }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRole{{ user.id }}" class="form-label">Permiss√£o</label>
                                <select class="form-select" id="editRole{{ user.id }}" name="role" required>
                                    <option value="none" {% if user.role == 'none' %}selected{% endif %}>Sem Permiss√µes</option>
                                    <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                    <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrador</option>
                                </select>
                            </div>
                            
                            <!-- Se√ß√£o de Departamentos -->
                            <div class="mb-3">
                                <label class="form-label">Departamentos</label>
                                <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {% if departamentos %}
                                        {% for departamento in departamentos %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" 
                                                   id="dept{{ departamento.id }}_user{{ user.id }}" 
                                                   name="departamentos" 
                                                   value="{{ departamento.id }}"
                                                   {% if departamento in user.departamentos %}checked{% endif %}>
                                            <label class="form-check-label" for="dept{{ departamento.id }}_user{{ user.id }}">
                                                <strong>{{ departamento.name }}</strong>
                                                {% if departamento.fullname != departamento.name %}
                                                    <br><small class="text-muted">{{ departamento.fullname }}</small>
                                                {% endif %}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted text-center py-2">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Nenhum departamento dispon√≠vel
                                        </div>
                                    {% endif %}
                                </div>
                                <small class="form-text text-muted">
                                    Selecione os departamentos aos quais este utilizador deve pertencer.
                                </small>
                            </div>

                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="notifyUser{{ user.id }}" name="notify_user" value="true">
                                <label class="form-check-label" for="notifyUser{{ user.id }}">
                                    Notificar utilizador que a conta for alterada
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Altera√ß√µes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Elimina√ß√£o -->
        {% if user.id != current_user.id %}
        <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Eliminar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem a certeza que deseja eliminar o utilizador <strong>{{ user.name }}</strong>?</p>
                        <p class="text-muted small">Esta a√ß√£o n√£o pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form action="{{ url_for('user_management', user_id=user.id) }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="crud_user_delete">
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Modal de Reset de Senha -->
        <div class="modal fade" id="resetPasswordModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Alterar Senha do Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_reset_password">
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Aten√ß√£o:</strong> Vai alterar a senha do utilizador <strong>{{ user.name }}</strong>.
                            </div>
                            <div class="mb-3">
                                <label for="resetPassword{{ user.id }}" class="form-label">Nova Senha *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="resetPassword{{ user.id }}" 
                                           name="new_password" required minlength="6">
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="togglePasswordVisibility('resetPassword{{ user.id }}', this)"
                                            title="Mostrar/Ocultar senha">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">M√≠nimo 6 caracteres. Recomenda-se: mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador dever√° ser informado da nova senha por um canal seguro.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-key me-1"></i>
                                Alterar Senha
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- Modal para Adicionar Novo Utilizador -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar Novo Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_add_new">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="addUserName" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="addUserName" 
                                       name="name" required minlength="2" maxlength="100">
                                <div class="form-text">Nome que ser√° exibido na aplica√ß√£o.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="addUserEmail" 
                                       name="email" required>
                                <div class="form-text">Email ser√° usado para login e comunica√ß√µes.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserPassword" class="form-label">Palavra-passe *</label>
                                <input type="password" class="form-control" id="addUserPassword" 
                                       name="password" required minlength="6">
                                <div class="form-text">M√≠nimo 6 caracteres. Recomenda-se: mai√∫sculas, min√∫sculas, n√∫meros e s√≠mbolos.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserRole" class="form-label">Permiss√£o *</label>
                                <select class="form-select" id="addUserRole" name="role" required>
                                    <option value="">Selecione a permiss√£o...</option>
                                    <option value="none">Sem Permiss√µes - Acesso negado</option>
                                    <option value="viewer">Visualizador - Apenas consulta</option>
                                    <option value="editor">Editor - Pode editar dados</option>
                                    <option value="admin">Administrador - Acesso completo</option>
                                </select>
                                <div class="form-text">Define o n√≠vel de acesso do utilizador na aplica√ß√£o.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador receber√° um email de boas-vindas com as instru√ß√µes de acesso.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-person-plus me-1"></i>
                                Criar Utilizador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Info sobre formato CSV -->
         <div class="row justify-content-center mb-4">

         </div>
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Gest√£o de Alunos em Lote - Importa√ß√£o de dados no formato do ficheiro CSV:</strong> 
                    <br>Exemplo: 
                    <br><small class="text-muted">turma,numero,processo,nome,email</small>
                    <br><small class="text-muted">5A,1,12345,Jo√£o Silva,joao.silva@escola.pt</small>
                    <br><small class="text-muted">5A,2,67890,Maria Santos,maria.santos@escola.pt</small>
                    <br><small class="text-muted">5B,1,11223,Pedro Costa,pedro.costa@escola.pt</small>
                    <br><small class="text-warning">A coluna "email" √© opcional. Se n√£o existir, ser√° ignorada.</small>
                </div>
            </div>
        </div>

        {% if not has_data %}
        <!-- Mensagem de primeiro acesso -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Primeiro Acesso:</strong> Nenhuma turma foi encontrada. Carregue um ficheiro CSV para come√ßar.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cards das funcionalidades -->
        <div class="row g-4">
            <!-- Card 1: Substituir Dados -->
            {% if can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">üîÑ</div>
                        <h5 class="card-title fw-bold">Substituir Todos os Dados</h5>
                        <p class="card-text text-muted">
                            Carregar novo ficheiro CSV e <strong>eliminar todos os dados existentes</strong>. 
                            As fotos ser√£o mantidas.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="replaceForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="replace">
                            <div class="mb-3">
                                <input type="file" name="file" id="replaceFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100" id="replaceBtn" disabled>
                                <i class="bi bi-arrow-repeat me-2"></i>
                                Substituir Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 2: Atualizar/Adicionar Dados (s√≥ se houver dados) -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-primary mb-3">‚ûï</div>
                        <h5 class="card-title fw-bold">Atualizar/Adicionar Dados</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>merge</strong> com os dados existentes. 
                            Novos alunos ser√£o adicionados, existentes atualizados.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="mergeForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="merge">
                            <div class="mb-3">
                                <input type="file" name="file" id="mergeFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="mergeBtn" disabled>
                                <i class="bi bi-plus-circle me-2"></i>
                                Atualizar Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 3: Atualizar Professores -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">üë®‚Äçüè´</div>
                        <h5 class="card-title fw-bold">Atualizar Professores</h5>
                        <p class="card-text text-muted">
                            Atualizar apenas os <strong>nomes e emails dos professores</strong> respons√°veis pelas turmas. 
                            CSV deve ter colunas: turma, professor, email (opcional).
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="updateProfessorForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="update_professor">
                            <div class="mb-3">
                                <input type="file" name="file" id="updateProfessorFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-info w-100" id="updateProfessorBtn" disabled>
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Atualizar Professores
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 4: Bulk Upload de Fotos -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow bulk-upload-card"
                     ondragover="handleBulkUploadDragOver(event)"
                     ondragleave="handleBulkUploadDragLeave(event)"
                     ondrop="handleBulkUploadDrop(event)">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-success mb-3">üì¶</div>
                        <h5 class="card-title fw-bold">Bulk Upload</h5>
                        <p class="card-text text-muted">
                            Enviar <strong>v√°rias fotos</strong> ou <strong>ficheiros ZIP</strong> em lote.
                            Os nomes dos ficheiros ser√£o usados como n√∫meros de processo.
                        </p>

                        <div id="bulk-upload-status" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Processando...</span>
                                    </div>
                                    <span id="bulk-upload-progress-text">Processando arquivos...</span>
                                </div>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div id="bulk-upload-progress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div id="bulk-upload-drop-zone" class="mb-3 p-4 border-2 border-dashed border-secondary rounded bg-light">
                            <div class="text-center">
                                <i class="bi bi-cloud-upload display-4 text-secondary mb-3"></i>
                                <p class="mb-2 fw-semibold">Arraste e solte os arquivos aqui</p>
                                <p class="text-muted small mb-0">ou clique para selecionar</p>
                                <div id="bulk-upload-file-list" class="mt-3 text-start small"></div>
                            </div>
                        </div>

                        <form action="/settings/bulk_upload/" method="post" enctype="multipart/form-data" id="bulkUploadForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="mb-3">
                                <input type="file" name="files" id="bulkUploadFiles" accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.zip" multiple class="form-control d-none" required>
                                <div class="form-text">
                                    <small class="text-muted">Selecione v√°rios ficheiros de imagem ou ZIP</small>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success w-100" id="bulkUploadBtn" disabled>
                                <i class="bi bi-upload me-2"></i>
                                Enviar Arquivos
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 5: Fazer rescan aos ficheiros que j√° existam -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-warning mb-3">üîç</div>
                        <h5 class="card-title fw-bold">Fazer Rescan</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>rescan</strong> das fotos existentes em disco.
                        </p>
                        
                        <form action="{{ url_for('settings_rescan_photos') }}" method="post" id="rescanForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="rescan">
                            
                            <div class="mb-3 text-start">
                                <label class="form-label fw-semibold">Op√ß√µes de marca√ß√£o:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsTaken" value="taken" checked>
                                    <label class="form-check-label" for="markAsTaken">
                                        Marcar todas as fotos encontradas como <strong>tiradas</strong>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsNotTaken" value="not_taken">
                                    <label class="form-check-label" for="markAsNotTaken">
                                        Marcar todas as fotos encontradas como <strong>n√£o tiradas</strong>
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-warning w-100" id="rescanBtn">
                                <i class="bi bi-search me-2"></i>
                                Fazer Rescan
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 5: Backup Total da Base de Dados -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">üíæ</div>
                        <h5 class="card-title fw-bold">Backup Total</h5>
                        <p class="card-text text-muted">
                            Criar <strong>backup completo</strong> da base de dados em formato ZIP com ficheiros CSV.
                        </p>
                        
                        <form action="{{ url_for('settings_backup') }}" method="post" id="backupForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="backup">
                            
                            <div class="mb-3 text-start">
                                <small class="text-muted">
                                    O backup incluir√°:
                                    <ul class="list-unstyled mt-2">
                                        <li>üìÑ <strong>users.csv</strong> - Dados dos utilizadores</li>
                                        <li>üë• <strong>alunos.csv</strong> - Dados dos alunos</li>
                                        <li>üè´ <strong>turmas_professores.csv</strong> - Dados dos professores</li>
                                    </ul>
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-info w-100" id="backupBtn">
                                <i class="bi bi-download me-2"></i>
                                Criar Backup
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 6: Limpeza Completa (s√≥ se houver dados) -->
            {% if has_data and can_system_nuke %}
            <div class="col-lg-4">
                <div class="card h-100 border-danger border-2 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">üóëÔ∏è</div>
                        <h5 class="card-title fw-bold text-danger">Limpeza Completa</h5>
                        <p class="card-text text-muted">
                            <strong>‚ö†Ô∏è ATEN√á√ÉO:</strong> Elimina <strong>TODOS os dados e fotos</strong> 
                            de forma permanente. N√£o pode ser desfeita!
                        </p>
                        
                        <form action="{{ url_for('settings_nuke') }}" method="post" id="nukeForm" onsubmit="return confirmNuke()">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                LIMPAR TUDO
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}


            <!-- Painel Redis Server -->
            <div class="col-lg-6">
            <div class="card border-0 shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Redis Server</h3>
                    <div class="d-flex align-items-center gap-3">
                    <label class="form-check-label me-2" title="Atualizar automaticamente de 5 em 5 segundos">
                        <input id="redis-server-autorefresh" type="checkbox" class="form-check-input" checked>
                        Auto (5s)
                    </label>
                    <label class="form-check-label me-2" title="Mostrar todos os dados (INFO completo)">
                        <input id="redis-server-showall" type="checkbox" class="form-check-input">
                        Tudo
                    </label>
                    <button id="redis-server-refresh" type="button" class="btn btn-secondary btn-sm">Atualizar</button>
                    <button id="redis-server-clean" type="button" class="btn btn-warning btn-sm me-2" title="Limpar registros obsoletos">Limpar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="redis-server-error" class="text-danger mb-2" hidden></div>
                    <div id="redis-server-table-container" class="redis-table-container"></div>
                </div>
            </div>
            </div>
            <!-- End Painel Redis Server -->

            <!-- Painel Redis Sessions -->
            <div class="col-lg-6">
            <div class="card border-0 shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Redis Sessions</h3>
                    <div class="d-flex align-items-center gap-3">
                    <label class="form-check-label me-2" title="Atualizar automaticamente de 5 em 5 segundos">
                        <input id="redis-sessions-autorefresh" type="checkbox" class="form-check-input" checked>
                        Auto (5s)
                    </label>
                    <label class="form-check-label me-2" title="Mostrar todas as sess√µes">
                        <input id="redis-sessions-showall" type="checkbox" class="form-check-input">
                        Todas
                    </label>
                    <button id="redis-sessions-refresh" type="button" class="btn btn-secondary btn-sm">Atualizar</button>
                    <button id="redis-sessions-clean" type="button" class="btn btn-warning btn-sm" title="Limpar sess√µes expiradas">Limpar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="redis-sessions-error" class="text-danger mb-2" hidden></div>
                    <div id="redis-sessions-table-container" class="redis-table-container"></div>
                </div>
            </div>
            </div>
            <!-- End Painel Redis Sessions -->

        </div>
        

    </main>

    
    <!-- Mobile bottom buttons -->
    <!--
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-6">
                    {% if has_data %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-success w-100 mobile-btn-inline">
                        <i class="bi bi-eye"></i>
                        <small>Ver Turmas</small>
                    </a>
                    {% else %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-arrow-left"></i>
                        <small>Voltar</small>
                    </a>
                    {% endif %}
                </div>
                <div class="col-6">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
    -->




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- status do REDIS -->
    <script>
        function initializeRedisPanels() {
        // Configura√ß√£o para cada painel Redis
        const redisConfigs = [
            {
                id: 'redis-server',
                endpoint: '/settings/redis/server.json',
                title: 'Redis Server'
            },
            {
                id: 'redis-sessions', 
                endpoint: '/settings/redis/sessions.json',
                title: 'Redis Sessions'
            }
        ];

        // Achata o JSON: {a:{b:1}, c:[2,3]} -> {"a.b":1, "c[0]":2, "c[1]":3}
        function flatten(obj, prefix = '', out = {}) {
            const isObj = v => v !== null && typeof v === 'object';
            if (!isObj(obj)) { out[prefix || '(root)'] = obj; return out; }
            if (Array.isArray(obj)) { obj.forEach((v, i) => flatten(v, `${prefix}[${i}]`, out)); return out; }
            for (const [k, v] of Object.entries(obj)) {
            const key = prefix ? `${prefix}.${k}` : k;
            isObj(v) ? flatten(v, key, out) : (out[key] = v);
            }
            return out;
        }

        // Fun√ß√£o para formatar datas com cores personalizadas
        function formatDateValue(tdElement, value, color = '#000000') {
            if (typeof value === 'string' && value !== 'Never' && value !== '1900-01-01' && value !== 'null' && value) {
                try {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        tdElement.textContent = date.toLocaleString('pt-PT');
                        tdElement.style.fontWeight = 'bold';
                        tdElement.style.color = color;
                        return true; // Indica que a formata√ß√£o foi aplicada
                    }
                } catch {
                    // Se falhar, deixa o valor original
                }
            }
            tdElement.textContent = value;
            return false; // Indica que a formata√ß√£o n√£o foi aplicada
        }

        function buildTable(kv) {
            const table = document.createElement('table');
            table.className = 'table table-sm table-striped';

            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th class="w-45">Chave</th><th>Valor</th></tr>';
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            
            // Fun√ß√£o auxiliar para ordenar campos dentro de cada utilizador
            function getFieldOrder(key) {
                if (key.includes('last_seen')) return 1;
                if (key.includes('expires_at')) return 2;
                if (key.includes('email')) return 3;
                if (key.includes('name')) return 4;
                if (key.includes('sessions_count')) return 5;
                if (key.includes('user_id')) return 6;
                return 9;
            }
            
            const keys = Object.keys(kv).sort((a, b) => {
            const order = k => (k === 'status') ? 0 :
                                (k === 'sessions_count' || k === 'sessions_total') ? 1 :
                                (k === 'authenticated_users_total') ? 2 :
                                (k === 'latency_ms') ? 3 :
                                (k === 'generated_at') ? 4 :
                                (k === 'showing_all' || k === 'limit_applied') ? 5 :
                                (k.startsWith('User ')) ? 10 + parseInt(k.split(' ')[1]) * 10 + getFieldOrder(k) : // Agrupar utilizadores
                                (k.includes('last_seen')) ? 6 :
                                (k.includes('sliding_expiry')) ? 7 :
                                (k.includes('expires_at')) ? 8 :
                                (k.startsWith('active_users')) ? 10 :
                                (k.startsWith('sessions_detail')) ? 20 :
                                (k.startsWith('info.')) ? 100 : 50;
            return order(a) - order(b) || a.localeCompare(b);
            });
            
            // Fun√ß√£o auxiliar para ordenar campos dentro de cada utilizador
            function getFieldOrder(key) {
                if (key.includes('last_seen')) return 1;
                if (key.includes('email')) return 2;
                if (key.includes('name')) return 3;
                if (key.includes('sessions_count')) return 4;
                if (key.includes('user_id')) return 5;
                return 9;
            }

            for (const k of keys) {
            const tr = document.createElement('tr');
            const tdK = document.createElement('td'); tdK.textContent = k;
            const tdV = document.createElement('td');
            const v = kv[k];
            
            // Formata√ß√£o especial para campos de utilizadores
            if (k.startsWith('User ')) {
                if (k.includes('last_seen')) {
                    formatDateValue(tdV, v, '#28a745'); // Verde para last_seen
                } else if (k.includes('expires_at')) {
                    formatDateValue(tdV, v, '#dc3545'); // Vermelho para expires_at
                } else if (k.includes('email')) {
                    tdV.textContent = v;
                    tdV.style.fontWeight = 'bold';
                    tdV.style.color = '#007bff';
                } else if (k.includes('name')) {
                    tdV.textContent = v;
                    tdV.style.fontWeight = 'bold';
                } else {
                    tdV.textContent = v;
                }
                // Adicionar background diferente para campos de utilizador
                tr.style.backgroundColor = '#f8f9fa';
            }
            // Formata√ß√£o especial para campos de data/hora (n√£o utilizadores)
            else if (k.includes('last_seen')) {
                formatDateValue(tdV, v, '#28a745'); // Verde para last_seen
            } else if (k.includes('expires_at')) {
                formatDateValue(tdV, v, '#dc3545'); // Vermelho para expires_at
            } else if (k.includes('generated_at')) {
                formatDateValue(tdV, v, '#000000'); // Preto para generated_at
            } else if (k.includes('sliding_expiry') && typeof v === 'boolean') {
                tdV.textContent = v ? '‚úÖ Sim (renova automaticamente)' : '‚ùå N√£o (TTL fixo)';
                tdV.style.fontWeight = 'bold';
            } else {
                tdV.textContent = (typeof v === 'object') ? JSON.stringify(v) : String(v);
            }
            
            tr.append(tdK, tdV);
            tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            return table;
        }

        // Fun√ß√£o para atualizar as cores dos avatares baseado no status de atividade
        function updateAvatarStatus(data) {
            // Primeiro, resetar todos os avatares para o estado padr√£o (remover classes de status)
            document.querySelectorAll('.avatar-circle').forEach(avatar => {
                avatar.classList.remove('status-online', 'status-away', 'status-offline');
                avatar.title = 'Sem dados de sess√£o recente';
            });

            // Obter tempo atual
            const now = new Date();

            // Processar utilizadores das sess√µes Redis
            for (const [key, value] of Object.entries(data)) {
                if (key.startsWith('User ') && key.includes('user_id')) {
                    const userId = value;
                    const userIndex = key.split(' ')[1];
                    
                    // Buscar o last_seen correspondente
                    const lastSeenKey = `User ${userIndex} last_seen`;
                    const lastSeenValue = data[lastSeenKey];
                    
                    if (lastSeenValue && lastSeenValue !== 'Never' && lastSeenValue !== '1900-01-01') {
                        try {
                            const lastSeen = new Date(lastSeenValue);
                            const diffMinutes = (now - lastSeen) / (1000 * 60);
                            
                            const avatar = document.getElementById(`avatar-user-${userId}`);
                            if (avatar) {
                                if (diffMinutes <= 5) {
                                    avatar.classList.add('status-online');
                                    avatar.title = `üü¢ Online - √öltimo acesso h√° ${Math.round(diffMinutes)} minuto(s)`;
                                } else if (diffMinutes <= 60) {
                                    avatar.classList.add('status-away');
                                    avatar.title = `üü° Ausente - √öltimo acesso h√° ${Math.round(diffMinutes)} minuto(s)`;
                                } else {
                                    avatar.classList.add('status-offline');
                                    const diffHours = Math.round(diffMinutes / 60);
                                    avatar.title = `‚ö´ Offline - √öltimo acesso h√° ${diffHours} hora(s)`;
                                }
                            }
                        } catch (e) {
                            // Se falhar a parsing da data, deixar sem status
                        }
                    }
                }
            }
        }

        // Classe para gerenciar cada painel Redis
        class RedisPanel {
            constructor(config) {
            this.config = config;
            this.container = document.getElementById(`${config.id}-table-container`);
            this.btn = document.getElementById(`${config.id}-refresh`);
            this.cleanBtn = document.getElementById(`${config.id}-clean`);
            this.auto = document.getElementById(`${config.id}-autorefresh`);
            this.showAll = document.getElementById(`${config.id}-showall`);
            this.errorBox = document.getElementById(`${config.id}-error`);
            
            this.timer = null;
            this.loading = false;
            
            this.init();
            }

            buildUrl() {
            const params = new URLSearchParams();
            if (this.showAll && this.showAll.checked) params.set('data', 'all');
            const qs = params.toString();
            return qs ? `${this.config.endpoint}?${qs}` : this.config.endpoint;
            }

            async cleanObsolete() {
            if (this.loading) return;
            try {
                this.loading = true;
                this.cleanBtn && (this.cleanBtn.disabled = true);
                this.errorBox.hidden = true; 
                this.errorBox.textContent = '';

                const endpoint = this.config.id === 'redis-server' 
                    ? '/settings/redis/server/clean_all' 
                    : '/settings/redis/sessions/clean_all';

                const r = await fetch(endpoint, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    cache: 'no-store' 
                });
                
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();

                if (data.success) {
                    // Mostrar mensagem de sucesso
                    this.errorBox.hidden = false;
                    this.errorBox.className = 'text-success mb-2';
                    this.errorBox.textContent = data.message;
                    
                    // Atualizar os dados ap√≥s limpeza
                    setTimeout(() => this.fetchAndRender(), 1000);
                } else {
                    throw new Error(data.error || 'Erro na limpeza');
                }
            } catch (e) {
                this.errorBox.hidden = false;
                this.errorBox.className = 'text-danger mb-2';
                this.errorBox.textContent = e.message || `Erro ao limpar ${this.config.title}.`;
            } finally {
                this.loading = false;
                this.cleanBtn && (this.cleanBtn.disabled = false);
            }
            }

            async fetchAndRender() {
            if (this.loading) return;
            try {
                this.loading = true;
                this.btn && (this.btn.disabled = true);
                this.errorBox.hidden = true; 
                this.errorBox.textContent = '';

                const r = await fetch(this.buildUrl(), { cache: 'no-store' });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();

                // Render: achatar TUDO o que vier
                const flat = flatten(data);
                const table = buildTable(flat);

                this.container.innerHTML = '';
                this.container.appendChild(table);
                
                // Atualizar status dos avatares apenas para painel de sess√µes
                if (this.config.id === 'redis-sessions') {
                    updateAvatarStatus(flat);
                }
            } catch (e) {
                this.errorBox.hidden = false;
                this.errorBox.textContent = e.message || `Erro ao obter estado do ${this.config.title}.`;
                this.container.innerHTML = '';
            } finally {
                this.loading = false;
                this.btn && (this.btn.disabled = false);
            }
            }

            startAuto() { 
            this.stopAuto(); 
            this.timer = setInterval(() => this.fetchAndRender(), 5000); 
            }
            
            stopAuto() { 
            if (this.timer) { 
                clearInterval(this.timer); 
                this.timer = null; 
            } 
            }

            init() {
            // Event listeners
            this.btn && this.btn.addEventListener('click', () => this.fetchAndRender());
            this.cleanBtn && this.cleanBtn.addEventListener('click', () => {
                if (confirm(`Tem certeza que deseja limpar todos os registros obsoletos do ${this.config.title}?`)) {
                    this.cleanObsolete();
                }
            });
            this.auto && this.auto.addEventListener('change', () => 
                this.auto.checked ? this.startAuto() : this.stopAuto()
            );
            this.showAll && this.showAll.addEventListener('change', () => this.fetchAndRender());

            // Initial load
            this.fetchAndRender();
            if (this.auto && this.auto.checked) this.startAuto();

            // Handle visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) this.stopAuto();
                else if (this.auto && this.auto.checked) this.startAuto();
            });
            }
        }

        // Inicializar todos os pain√©is Redis
        redisConfigs.forEach(config => new RedisPanel(config));
        }

        // Executar quando a p√°gina carregar
        initializeRedisPanels();
    </script>

    <script>
        // Fun√ß√£o para mostrar/ocultar senha
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
                button.title = 'Ocultar senha';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
                button.title = 'Mostrar senha';
            }
        }
</script>




    <script>
        // Valida√ß√£o do formul√°rio de adicionar utilizador
        document.addEventListener('DOMContentLoaded', function() {
            const addUserForm = document.querySelector('#addUserModal form');
            const passwordField = document.getElementById('addUserPassword');

            if (addUserForm && passwordField) {
                addUserForm.addEventListener('submit', function(e) {
                    const password = passwordField.value;

                    // Valida√ß√£o de for√ßa da palavra-passe
                    if (password.length < 6) {
                        e.preventDefault();
                        alert('A palavra-passe deve ter pelo menos 6 caracteres.');
                        passwordField.focus();
                        return false;
                    }

                    return true;
                });
            }
        });

        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '{{ url_for("logout") }}';
            }
        }

        // Habilitar bot√µes quando arquivo for selecionado
        const replaceFile = document.getElementById('replaceFile');
        if (replaceFile) {
            replaceFile.addEventListener('change', function() {
                const replaceBtn = document.getElementById('replaceBtn');
                if (replaceBtn) {
                    replaceBtn.disabled = !this.files.length;
                }
            });
        }

        const mergeFile = document.getElementById('mergeFile');
        if (mergeFile) {
            mergeFile.addEventListener('change', function() {
                const mergeBtn = document.getElementById('mergeBtn');
                if (mergeBtn) {
                    mergeBtn.disabled = !this.files.length;
                }
            });
        }
        
        const updateProfessorFile = document.getElementById('updateProfessorFile');
        if (updateProfessorFile) {
            updateProfessorFile.addEventListener('change', function() {
                const updateProfessorBtn = document.getElementById('updateProfessorBtn');
                if (updateProfessorBtn) {
                    updateProfessorBtn.disabled = !this.files.length;
                }
            });
        }

        // Bulk Upload functionality
        const bulkUploadFiles = document.getElementById('bulkUploadFiles');
        if (bulkUploadFiles) {
            bulkUploadFiles.addEventListener('change', function() {
                const bulkUploadBtn = document.getElementById('bulkUploadBtn');
                if (bulkUploadBtn) {
                    bulkUploadBtn.disabled = !this.files.length;
                }
            });
        }

        // Check for bulk upload job status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkBulkUploadStatus();
        });

        // Function to check bulk upload job status
        function checkBulkUploadStatus() {
            fetch('{{ url_for("settings_bulk_upload_status") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.has_job) {
                        showBulkUploadStatus(data);
                        // Check again in 5 seconds
                        setTimeout(checkBulkUploadStatus, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking bulk upload status:', error);
                });
        }

        // Function to show bulk upload status
        function showBulkUploadStatus(data) {
            const statusDiv = document.getElementById('bulkUploadStatus');
            const messageSpan = document.getElementById('bulkUploadMessage');
            const form = document.getElementById('bulkUploadForm');
            const btn = document.getElementById('bulkUploadBtn');

            if (statusDiv && messageSpan) {
                statusDiv.style.display = 'block';

                if (data.status === 'completed') {
                    statusDiv.className = 'mb-3';
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    // Re-enable form after completion
                    if (form && btn) {
                        form.style.display = 'block';
                        btn.disabled = false;
                    }
                } else if (data.status === 'failed') {
                    statusDiv.className = 'mb-3';
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    // Re-enable form after failure
                    if (form && btn) {
                        form.style.display = 'block';
                        btn.disabled = false;
                    }
                } else {
                    // In progress
                    statusDiv.className = 'mb-3';
                    statusDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split me-2"></i>
                            ${data.message}
                        </div>
                    `;
                    // Hide form while processing
                    if (form) {
                        form.style.display = 'none';
                    }
                }
            }
        }

        // Confirma√ß√£o para limpeza completa
        function confirmNuke() {
            return confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: LIMPEZA COMPLETA ‚ö†Ô∏è\n\n' +
                'Esta opera√ß√£o ir√° eliminar TODOS os dados e fotos!\n' +
                'ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\n' +
                'Tem certeza que pretende continuar?'
            );
        }

        // === JAVASCRIPT PARA BULK UPLOAD ===
        let bulkUploadStatusInterval;

        function startBulkUploadStatusCheck() {
            // Verificar status a cada 2 segundos
            bulkUploadStatusInterval = setInterval(checkBulkUploadStatus, 2000);
        }

        function stopBulkUploadStatusCheck() {
            if (bulkUploadStatusInterval) {
                clearInterval(bulkUploadStatusInterval);
                bulkUploadStatusInterval = null;
            }
        }

        function checkBulkUploadStatus() {
            fetch('/settings/bulk_upload/status_job')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('bulk-upload-status');
                    const progressBar = document.getElementById('bulk-upload-progress');
                    const progressText = document.getElementById('bulk-upload-progress-text');

                    if (!data.has_job) {
                        // N√£o h√° tarefa ativa
                        statusDiv.style.display = 'none';
                        stopBulkUploadStatusCheck();

                        // Reabilitar bot√£o
                        const submitBtn = document.getElementById('bulkUploadBtn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Enviar Arquivos';
                        }
                        return;
                    }

                    statusDiv.style.display = 'block';

                    if (data.status === 'processing') {
                        statusDiv.className = 'alert alert-info';
                        progressBar.style.width = data.progress + '%';
                        progressText.textContent = data.message || 'Processando...';
                    } else if (data.status === 'completed') {
                        statusDiv.className = 'alert alert-success';
                        progressBar.style.width = '100%';
                        progressText.textContent = data.message || 'Conclu√≠do com sucesso!';
                        stopBulkUploadStatusCheck();

                        // Reabilitar bot√£o
                        const submitBtn = document.getElementById('bulkUploadBtn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Enviar Arquivos';
                        }

                        // Mostrar detalhes se houver erros
                        if (data.errors && data.errors.length > 0) {
                            let errorHtml = '<br><strong>Erros encontrados:</strong><ul class="mb-0 mt-2">';
                            data.errors.forEach(error => {
                                errorHtml += `<li>${error}</li>`;
                            });
                            errorHtml += '</ul>';
                            progressText.innerHTML += errorHtml;
                        }

                        // Recarregar p√°gina ap√≥s alguns segundos para mostrar resultados
                        setTimeout(() => {
                            window.location.reload();
                        }, 3000);
                    } else if (data.status === 'failed') {
                        statusDiv.className = 'alert alert-danger';
                        progressBar.style.width = '100%';
                        progressText.textContent = data.message || 'Erro na tarefa';
                        stopBulkUploadStatusCheck();

                        // Reabilitar bot√£o
                        const submitBtn = document.getElementById('bulkUploadBtn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Enviar Arquivos';
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar status:', error);
                    stopBulkUploadStatusCheck();

                    // Reabilitar bot√£o em caso de erro
                    const submitBtn = document.getElementById('bulkUploadBtn');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar Arquivos';
                    }
                });
        }

        function validateBulkUploadForm() {
            const filesInput = document.getElementById('bulkUploadFiles');
            const files = filesInput.files;

            if (!files || files.length === 0) {
                alert('Por favor, selecione pelo menos um arquivo.');
                return false;
            }

            // Verificar tipos de arquivo
            const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.zip'];
            let hasValidFile = false;
            let hasInvalidFile = false;

            for (let file of files) {
                const fileName = file.name.toLowerCase();
                const isValid = allowedExtensions.some(ext => fileName.endsWith(ext));

                if (isValid) {
                    hasValidFile = true;
                } else {
                    hasInvalidFile = true;
                }
            }

            if (!hasValidFile) {
                alert('Por favor, selecione apenas arquivos de imagem (JPG, PNG, GIF, BMP, WEBP) ou arquivos ZIP.');
                return false;
            }

            if (hasInvalidFile) {
                alert('Alguns arquivos selecionados n√£o s√£o suportados. Apenas imagens e arquivos ZIP s√£o permitidos.');
                return false;
            }

            // Verificar tamanho total (limite de 100MB)
            const maxSize = 100 * 1024 * 1024; // 100MB
            let totalSize = 0;
            for (let file of files) {
                totalSize += file.size;
            }

            if (totalSize > maxSize) {
                alert('O tamanho total dos arquivos excede o limite de 100MB.');
                return false;
            }

            return true;
        }

        function submitBulkUploadForm() {
            if (!validateBulkUploadForm()) {
                return;
            }

            const form = document.getElementById('bulkUploadForm');
            const formData = new FormData(form);

            // Mostrar status
            const statusDiv = document.getElementById('bulk-upload-status');
            const progressBar = document.getElementById('bulk-upload-progress');
            const progressText = document.getElementById('bulk-upload-progress-text');

            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info';
            progressBar.style.width = '0%';
            progressText.textContent = 'Enviando arquivos...';

            // Desabilitar bot√£o
            const submitBtn = document.getElementById('bulkUploadBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            fetch('/settings/bulk_upload/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Iniciar verifica√ß√£o de status
                    startBulkUploadStatusCheck();
                    progressText.textContent = 'Arquivos enviados. Aguardando processamento...';
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Erro no envio');
                    });
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                statusDiv.className = 'alert alert-danger';
                progressText.textContent = 'Erro: ' + error.message;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Arquivos';
                stopBulkUploadStatusCheck();
            });
        }

        // === DRAG AND DROP FUNCTIONS FOR BULK UPLOAD ===
        function handleBulkUploadDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
            const dropZone = document.getElementById('bulk-upload-drop-zone');
            if (dropZone) {
                dropZone.classList.add('dragover');
            }
        }

        function handleBulkUploadDragLeave(event) {
            event.preventDefault();
            // S√≥ remover se estiver saindo do elemento principal (n√£o de um filho)
            if (!event.currentTarget.contains(event.relatedTarget)) {
                event.currentTarget.classList.remove('dragover');
                const dropZone = document.getElementById('bulk-upload-drop-zone');
                if (dropZone) {
                    dropZone.classList.remove('dragover');
                }
            }
        }

        function handleBulkUploadDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const dropZone = document.getElementById('bulk-upload-drop-zone');
            if (dropZone) {
                dropZone.classList.remove('dragover');
            }

            const files = event.dataTransfer.files;
            if (!files || files.length === 0) return;

            // Validar tipos de arquivo
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp', 'application/zip'];
            const validFiles = [];
            const invalidFiles = [];

            for (let file of files) {
                if (allowedTypes.includes(file.type) || file.name.toLowerCase().endsWith('.zip')) {
                    validFiles.push(file);
                } else {
                    invalidFiles.push(file);
                }
            }

            // Mostrar aviso para arquivos inv√°lidos
            if (invalidFiles.length > 0) {
                const invalidNames = invalidFiles.map(f => f.name).join(', ');
                alert(`Os seguintes arquivos n√£o s√£o suportados: ${invalidNames}\n\nApenas imagens (JPG, PNG, GIF, BMP, WebP) e arquivos ZIP s√£o permitidos.`);
            }

            // Se n√£o h√° arquivos v√°lidos, sair
            if (validFiles.length === 0) return;

            // Preencher o input file com os arquivos v√°lidos
            const input = document.getElementById('bulkUploadFiles');
            const dt = new DataTransfer();
            validFiles.forEach(file => dt.items.add(file));
            input.files = dt.files;

            // Atualizar a lista de arquivos na interface
            updateBulkUploadFileList(validFiles);

            // Habilitar o bot√£o de upload
            const submitBtn = document.getElementById('bulkUploadBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
            }
        }

        function updateBulkUploadFileList(files) {
            const fileListDiv = document.getElementById('bulk-upload-file-list');
            if (!fileListDiv) return;

            if (files.length === 0) {
                fileListDiv.innerHTML = '';
                return;
            }

            let html = '<strong>Arquivos selecionados:</strong><ul class="mb-0 mt-2">';
            files.forEach(file => {
                const icon = file.name.toLowerCase().endsWith('.zip') ? 'üì¶' : 'üñºÔ∏è';
                const size = (file.size / 1024 / 1024).toFixed(2);
                html += `<li class="text-truncate">${icon} ${file.name} (${size} MB)</li>`;
            });
            html += '</ul>';
            fileListDiv.innerHTML = html;
        }

        // Adicionar event listener para o drop zone (clique para abrir seletor)
        document.addEventListener('DOMContentLoaded', function() {
            const dropZone = document.getElementById('bulk-upload-drop-zone');
            const fileInput = document.getElementById('bulkUploadFiles');

            if (dropZone && fileInput) {
                dropZone.addEventListener('click', function() {
                    fileInput.click();
                });

                // Atualizar lista quando arquivos s√£o selecionados via clique
                fileInput.addEventListener('change', function() {
                    updateBulkUploadFileList(Array.from(this.files));
                });
            }
        });

        // Inicializar verifica√ß√£o de status quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° uma tarefa em andamento
            checkBulkUploadStatus();

            // Configurar event listeners para o bulk upload
            const filesInput = document.getElementById('bulkUploadFiles');
            const submitBtn = document.getElementById('bulkUploadBtn');
            const form = document.getElementById('bulkUploadForm');

            if (filesInput && submitBtn && form) {
                // Estado inicial do bot√£o (desabilitado se n√£o houver arquivos)
                submitBtn.disabled = filesInput.files.length === 0;

                // Habilitar/desabilitar bot√£o baseado na sele√ß√£o de arquivos
                filesInput.addEventListener('change', function() {
                    submitBtn.disabled = this.files.length === 0;
                });

                // Interceptar submiss√£o do formul√°rio
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitBulkUploadForm();
                });
            }
        });

        // JavaScript para Pagina√ß√£o e Filtros de Utilizadores
        document.addEventListener('DOMContentLoaded', function() {
            const itemsPerPage = 10;
            let currentPage = 1;
            let allRows = [];
            let filteredRows = [];

            // Fun√ß√£o para salvar filtros no localStorage
            function saveFilters() {
                const filters = {
                    search: document.getElementById('searchUsers').value,
                    department: document.getElementById('filterDepartment').value,
                    role: document.getElementById('filterRole').value,
                    page: currentPage
                };
                localStorage.setItem('gestao_utilizadores', JSON.stringify(filters));
            }

            // Fun√ß√£o para carregar filtros do localStorage
            function loadFilters() {
                try {
                    const savedFilters = localStorage.getItem('gestao_utilizadores');
                    if (savedFilters) {
                        const filters = JSON.parse(savedFilters);
                        document.getElementById('searchUsers').value = filters.search || '';
                        document.getElementById('filterDepartment').value = filters.department || '';
                        document.getElementById('filterRole').value = filters.role || '';
                        currentPage = filters.page || 1;
                    }
                } catch (e) {
                    // Se houver erro ao carregar, ignora
                    console.warn('Erro ao carregar filtros salvos:', e);
                }
            }

            // Inicializar
            function init() {
                allRows = Array.from(document.querySelectorAll('.user-row'));
                filteredRows = [...allRows];
                loadFilters(); // Carregar filtros salvos
                setupEventListeners();
                updateTable();
            }

            // Configurar event listeners
            function setupEventListeners() {
                // Filtro de busca
                document.getElementById('searchUsers').addEventListener('input', function() {
                    currentPage = 1;
                    saveFilters(); // Salvar filtros
                    applyFilters();
                });

                // Filtro por departamento
                document.getElementById('filterDepartment').addEventListener('change', function() {
                    currentPage = 1;
                    saveFilters(); // Salvar filtros
                    applyFilters();
                });

                // Filtro por permiss√£o
                document.getElementById('filterRole').addEventListener('change', function() {
                    currentPage = 1;
                    saveFilters(); // Salvar filtros
                    applyFilters();
                });

                // Bot√£o limpar filtros
                document.getElementById('clearFilters').addEventListener('click', function() {
                    document.getElementById('searchUsers').value = '';
                    document.getElementById('filterDepartment').value = '';
                    document.getElementById('filterRole').value = '';
                    currentPage = 1;
                    saveFilters(); // Salvar filtros limpos
                    applyFilters();
                });
            }

            // Aplicar filtros
            function applyFilters() {
                const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
                const departmentFilter = document.getElementById('filterDepartment').value;
                const roleFilter = document.getElementById('filterRole').value;

                filteredRows = allRows.filter(row => {
                    const name = row.getAttribute('data-name') || '';
                    const email = row.getAttribute('data-email') || '';
                    const role = row.getAttribute('data-role') || '';
                    const departments = row.getAttribute('data-departments') || '';
                    const hasDepartments = row.getAttribute('data-has-departments') === 'true';

                    // Filtro de busca (nome ou email)
                    const matchesSearch = searchTerm === '' || 
                        name.includes(searchTerm) || 
                        email.includes(searchTerm);

                    // Filtro por departamento
                    let matchesDepartment = true;
                    if (departmentFilter !== '') {
                        if (departmentFilter === '_none') {
                            matchesDepartment = !hasDepartments;
                        } else {
                            matchesDepartment = departments.split(',').includes(departmentFilter);
                        }
                    }

                    // Filtro por permiss√£o
                    const matchesRole = roleFilter === '' || role === roleFilter;

                    return matchesSearch && matchesDepartment && matchesRole;
                });

                updateTable();
            }

            // Atualizar tabela com pagina√ß√£o
            function updateTable() {
                const totalItems = filteredRows.length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                
                // Esconder todas as linhas
                allRows.forEach(row => {
                    row.style.display = 'none';
                });

                // Mostrar apenas as linhas da p√°gina atual
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
                
                for (let i = startIndex; i < endIndex; i++) {
                    if (filteredRows[i]) {
                        filteredRows[i].style.display = '';
                    }
                }

                // Atualizar informa√ß√µes da pagina√ß√£o
                updatePaginationInfo(startIndex + 1, endIndex, totalItems);
                
                // Atualizar bot√µes de pagina√ß√£o
                updatePaginationButtons(totalPages);

                // Atualizar badge do contador
                updateUserCountBadge(totalItems);

                // Mostrar/esconder mensagem "nenhum utilizador"
                const noUsersMsg = document.getElementById('noUsersMessage');
                if (noUsersMsg) {
                    noUsersMsg.style.display = totalItems === 0 ? 'block' : 'none';
                }
            }

            // Atualizar informa√ß√µes da pagina√ß√£o
            function updatePaginationInfo(from, to, total) {
                document.getElementById('showingFrom').textContent = total > 0 ? from : 0;
                document.getElementById('showingTo').textContent = to;
                document.getElementById('totalUsers').textContent = total;
            }

            // Atualizar badge do contador
            function updateUserCountBadge(total) {
                const badge = document.getElementById('userCountBadge');
                if (badge) {
                    const pluralSuffix = total !== 1 ? 'es' : '';
                    badge.textContent = `${total} utilizador${pluralSuffix}`;
                }
            }

            // Atualizar bot√µes de pagina√ß√£o
            function updatePaginationButtons(totalPages) {
                const pagination = document.getElementById('pagination');
                pagination.innerHTML = '';

                if (totalPages <= 1) {
                    return;
                }

                // Bot√£o anterior
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">
                    <i class="bi bi-chevron-left"></i>
                </a>`;
                pagination.appendChild(prevLi);

                // Bot√µes de p√°ginas
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);

                if (startPage > 1) {
                    const firstLi = document.createElement('li');
                    firstLi.className = 'page-item';
                    firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
                    pagination.appendChild(firstLi);

                    if (startPage > 2) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(ellipsisLi);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                    pagination.appendChild(li);
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsisLi = document.createElement('li');
                        ellipsisLi.className = 'page-item disabled';
                        ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                        pagination.appendChild(ellipsisLi);
                    }

                    const lastLi = document.createElement('li');
                    lastLi.className = 'page-item';
                    lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
                    pagination.appendChild(lastLi);
                }

                // Bot√£o pr√≥ximo
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">
                    <i class="bi bi-chevron-right"></i>
                </a>`;
                pagination.appendChild(nextLi);

                // Event listeners para bot√µes de pagina√ß√£o
                pagination.addEventListener('click', function(e) {
                    e.preventDefault();
                    const link = e.target.closest('a[data-page]');
                    if (link && !link.closest('.page-item').classList.contains('disabled')) {
                        const page = parseInt(link.getAttribute('data-page'));
                        if (page >= 1 && page <= totalPages && page !== currentPage) {
                            currentPage = page;
                            saveFilters(); // Salvar p√°gina atual
                            updateTable();
                        }
                    }
                });
            }

            // Inicializar quando a p√°gina carregar
            init();
        });
    </script>
</body>
</html>
