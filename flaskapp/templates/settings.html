<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Configurações - Class Photo Booth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2b2b2b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Class Photo Booth">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='student_icon.jpg') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3 fixed-top">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <span class="display-6 me-2">⚙️</span>
                <div>
                    <div class="fw-bold">Configurações</div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                {% if has_data %}
                <a href="{{ url_for('turmas') }}" class="btn btn-light btn-sm rounded-pill px-3" title="Ver Turmas">
                    <i class="bi bi-eye me-1"></i>
                    <span class="d-none d-md-inline">Turmas</span>
                </a>
                {% else %}
                <a href="{{ url_for('turmas') }}" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Voltar">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-md-inline">Voltar</span>
                </a>
                {% endif %}
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Espaço para compensar navbar fixo -->
    <div class="navbar-spacer"></div>

    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Conteúdo principal -->
    <main class="container my-5">
        <!-- Gestão de Utilizadores -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2"></i>
                                Gestão de Utilizadores
                            </h5>
                            <div>
                                <button type="button" class="btn btn-outline-light btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                    <i class="bi bi-person-plus me-1"></i>
                                    Adicionar Utilizador
                                </button>
                                <span class="badge bg-light text-primary">{{ users|length }} utilizador{{ 'es' if users|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="50"></th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Permissão</th>
                                        <th>Estado</th>
                                        <th width="120">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>
                                            <div class="avatar-circle" id="avatar-user-{{ user.id }}">
                                                {{ user.name[0].upper() }}
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ user.name }}</strong>
                                            {% if user.id == current_user.id %}
                                                <span class="badge bg-info ms-1">Você</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            {% if user.role == 'admin' %}
                                                <span class="badge bg-danger">Administrador</span>
                                            {% elif user.role == 'editor' %}
                                                <span class="badge bg-warning">Editor</span>
                                            {% elif user.role == 'viewer' %}
                                                <span class="badge bg-success">Visualizador</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Sem Permissões</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_verified %}
                                                <span class="text-success">
                                                    <i class="bi bi-check-circle"></i> Verificado
                                                </span>
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="bi bi-clock"></i> Pendente
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editUserModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Editar utilizador">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetPasswordModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Alterar senha">
                                                    <i class="bi bi-key"></i>
                                                </button>
                                                {% if user.id != current_user.id %}
                                                <button type="button" class="btn btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteUserModal{{ user.id }}"
                                                        data-bs-toggle="tooltip" 
                                                        title="Eliminar utilizador">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if not users %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-people display-4"></i>
                            <p class="mt-2">Nenhum utilizador encontrado</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>




        <!-- Seção de Gestão de Pré Utilizadores -->
        {% if preusers %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Pré Utilizadores do Sistema
                            </h5>
                            <div>
                                <span class="badge bg-light text-primary">{{ preusers|length }} registo{{ 's' if preusers|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Email</th>
                                        <th>Código</th>
                                        <th>Motivo</th>
                                        <th>Data</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for preuser in preusers %}
                                    <tr>
                                        <td class="text-muted">#{{ preuser.id }}</td>
                                        <td>{{ preuser._email }}</td>
                                        <td>{{ preuser.code }}</td>
                                        <td>{{ preuser.reason }}</td>
                                        <td>{{ preuser.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('user_management', user_id=preuser.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar o utilizador {{ preuser._email }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_preuser_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Seção de Gestão de LoginLog -->
        {% if login_logs %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-people-fill me-2"></i>
                                Login Logs
                            </h5>
                            <div>
                                <form action="{{ url_for('login_log_management') }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja eliminar TODOS os logs de login? Esta ação não pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_login_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Eliminar todos os logs">
                                        <i class="bi bi-trash"></i> Limpar Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-primary">{{ login_logs|length }} registo{{ 's' if login_logs|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>utilizador</th>
                                        <th>Email</th>
                                        <th>Remote addr</th>
                                        <th>Data (UTC)</th>
                                        <th>Sucesso</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for login in login_logs %}
                                    <tr>
                                        <td class="text-muted">#{{ login.id }}</td>
                                        <td>{{ login.user.email }}</td>
                                        <td>{{ login.user.name }}</td>
                                        <td>{{ login.remote_addr }}</td>
                                        <td>{{ login.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td>{{ '✓' if login.success else '❌' }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('login_log_management', log_id=login.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja eliminar este log de login?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_login_delete">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Eliminar log">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                                
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Seção de Gestão de BannedIPs -->
        {% if banned_ips %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                IPs Banidos
                            </h5>
                            <div>
                                <form action="{{ url_for('banned_ip_management') }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja desbanir TODOS os IPs? Esta ação não pode ser desfeita!')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    <input type="hidden" name="action" value="crud_banned_ip_clear_all">
                                    <button type="submit" class="btn btn-outline-light btn-sm me-2" title="Desbanir todos os IPs">
                                        <i class="bi bi-unlock"></i> Desbanir Todos
                                    </button>
                                </form>
                                <span class="badge bg-light text-danger">{{ banned_ips|length }} IP{{ 's' if banned_ips|length != 1 else '' }} banido{{ 's' if banned_ips|length != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Endereço IP</th>
                                        <th>Data do Banimento</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for banned_ip in banned_ips %}
                                    <tr>
                                        <td class="text-muted">#{{ banned_ip.id }}</td>
                                        <td><code>{{ banned_ip.remote_addr }}</code></td>
                                        <td>{{ banned_ip.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                        <td class="text-center">
                                            <div class="btn-group" role="group">
                                                <form action="{{ url_for('banned_ip_management', banned_ip_id=banned_ip.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja desbanir o IP {{ banned_ip.remote_addr }}?')">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <input type="hidden" name="action" value="crud_banned_ip_delete">
                                                    <button type="submit" class="btn btn-outline-success btn-sm" title="Desbanir IP">
                                                        <i class="bi bi-unlock"></i> Desbanir
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Modais para Edição e Eliminação de Utilizadores -->
        {% for user in users %}
        <!-- Modal de Edição -->
        <div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_edit">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editName{{ user.id }}" class="form-label">Nome</label>
                                <input type="text" class="form-control" id="editName{{ user.id }}" 
                                       name="name" value="{{ user.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail{{ user.id }}" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail{{ user.id }}" 
                                       name="email" value="{{ user.email }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editRole{{ user.id }}" class="form-label">Permissão</label>
                                <select class="form-select" id="editRole{{ user.id }}" name="role" required>
                                    <option value="none" {% if user.role == 'none' %}selected{% endif %}>Sem Permissões</option>
                                    <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                    <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Administrador</option>
                                </select>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="notifyUser{{ user.id }}" name="notify_user" value="true">
                                <label class="form-check-label" for="notifyUser{{ user.id }}">
                                    Notificar utilizador que a conta for alterada
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal de Eliminação -->
        {% if user.id != current_user.id %}
        <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Eliminar Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem a certeza que deseja eliminar o utilizador <strong>{{ user.name }}</strong>?</p>
                        <p class="text-muted small">Esta ação não pode ser desfeita.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <form action="{{ url_for('user_management', user_id=user.id) }}" method="post" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="crud_user_delete">
                            <button type="submit" class="btn btn-danger">Eliminar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Modal de Reset de Senha -->
        <div class="modal fade" id="resetPasswordModal{{ user.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Alterar Senha do Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management', user_id=user.id) }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_reset_password">
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Atenção:</strong> Vai alterar a senha do utilizador <strong>{{ user.name }}</strong>.
                            </div>
                            <div class="mb-3">
                                <label for="resetPassword{{ user.id }}" class="form-label">Nova Senha *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="resetPassword{{ user.id }}" 
                                           name="new_password" required minlength="6">
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="togglePasswordVisibility('resetPassword{{ user.id }}', this)"
                                            title="Mostrar/Ocultar senha">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">Mínimo 6 caracteres. Recomenda-se: maiúsculas, minúsculas, números e símbolos.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador deverá ser informado da nova senha por um canal seguro.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-key me-1"></i>
                                Alterar Senha
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}

        <!-- Modal para Adicionar Novo Utilizador -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar Novo Utilizador</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{{ url_for('user_management') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_user_add_new">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="addUserName" class="form-label">Nome *</label>
                                <input type="text" class="form-control" id="addUserName" 
                                       name="name" required minlength="2" maxlength="100">
                                <div class="form-text">Nome que será exibido na aplicação.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserEmail" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="addUserEmail" 
                                       name="email" required>
                                <div class="form-text">Email será usado para login e comunicações.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserPassword" class="form-label">Palavra-passe *</label>
                                <input type="password" class="form-control" id="addUserPassword" 
                                       name="password" required minlength="6">
                                <div class="form-text">Mínimo 6 caracteres. Recomenda-se: maiúsculas, minúsculas, números e símbolos.</div>
                            </div>
                            <div class="mb-3">
                                <label for="addUserRole" class="form-label">Permissão *</label>
                                <select class="form-select" id="addUserRole" name="role" required>
                                    <option value="">Selecione a permissão...</option>
                                    <option value="none">Sem Permissões - Acesso negado</option>
                                    <option value="viewer">Visualizador - Apenas consulta</option>
                                    <option value="editor">Editor - Pode editar dados</option>
                                    <option value="admin">Administrador - Acesso completo</option>
                                </select>
                                <div class="form-text">Define o nível de acesso do utilizador na aplicação.</div>
                            </div>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Nota:</strong> O utilizador receberá um email de boas-vindas com as instruções de acesso.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-person-plus me-1"></i>
                                Criar Utilizador
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        <!-- Info sobre formato CSV -->
         <div class="row justify-content-center mb-4">

         </div>
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Gestão de Alunos em Lote - Importação de dados no formato do ficheiro CSV:</strong> 
                    <br>Exemplo: 
                    <br><small class="text-muted">turma,numero,processo,nome,email</small>
                    <br><small class="text-muted">5A,1,12345,João Silva,joao.silva@escola.pt</small>
                    <br><small class="text-muted">5A,2,67890,Maria Santos,maria.santos@escola.pt</small>
                    <br><small class="text-muted">5B,1,11223,Pedro Costa,pedro.costa@escola.pt</small>
                    <br><small class="text-warning">A coluna "email" é opcional. Se não existir, será ignorada.</small>
                </div>
            </div>
        </div>

        {% if not has_data %}
        <!-- Mensagem de primeiro acesso -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Primeiro Acesso:</strong> Nenhuma turma foi encontrada. Carregue um ficheiro CSV para começar.
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Cards das funcionalidades -->
        <div class="row g-4">
            <!-- Card 1: Substituir Dados -->
            {% if can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">🔄</div>
                        <h5 class="card-title fw-bold">Substituir Todos os Dados</h5>
                        <p class="card-text text-muted">
                            Carregar novo ficheiro CSV e <strong>eliminar todos os dados existentes</strong>. 
                            As fotos serão mantidas.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="replaceForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="replace">
                            <div class="mb-3">
                                <input type="file" name="file" id="replaceFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-danger w-100" id="replaceBtn" disabled>
                                <i class="bi bi-arrow-repeat me-2"></i>
                                Substituir Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 2: Atualizar/Adicionar Dados (só se houver dados) -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-primary mb-3">➕</div>
                        <h5 class="card-title fw-bold">Atualizar/Adicionar Dados</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>merge</strong> com os dados existentes. 
                            Novos alunos serão adicionados, existentes atualizados.
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="mergeForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="merge">
                            <div class="mb-3">
                                <input type="file" name="file" id="mergeFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="mergeBtn" disabled>
                                <i class="bi bi-plus-circle me-2"></i>
                                Atualizar Dados
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 3: Atualizar Professores -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">👨‍🏫</div>
                        <h5 class="card-title fw-bold">Atualizar Professores</h5>
                        <p class="card-text text-muted">
                            Atualizar apenas os <strong>nomes e emails dos professores</strong> responsáveis pelas turmas. 
                            CSV deve ter colunas: turma, professor, email (opcional).
                        </p>
                        
                        <form action="{{ url_for('settings_csv') }}" method="post" enctype="multipart/form-data" id="updateProfessorForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="update_professor">
                            <div class="mb-3">
                                <input type="file" name="file" id="updateProfessorFile" accept=".csv" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-info w-100" id="updateProfessorBtn" disabled>
                                <i class="bi bi-person-lines-fill me-2"></i>
                                Atualizar Professores
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 4: Fazer rescan aos ficheiros que já existam -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-warning mb-3">🔍</div>
                        <h5 class="card-title fw-bold">Fazer Rescan</h5>
                        <p class="card-text text-muted">
                            Fazer <strong>rescan</strong> das fotos existentes em disco.
                        </p>
                        
                        <form action="{{ url_for('settings_rescan_photos') }}" method="post" id="rescanForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="rescan">
                            
                            <div class="mb-3 text-start">
                                <label class="form-label fw-semibold">Opções de marcação:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsTaken" value="taken" checked>
                                    <label class="form-check-label" for="markAsTaken">
                                        Marcar todas as fotos encontradas como <strong>tiradas</strong>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mark_option" id="markAsNotTaken" value="not_taken">
                                    <label class="form-check-label" for="markAsNotTaken">
                                        Marcar todas as fotos encontradas como <strong>não tiradas</strong>
                                    </label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-warning w-100" id="rescanBtn">
                                <i class="bi bi-search me-2"></i>
                                Fazer Rescan
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 5: Backup Total da Base de Dados -->
            {% if has_data and can_upload_csv %}
            <div class="col-lg-4">
                <div class="card h-100 border-0 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-info mb-3">💾</div>
                        <h5 class="card-title fw-bold">Backup Total</h5>
                        <p class="card-text text-muted">
                            Criar <strong>backup completo</strong> da base de dados em formato ZIP com ficheiros CSV.
                        </p>
                        
                        <form action="{{ url_for('settings_backup') }}" method="post" id="backupForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="action" value="backup">
                            
                            <div class="mb-3 text-start">
                                <small class="text-muted">
                                    O backup incluirá:
                                    <ul class="list-unstyled mt-2">
                                        <li>📄 <strong>users.csv</strong> - Dados dos utilizadores</li>
                                        <li>👥 <strong>alunos.csv</strong> - Dados dos alunos</li>
                                        <li>🏫 <strong>turmas_professores.csv</strong> - Dados dos professores</li>
                                    </ul>
                                </small>
                            </div>
                            
                            <button type="submit" class="btn btn-info w-100" id="backupBtn">
                                <i class="bi bi-download me-2"></i>
                                Criar Backup
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Card 6: Limpeza Completa (só se houver dados) -->
            {% if has_data and can_system_nuke %}
            <div class="col-lg-4">
                <div class="card h-100 border-danger border-2 shadow">
                    <div class="card-body text-center p-4">
                        <div class="display-4 text-danger mb-3">🗑️</div>
                        <h5 class="card-title fw-bold text-danger">Limpeza Completa</h5>
                        <p class="card-text text-muted">
                            <strong>⚠️ ATENÇÃO:</strong> Elimina <strong>TODOS os dados e fotos</strong> 
                            de forma permanente. Não pode ser desfeita!
                        </p>
                        
                        <form action="{{ url_for('settings_nuke') }}" method="post" id="nukeForm" onsubmit="return confirmNuke()">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                LIMPAR TUDO
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}


            <!-- Painel Redis Server -->
            <div class="col-lg-6">
            <div class="card border-0 shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Redis Server</h3>
                    <div class="d-flex align-items-center gap-3">
                    <label class="form-check-label me-2" title="Atualizar automaticamente de 5 em 5 segundos">
                        <input id="redis-server-autorefresh" type="checkbox" class="form-check-input" checked>
                        Auto (5s)
                    </label>
                    <label class="form-check-label me-2" title="Mostrar todos os dados (INFO completo)">
                        <input id="redis-server-showall" type="checkbox" class="form-check-input">
                        Tudo
                    </label>
                    <button id="redis-server-refresh" type="button" class="btn btn-secondary btn-sm">Atualizar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="redis-server-error" class="text-danger mb-2" hidden></div>
                    <div id="redis-server-table-container" class="redis-table-container"></div>
                </div>
            </div>
            </div>
            <!-- End Painel Redis Server -->

            <!-- Painel Redis Sessions -->
            <div class="col-lg-6">
            <div class="card border-0 shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Redis Sessions</h3>
                    <div class="d-flex align-items-center gap-3">
                    <label class="form-check-label me-2" title="Atualizar automaticamente de 5 em 5 segundos">
                        <input id="redis-sessions-autorefresh" type="checkbox" class="form-check-input" checked>
                        Auto (5s)
                    </label>
                    <label class="form-check-label me-2" title="Mostrar todas as sessões">
                        <input id="redis-sessions-showall" type="checkbox" class="form-check-input">
                        Todas
                    </label>
                    <button id="redis-sessions-refresh" type="button" class="btn btn-secondary btn-sm">Atualizar</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="redis-sessions-error" class="text-danger mb-2" hidden></div>
                    <div id="redis-sessions-table-container" class="redis-table-container"></div>
                </div>
            </div>
            </div>
            <!-- End Painel Redis Sessions -->

        </div>
        

    </main>

    
    <!-- Mobile bottom buttons -->
    <!--
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-6">
                    {% if has_data %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-success w-100 mobile-btn-inline">
                        <i class="bi bi-eye"></i>
                        <small>Ver Turmas</small>
                    </a>
                    {% else %}
                    <a href="{{ url_for('turmas') }}" class="btn btn-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-arrow-left"></i>
                        <small>Voltar</small>
                    </a>
                    {% endif %}
                </div>
                <div class="col-6">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
    -->




    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- status do REDIS -->
    <script>
        function initializeRedisPanels() {
        // Configuração para cada painel Redis
        const redisConfigs = [
            {
                id: 'redis-server',
                endpoint: '/settings/redis/server.json',
                title: 'Redis Server'
            },
            {
                id: 'redis-sessions', 
                endpoint: '/settings/redis/sessions.json',
                title: 'Redis Sessions'
            }
        ];

        // Achata o JSON: {a:{b:1}, c:[2,3]} -> {"a.b":1, "c[0]":2, "c[1]":3}
        function flatten(obj, prefix = '', out = {}) {
            const isObj = v => v !== null && typeof v === 'object';
            if (!isObj(obj)) { out[prefix || '(root)'] = obj; return out; }
            if (Array.isArray(obj)) { obj.forEach((v, i) => flatten(v, `${prefix}[${i}]`, out)); return out; }
            for (const [k, v] of Object.entries(obj)) {
            const key = prefix ? `${prefix}.${k}` : k;
            isObj(v) ? flatten(v, key, out) : (out[key] = v);
            }
            return out;
        }

        // Função para formatar datas com cores personalizadas
        function formatDateValue(tdElement, value, color = '#000000') {
            if (typeof value === 'string' && value !== 'Never' && value !== '1900-01-01' && value !== 'null' && value) {
                try {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        tdElement.textContent = date.toLocaleString('pt-PT');
                        tdElement.style.fontWeight = 'bold';
                        tdElement.style.color = color;
                        return true; // Indica que a formatação foi aplicada
                    }
                } catch {
                    // Se falhar, deixa o valor original
                }
            }
            tdElement.textContent = value;
            return false; // Indica que a formatação não foi aplicada
        }

        function buildTable(kv) {
            const table = document.createElement('table');
            table.className = 'table table-sm table-striped';

            const thead = document.createElement('thead');
            thead.innerHTML = '<tr><th class="w-45">Chave</th><th>Valor</th></tr>';
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            
            // Função auxiliar para ordenar campos dentro de cada utilizador
            function getFieldOrder(key) {
                if (key.includes('last_seen')) return 1;
                if (key.includes('expires_at')) return 2;
                if (key.includes('email')) return 3;
                if (key.includes('name')) return 4;
                if (key.includes('sessions_count')) return 5;
                if (key.includes('user_id')) return 6;
                return 9;
            }
            
            const keys = Object.keys(kv).sort((a, b) => {
            const order = k => (k === 'status') ? 0 :
                                (k === 'sessions_count' || k === 'sessions_total') ? 1 :
                                (k === 'authenticated_users_total') ? 2 :
                                (k === 'latency_ms') ? 3 :
                                (k === 'generated_at') ? 4 :
                                (k === 'showing_all' || k === 'limit_applied') ? 5 :
                                (k.startsWith('User ')) ? 10 + parseInt(k.split(' ')[1]) * 10 + getFieldOrder(k) : // Agrupar utilizadores
                                (k.includes('last_seen')) ? 6 :
                                (k.includes('sliding_expiry')) ? 7 :
                                (k.includes('expires_at')) ? 8 :
                                (k.startsWith('active_users')) ? 10 :
                                (k.startsWith('sessions_detail')) ? 20 :
                                (k.startsWith('info.')) ? 100 : 50;
            return order(a) - order(b) || a.localeCompare(b);
            });
            
            // Função auxiliar para ordenar campos dentro de cada utilizador
            function getFieldOrder(key) {
                if (key.includes('last_seen')) return 1;
                if (key.includes('email')) return 2;
                if (key.includes('name')) return 3;
                if (key.includes('sessions_count')) return 4;
                if (key.includes('user_id')) return 5;
                return 9;
            }

            for (const k of keys) {
            const tr = document.createElement('tr');
            const tdK = document.createElement('td'); tdK.textContent = k;
            const tdV = document.createElement('td');
            const v = kv[k];
            
            // Formatação especial para campos de utilizadores
            if (k.startsWith('User ')) {
                if (k.includes('last_seen')) {
                    formatDateValue(tdV, v, '#28a745'); // Verde para last_seen
                } else if (k.includes('expires_at')) {
                    formatDateValue(tdV, v, '#dc3545'); // Vermelho para expires_at
                } else if (k.includes('email')) {
                    tdV.textContent = v;
                    tdV.style.fontWeight = 'bold';
                    tdV.style.color = '#007bff';
                } else if (k.includes('name')) {
                    tdV.textContent = v;
                    tdV.style.fontWeight = 'bold';
                } else {
                    tdV.textContent = v;
                }
                // Adicionar background diferente para campos de utilizador
                tr.style.backgroundColor = '#f8f9fa';
            }
            // Formatação especial para campos de data/hora (não utilizadores)
            else if (k.includes('last_seen')) {
                formatDateValue(tdV, v, '#28a745'); // Verde para last_seen
            } else if (k.includes('expires_at')) {
                formatDateValue(tdV, v, '#dc3545'); // Vermelho para expires_at
            } else if (k.includes('generated_at')) {
                formatDateValue(tdV, v, '#000000'); // Preto para generated_at
            } else if (k.includes('sliding_expiry') && typeof v === 'boolean') {
                tdV.textContent = v ? '✅ Sim (renova automaticamente)' : '❌ Não (TTL fixo)';
                tdV.style.fontWeight = 'bold';
            } else {
                tdV.textContent = (typeof v === 'object') ? JSON.stringify(v) : String(v);
            }
            
            tr.append(tdK, tdV);
            tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            return table;
        }

        // Função para atualizar as cores dos avatares baseado no status de atividade
        function updateAvatarStatus(data) {
            // Primeiro, resetar todos os avatares para o estado padrão (remover classes de status)
            document.querySelectorAll('.avatar-circle').forEach(avatar => {
                avatar.classList.remove('status-online', 'status-away', 'status-offline');
                avatar.title = 'Sem dados de sessão recente';
            });

            // Obter tempo atual
            const now = new Date();

            // Processar utilizadores das sessões Redis
            for (const [key, value] of Object.entries(data)) {
                if (key.startsWith('User ') && key.includes('user_id')) {
                    const userId = value;
                    const userIndex = key.split(' ')[1];
                    
                    // Buscar o last_seen correspondente
                    const lastSeenKey = `User ${userIndex} last_seen`;
                    const lastSeenValue = data[lastSeenKey];
                    
                    if (lastSeenValue && lastSeenValue !== 'Never' && lastSeenValue !== '1900-01-01') {
                        try {
                            const lastSeen = new Date(lastSeenValue);
                            const diffMinutes = (now - lastSeen) / (1000 * 60);
                            
                            const avatar = document.getElementById(`avatar-user-${userId}`);
                            if (avatar) {
                                if (diffMinutes <= 5) {
                                    avatar.classList.add('status-online');
                                    avatar.title = `🟢 Online - Último acesso há ${Math.round(diffMinutes)} minuto(s)`;
                                } else if (diffMinutes <= 60) {
                                    avatar.classList.add('status-away');
                                    avatar.title = `🟡 Ausente - Último acesso há ${Math.round(diffMinutes)} minuto(s)`;
                                } else {
                                    avatar.classList.add('status-offline');
                                    const diffHours = Math.round(diffMinutes / 60);
                                    avatar.title = `⚫ Offline - Último acesso há ${diffHours} hora(s)`;
                                }
                            }
                        } catch (e) {
                            // Se falhar a parsing da data, deixar sem status
                        }
                    }
                }
            }
        }

        // Classe para gerenciar cada painel Redis
        class RedisPanel {
            constructor(config) {
            this.config = config;
            this.container = document.getElementById(`${config.id}-table-container`);
            this.btn = document.getElementById(`${config.id}-refresh`);
            this.auto = document.getElementById(`${config.id}-autorefresh`);
            this.showAll = document.getElementById(`${config.id}-showall`);
            this.errorBox = document.getElementById(`${config.id}-error`);
            
            this.timer = null;
            this.loading = false;
            
            this.init();
            }

            buildUrl() {
            const params = new URLSearchParams();
            if (this.showAll && this.showAll.checked) params.set('data', 'all');
            const qs = params.toString();
            return qs ? `${this.config.endpoint}?${qs}` : this.config.endpoint;
            }

            async fetchAndRender() {
            if (this.loading) return;
            try {
                this.loading = true;
                this.btn && (this.btn.disabled = true);
                this.errorBox.hidden = true; 
                this.errorBox.textContent = '';

                const r = await fetch(this.buildUrl(), { cache: 'no-store' });
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const data = await r.json();

                // Render: achatar TUDO o que vier
                const flat = flatten(data);
                const table = buildTable(flat);

                this.container.innerHTML = '';
                this.container.appendChild(table);
                
                // Atualizar status dos avatares apenas para painel de sessões
                if (this.config.id === 'redis-sessions') {
                    updateAvatarStatus(flat);
                }
            } catch (e) {
                this.errorBox.hidden = false;
                this.errorBox.textContent = e.message || `Erro ao obter estado do ${this.config.title}.`;
                this.container.innerHTML = '';
            } finally {
                this.loading = false;
                this.btn && (this.btn.disabled = false);
            }
            }

            startAuto() { 
            this.stopAuto(); 
            this.timer = setInterval(() => this.fetchAndRender(), 5000); 
            }
            
            stopAuto() { 
            if (this.timer) { 
                clearInterval(this.timer); 
                this.timer = null; 
            } 
            }

            init() {
            // Event listeners
            this.btn && this.btn.addEventListener('click', () => this.fetchAndRender());
            this.auto && this.auto.addEventListener('change', () => 
                this.auto.checked ? this.startAuto() : this.stopAuto()
            );
            this.showAll && this.showAll.addEventListener('change', () => this.fetchAndRender());

            // Initial load
            this.fetchAndRender();
            if (this.auto && this.auto.checked) this.startAuto();

            // Handle visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) this.stopAuto();
                else if (this.auto && this.auto.checked) this.startAuto();
            });
            }
        }

        // Inicializar todos os painéis Redis
        redisConfigs.forEach(config => new RedisPanel(config));
        }

        // Executar quando a página carregar
        initializeRedisPanels();
    </script>

    <script>
        // Função para mostrar/ocultar senha
        function togglePasswordVisibility(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
                button.title = 'Ocultar senha';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
                button.title = 'Mostrar senha';
            }
        }
</script>




    <script>
        // Validação do formulário de adicionar utilizador
        document.addEventListener('DOMContentLoaded', function() {
            const addUserForm = document.querySelector('#addUserModal form');
            const passwordField = document.getElementById('addUserPassword');

            if (addUserForm && passwordField) {
                addUserForm.addEventListener('submit', function(e) {
                    const password = passwordField.value;

                    // Validação de força da palavra-passe
                    if (password.length < 6) {
                        e.preventDefault();
                        alert('A palavra-passe deve ter pelo menos 6 caracteres.');
                        passwordField.focus();
                        return false;
                    }

                    return true;
                });
            }
        });

        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '{{ url_for("logout") }}';
            }
        }

        // Habilitar botões quando arquivo for selecionado
        const replaceFile = document.getElementById('replaceFile');
        if (replaceFile) {
            replaceFile.addEventListener('change', function() {
                const replaceBtn = document.getElementById('replaceBtn');
                if (replaceBtn) {
                    replaceBtn.disabled = !this.files.length;
                }
            });
        }

        const mergeFile = document.getElementById('mergeFile');
        if (mergeFile) {
            mergeFile.addEventListener('change', function() {
                const mergeBtn = document.getElementById('mergeBtn');
                if (mergeBtn) {
                    mergeBtn.disabled = !this.files.length;
                }
            });
        }
        
        const updateProfessorFile = document.getElementById('updateProfessorFile');
        if (updateProfessorFile) {
            updateProfessorFile.addEventListener('change', function() {
                const updateProfessorBtn = document.getElementById('updateProfessorBtn');
                if (updateProfessorBtn) {
                    updateProfessorBtn.disabled = !this.files.length;
                }
            });
        }

        // Confirmação para limpeza completa
        function confirmNuke() {
            return confirm(
                '⚠️ ATENÇÃO: LIMPEZA COMPLETA ⚠️\n\n' +
                'Esta operação irá eliminar TODOS os dados e fotos!\n' +
                'ESTA AÇÃO NÃO PODE SER DESFEITA!\n\n' +
                'Tem certeza que pretende continuar?'
            );
        }
    </script>
</body>
</html>
