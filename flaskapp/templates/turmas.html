<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Class Photo Booth - Turmas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <span class="display-6 me-2">üìö</span>
                <div>
                    <div class="fw-bold">Class Photo Booth</div>
                    <small class="text-white-50 d-block">Selecione uma turma para come√ßar</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button onclick="addTurma()" class="btn btn-light btn-sm rounded-pill px-3" title="Nova Turma">
                    <i class="bi bi-plus-circle me-1"></i>
                    <span class="d-none d-md-inline">Nova</span>
                </button>
                <a href="/settings" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Configura√ß√µes">
                    <i class="bi bi-gear me-1"></i>
                    <span class="d-none d-md-inline">Config</span>
                </a>
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    {% if turmas|length > 0 %}
    <div class="container">
        <div class="stats-card">
            <div class="stats-number">{{ turmas|length }}</div>
            <div class="stats-label">Turma{{ 's' if turmas|length != 1 else '' }} Dispon√≠v{{ 'eis' if turmas|length != 1 else 'el' }}</div>
            
            <!-- Contagem de alunos e fotos -->
            <div class="d-flex justify-content-between text-muted small mt-3 mb-2">
                <span>{{ total_alunos_geral }} aluno{{ 's' if total_alunos_geral != 1 else '' }}</span>
                <span>{{ total_fotos_geral }} foto{{ 's' if total_fotos_geral != 1 else '' }}</span>
            </div>
            
            <!-- Barra de progresso geral -->
            {% set percentage_geral = (total_fotos_geral / total_alunos_geral * 100) if total_alunos_geral > 0 else 0 %}
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">Progresso Geral</small>
                    <small class="fw-bold text-{% if percentage_geral == 100 %}success{% elif percentage_geral >= 75 %}info{% elif percentage_geral >= 50 %}warning{% else %}danger{% endif %}">
                        {{ "%.0f"|format(percentage_geral) }}%
                    </small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-{% if percentage_geral == 100 %}success{% elif percentage_geral >= 75 %}info{% elif percentage_geral >= 50 %}warning{% else %}danger{% endif %}" 
                         role="progressbar" 
                         style="width: {{ percentage_geral }}%;" 
                         aria-valuenow="{{ percentage_geral }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-3">
            {% for turma in turmas %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-3">
                <div class="turma-card h-100" style="cursor: pointer;">
                    {% if turma.total_alunos > 0 and turma.alunos_com_foto == turma.total_alunos %}
                    <div class="turma-completed-status">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    {% endif %}
                
                <a href="{{ url_for('turma', nome_seguro=turma.nome_seguro) }}" class="text-decoration-none text-dark">
                    <div class="turma-icon">üéì</div>
                    <h5 class="fw-bold mb-3">
                        {{ turma.nome }} 
                        {% if turma.nome_professor %} - {{ turma.nome_professor }}
                        {% endif %}
                    </h5>

                    <div class="d-flex justify-content-between text-muted small mb-2">
                        <span>{{ turma.total_alunos }} aluno{{ 's' if turma.total_alunos != 1 else '' }}</span>
                        <span>{{ turma.alunos_com_foto }} foto{{ 's' if turma.alunos_com_foto != 1 else '' }}</span>
                    </div>
                    
                    <!-- Barra de progresso -->
                    {% set percentage = (turma.alunos_com_foto / turma.total_alunos * 100) if turma.total_alunos > 0 else 0 %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progresso</small>
                            <small class="fw-bold text-{% if percentage == 100 %}success{% elif percentage >= 75 %}info{% elif percentage >= 50 %}warning{% else %}danger{% endif %}">
                                {{ "%.0f"|format(percentage) }}%
                            </small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-{% if percentage == 100 %}success{% elif percentage >= 75 %}info{% elif percentage >= 50 %}warning{% else %}danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ percentage }}%;" 
                                 aria-valuenow="{{ percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </a>
                
                <div class="d-flex gap-2 mt-auto">
                    <button type="button" class="btn btn-sm btn-outline-primary flex-fill edit-turma-btn" 
                            data-turma-id="{{ turma.id }}"
                            data-turma-nome="{{ turma.nome }}"
                            data-nome-professor="{{ turma.nome_professor | default('') }}"
                            data-email-professor="{{ turma.email_professor | default('') }}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger flex-fill" 
                            onclick="deleteTurma({{ turma.id }}, '{{ turma.nome }}', {{ turma.total_alunos }})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <!-- √öltima atualiza√ß√£o -->
                {% if turma.last_updated %}
                <div class="text-muted small mb-2 text-secondary">
                    <i class="bi bi-clock me-1"></i>
                    <span>atualiza√ß√£o: </span>
                    <span class="last-updated-utc" data-utc-date="{{ turma.last_updated.strftime('%Y-%m-%d %H:%M:%S') if turma.last_updated else '' }}">
                        {{ turma.last_updated.strftime('%Y-%m-%d %H:%M:%S') if turma.last_updated else 'N/A' }}
                    </span>
                </div>
                {% endif %}


            </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="container">
        <div class="text-center py-4 mb-4">
            <div class="display-1 mb-3">ÔøΩ</div>
            <h3 class="mb-3">Nenhuma turma encontrada</h3>
            <p class="text-muted">Comece por criar a sua primeira turma ou carregue dados via CSV.</p>
        </div>
        
        <div class="row g-4 justify-content-center">
            <!-- Cart√£o para criar primeira turma -->
            <div class="col-6 col-md-4 col-lg-3">
                <div class="turma-card h-100" style="cursor: pointer; border: 2px dashed #4a5eaa;" onclick="addTurma()">
                    <div class="text-center">
                        <div class="display-4 mb-3 text-primary">‚ûï</div>
                        <h5 class="fw-bold mb-3 text-primary">Criar a primeira turma</h5>
                        <p class="text-muted small">Adicione uma nova turma manualmente</p>
                    </div>
                </div>
            </div>
            
            <!-- Cart√£o para carregar via CSV -->
            <div class="col-6 col-md-4 col-lg-3">
                <div class="turma-card h-100" style="cursor: pointer; border: 2px dashed #28a745;" onclick="window.location.href='/settings'">
                    <div class="text-center">
                        <div class="display-4 mb-3 text-success">üìä</div>
                        <h5 class="fw-bold mb-3 text-success">Carregar turmas via CSV</h5>
                        <p class="text-muted small">Importe dados de um ficheiro CSV</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Mobile action buttons -->
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-4">
                    <button onclick="addTurma()" class="btn btn-primary w-100 mobile-btn-inline">
                        <i class="bi bi-plus-circle"></i>
                        <small>Turma</small>
                    </button>
                </div>
                <div class="col-4">
                    <a href="/settings" class="btn btn-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-gear"></i>
                        <small>Config.</small>
                    </a>
                </div>
                <div class="col-4">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar turma -->
    <div class="modal fade" id="addTurmaModal" tabindex="-1" aria-labelledby="addTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTurmaModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Nova Turma
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="addTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_add_new">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addTurmaNome" class="form-label">Nome da Turma</label>
                            <input type="text" class="form-control" id="addTurmaNome" name="nome" required 
                                   placeholder="Ex: 5A, 10¬∫ B, Matem√°tica..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="addTurmaProfessor" class="form-label">Professor Respons√°vel</label>
                            <input type="text" class="form-control" id="addTurmaProfessor" name="nome_professor" 
                                   placeholder="Nome do professor respons√°vel pela turma..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="addTurmaEmailProfessor" class="form-label">Email do Professor</label>
                            <input type="email" class="form-control" id="addTurmaEmailProfessor" name="email_professor" 
                                   placeholder="Email do professor respons√°vel (opcional)..." maxlength="255">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Criar Turma
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar turma -->
    <div class="modal fade" id="editTurmaModal" tabindex="-1" aria-labelledby="editTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTurmaModalLabel">
                        <i class="bi bi-pencil me-2"></i>Editar Turma
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="editTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_edit">
                    <input type="hidden" name="turma_id" id="editTurmaId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editTurmaNome" class="form-label">Nome da Turma</label>
                            <input type="text" class="form-control" id="editTurmaNome" name="nome" required 
                                   placeholder="Ex: 5A, 10¬∫ B, Matem√°tica..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="editTurmaProfessor" class="form-label">Professor Respons√°vel</label>
                            <input type="text" class="form-control" id="editTurmaProfessor" name="nome_professor" 
                                   placeholder="Nome do professor respons√°vel pela turma..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="editTurmaEmailProfessor" class="form-label">Email do Professor</label>
                            <input type="email" class="form-control" id="editTurmaEmailProfessor" name="email_professor" 
                                   placeholder="Email do professor respons√°vel (opcional)..." maxlength="255">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-pencil me-1"></i>Guardar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar elimina√ß√£o de turma -->
    <div class="modal fade" id="deleteTurmaModal" tabindex="-1" aria-labelledby="deleteTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteTurmaModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Elimina√ß√£o
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="deleteTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_delete">
                    <input type="hidden" name="turma_id" id="deleteTurmaId">
                    <div class="modal-body">
                        <p class="mb-3">
                            <strong>Tem certeza que deseja eliminar a turma "<span id="deleteTurmaNome"></span>"?</strong>
                        </p>
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Esta a√ß√£o ir√° eliminar:
                            <ul class="mb-0 mt-2">
                                <li>A turma e todos os seus <span id="deleteTurmaAlunos"></span> alunos</li>
                                <li>Todas as fotos associadas √† turma</li>
                            </ul>
                        </div>
                        <p class="text-muted mb-0">
                            <small><i class="bi bi-info-circle me-1"></i>Esta a√ß√£o n√£o pode ser desfeita.</small>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-1"></i>Eliminar Turma
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '/logout';
            }
        }
        
        // Fun√ß√£o para adicionar nova turma
        function addTurma() {
            const modal = new bootstrap.Modal(document.getElementById('addTurmaModal'));
            document.getElementById('addTurmaNome').value = '';
            modal.show();
        }
        
        // Fun√ß√£o para editar turma
        // Event listeners para bot√µes de editar turma
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.edit-turma-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const turmaId = this.dataset.turmaId;
                    const turmaNome = this.dataset.turmaNome;
                    const nomeProfessor = this.dataset.nomeProfessor;
                    const emailProfessor = this.dataset.emailProfessor;
                    
                    editTurma(turmaId, turmaNome, nomeProfessor, emailProfessor);
                });
            });
        });

        function editTurma(turmaId, turmaNome, nomeProfessor, emailProfessor) {
            console.log('editTurma called with:', {turmaId, turmaNome, nomeProfessor, emailProfessor});
            
            document.getElementById('editTurmaId').value = turmaId;
            document.getElementById('editTurmaNome').value = turmaNome;
            document.getElementById('editTurmaProfessor').value = nomeProfessor || '';
            document.getElementById('editTurmaEmailProfessor').value = emailProfessor || '';
            
            console.log('Fields populated:', {
                id: document.getElementById('editTurmaId').value,
                nome: document.getElementById('editTurmaNome').value,
                professor: document.getElementById('editTurmaProfessor').value,
                email: document.getElementById('editTurmaEmailProfessor').value
            });
            
            const modal = new bootstrap.Modal(document.getElementById('editTurmaModal'));
            modal.show();
        }
        
        // Fun√ß√£o para confirmar elimina√ß√£o de turma
        function deleteTurma(turmaId, turmaNome, totalAlunos) {
            document.getElementById('deleteTurmaId').value = turmaId;
            document.getElementById('deleteTurmaNome').textContent = turmaNome;
            document.getElementById('deleteTurmaAlunos').textContent = totalAlunos;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteTurmaModal'));
            modal.show();
        }
        
        // Adicionar haptic feedback em dispositivos m√≥veis
        document.querySelectorAll('.turma-card, .btn').forEach(element => {
            element.addEventListener('touchstart', function() {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        });
        

        // === SCROLL PRESERVATION ===
        // const turmaName = "";
        const scrollStorageKey = "turmasScrollPosition";        
        // Restaurar posi√ß√£o de scroll ao carregar a p√°gina
        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem(scrollStorageKey);
            if (savedPosition) {
                const position = parseInt(savedPosition, 10);
                if (!isNaN(position)) {
                    // Aguardar um pouco para garantir que a p√°gina carregou completamente
                    setTimeout(() => {
                        window.scrollTo({
                            top: position,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
        }
        
        // Salvar posi√ß√£o de scroll antes de sair da p√°gina
        function saveScrollPosition() {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            localStorage.setItem(scrollStorageKey, scrollPosition.toString());
        }



// Salvar scroll em v√°rios eventos de sa√≠da
        window.addEventListener('beforeunload', saveScrollPosition);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um link for clicado
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && !link.classList.contains('stay-on-page')) {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um formul√°rio for submetido
        document.addEventListener('submit', function(e) {
            saveScrollPosition();
        });
        
        // Restaurar posi√ß√£o ao carregar
        document.addEventListener('DOMContentLoaded', restoreScrollPosition);
        
        // Limpar posi√ß√£o salva ap√≥s 1 hora (para evitar acumula√ß√£o)
        setTimeout(() => {
            localStorage.removeItem(scrollStorageKey);
        }, 3600000); // 1 hora

        // Fun√ß√£o para converter UTC para timezone local
        function formatLocalDateTime(utcDateString) {
            if (!utcDateString) return 'N/A';
            
            try {
                // Parse da data UTC
                const utcDate = new Date(utcDateString + 'Z'); // Adicionar Z para indicar UTC
                
                // Formatar para o timezone local
                return utcDate.toLocaleString('pt-PT', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('Erro ao formatar data:', error);
                return 'Data inv√°lida';
            }
        }

        // Converter todas as datas UTC para timezone local quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            const lastUpdatedElements = document.querySelectorAll('.last-updated-utc');
            lastUpdatedElements.forEach(element => {
                const utcDate = element.dataset.utcDate;
                element.textContent = formatLocalDateTime(utcDate);
            });
        });

        
    </script>
</body>
</html>