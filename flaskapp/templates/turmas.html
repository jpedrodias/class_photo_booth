<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Class Photo Booth - Turmas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2b2b2b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Class Photo Booth">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='student_icon.jpg') }}">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <span class="display-6 me-2">üìö</span>
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div class="fw-bold">Class Photo Booth</div>
                    <!-- Bot√µes de navega√ß√£o -->
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button onclick="addTurma()" class="btn btn-light btn-sm rounded-pill px-3" title="Nova Turma">
                    <i class="bi bi-plus-circle me-1"></i>
                    <span class="d-none d-md-inline">Nova</span>
                </button>
                <a href="/settings" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Configura√ß√µes">
                    <i class="bi bi-gear me-1"></i>
                    <span class="d-none d-md-inline">Config</span>
                </a>
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    {% if turmas|length > 0 %}
    <div class="container">
        <div class="stats-card">
            <div class="stats-number" id="visibleTurmasCount">{{ turmas|length }}</div>
            <div class="stats-label">Turma{{ 's' if turmas|length != 1 else '' }} Dispon√≠v{{ 'eis' if turmas|length != 1 else 'el' }}</div>
            
            <!-- Filtros -->
            <div class="row g-2 mt-3 mb-3">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="toggleAllTurmas" onclick="toggleAllTurmas()">
                                <i class="bi bi-eye-fill" id="toggleAllIcon"></i>
                                <span id="toggleAllText">Ocultar Todas</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilterMenu()">
                                <i class="bi bi-funnel-fill"></i>
                                Filtros
                            </button>
                        </div>
                        <div class="text-muted small">
                            <i class="bi bi-eye me-1"></i>
                            <span id="filteredCount">{{ turmas|length }}</span> de {{ turmas|length }} turmas
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu de filtros (inicialmente oculto) -->
            <div class="collapse" id="filterMenu">
                <div class="card card-body mb-3">
                    <div class="row g-2">
                        <div class="col-12">
                            <label class="form-label fw-bold mb-2">Selecionar turmas a mostrar:</label>
                        </div>
                        <div class="col-12" id="turmaFilterList">
                            <!-- Os switches ser√£o gerados dinamicamente por JavaScript -->
                        </div>
                        <div class="col-12 mt-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="selectAllTurmas()">
                                    <i class="bi bi-check-all"></i> Selecionar Todas
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deselectAllTurmas()">
                                    <i class="bi bi-x-square"></i> Deselecionar Todas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contagem de alunos e fotos -->
            <div class="d-flex justify-content-between text-muted small mt-3 mb-2">
                <span><span id="visibleAlunosCount">{{ total_alunos_geral }}</span> aluno{{ 's' if total_alunos_geral != 1 else '' }}</span>
                <span><span id="visibleFotosCount">{{ total_fotos_geral }}</span> foto{{ 's' if total_fotos_geral != 1 else '' }}</span>
            </div>
            
            <!-- Barra de progresso geral -->
            {% set percentage_geral = (total_fotos_geral / total_alunos_geral * 100) if total_alunos_geral > 0 else 0 %}
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted">Progresso Geral</small>
                    <small class="fw-bold" id="progressPercentage">
                        {{ "%.0f"|format(percentage_geral) }}%
                    </small>
                </div>
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar" id="progressBar"
                         role="progressbar" 
                         style="width: {{ percentage_geral }}%;" 
                         aria-valuenow="{{ percentage_geral }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-3" id="turmasContainer">
            {% for turma in turmas %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-3 turma-item" data-turma-id="{{ turma.id }}" data-turma-nome="{{ turma.nome }}" data-alunos="{{ turma.total_alunos }}" data-fotos="{{ turma.alunos_com_foto }}">
                <div class="turma-card h-100" style="cursor: pointer;">
                    {% if turma.total_alunos > 0 and turma.alunos_com_foto == turma.total_alunos %}
                    <div class="turma-completed-status">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    {% endif %}
                
                <a href="{{ url_for('turma', nome_seguro=turma.nome_seguro) }}" class="text-decoration-none text-dark">
                    <div class="turma-icon">üéì</div>
                    <h5 class="fw-bold mb-3">
                        {{ turma.nome }} 
                        {% if turma.nome_professor %} - {{ turma.nome_professor }}
                        {% endif %}
                    </h5>

                    <div class="d-flex justify-content-between text-muted small mb-2">
                        <span>{{ turma.total_alunos }} aluno{{ 's' if turma.total_alunos != 1 else '' }}</span>
                        <span>{{ turma.alunos_com_foto }} foto{{ 's' if turma.alunos_com_foto != 1 else '' }}</span>
                    </div>
                    
                    <!-- Barra de progresso -->
                    {% set percentage = (turma.alunos_com_foto / turma.total_alunos * 100) if turma.total_alunos > 0 else 0 %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted">Progresso</small>
                            <small class="fw-bold text-{% if percentage == 100 %}success{% elif percentage >= 75 %}info{% elif percentage >= 50 %}warning{% else %}danger{% endif %}">
                                {{ "%.0f"|format(percentage) }}%
                            </small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-{% if percentage == 100 %}success{% elif percentage >= 75 %}info{% elif percentage >= 50 %}warning{% else %}danger{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ percentage }}%;" 
                                 aria-valuenow="{{ percentage }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </a>
                
                <div class="d-flex gap-2 mt-auto">
                    <button type="button" class="btn btn-sm btn-outline-primary flex-fill edit-turma-btn" 
                            data-turma-id="{{ turma.id }}"
                            data-turma-nome="{{ turma.nome }}"
                            data-nome-professor="{{ turma.nome_professor | default('') }}"
                            data-email-professor="{{ turma.email_professor | default('') }}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger flex-fill" 
                            onclick="deleteTurma({{ turma.id }}, '{{ turma.nome }}', {{ turma.total_alunos }})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <!-- √öltima atualiza√ß√£o -->
                {% if turma.last_updated %}
                <div class="text-muted small mb-2 text-secondary">
                    <i class="bi bi-clock me-1"></i>
                    <span>atualiza√ß√£o: </span>
                    <span class="last-updated-utc" data-utc-date="{{ turma.last_updated.strftime('%Y-%m-%d %H:%M:%S') if turma.last_updated else '' }}">
                        {{ turma.last_updated.strftime('%Y-%m-%d %H:%M:%S') if turma.last_updated else 'N/A' }}
                    </span>
                </div>
                {% endif %}


            </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="container">
        <div class="text-center py-4 mb-4">
            <div class="display-1 mb-3">ÔøΩ</div>
            <h3 class="mb-3">Nenhuma turma encontrada</h3>
            <p class="text-muted">Comece por criar a sua primeira turma ou carregue dados via CSV.</p>
        </div>
        
        <div class="row g-4 justify-content-center">
            <!-- Cart√£o para criar primeira turma -->
            <div class="col-6 col-md-4 col-lg-3">
                <div class="turma-card h-100" style="cursor: pointer; border: 2px dashed #4a5eaa;" onclick="addTurma()">
                    <div class="text-center">
                        <div class="display-4 mb-3 text-primary">‚ûï</div>
                        <h5 class="fw-bold mb-3 text-primary">Criar a primeira turma</h5>
                        <p class="text-muted small">Adicione uma nova turma manualmente</p>
                    </div>
                </div>
            </div>
            
            <!-- Cart√£o para carregar via CSV -->
            <div class="col-6 col-md-4 col-lg-3">
                <div class="turma-card h-100" style="cursor: pointer; border: 2px dashed #28a745;" onclick="window.location.href='/settings'">
                    <div class="text-center">
                        <div class="display-4 mb-3 text-success">üìä</div>
                        <h5 class="fw-bold mb-3 text-success">Carregar turmas via CSV</h5>
                        <p class="text-muted small">Importe dados de um ficheiro CSV</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Mobile action buttons -->
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-4">
                    <button onclick="addTurma()" class="btn btn-primary w-100 mobile-btn-inline">
                        <i class="bi bi-plus-circle"></i>
                        <small>Turma</small>
                    </button>
                </div>
                <div class="col-4">
                    <a href="/settings" class="btn btn-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-gear"></i>
                        <small>Config.</small>
                    </a>
                </div>
                <div class="col-4">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para adicionar turma -->
    <div class="modal fade" id="addTurmaModal" tabindex="-1" aria-labelledby="addTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addTurmaModalLabel">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Nova Turma
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="addTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_add_new">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addTurmaNome" class="form-label">Nome da Turma</label>
                            <input type="text" class="form-control" id="addTurmaNome" name="nome" required 
                                   placeholder="Ex: 5A, 10¬∫ B, Matem√°tica..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="addTurmaProfessor" class="form-label">Professor Respons√°vel</label>
                            <input type="text" class="form-control" id="addTurmaProfessor" name="nome_professor" 
                                   placeholder="Nome do professor respons√°vel pela turma..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="addTurmaEmailProfessor" class="form-label">Email do Professor</label>
                            <input type="email" class="form-control" id="addTurmaEmailProfessor" name="email_professor" 
                                   placeholder="Email do professor respons√°vel (opcional)..." maxlength="255">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Criar Turma
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar turma -->
    <div class="modal fade" id="editTurmaModal" tabindex="-1" aria-labelledby="editTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTurmaModalLabel">
                        <i class="bi bi-pencil me-2"></i>Editar Turma
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="editTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_edit">
                    <input type="hidden" name="turma_id" id="editTurmaId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editTurmaNome" class="form-label">Nome da Turma</label>
                            <input type="text" class="form-control" id="editTurmaNome" name="nome" required 
                                   placeholder="Ex: 5A, 10¬∫ B, Matem√°tica..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="editTurmaProfessor" class="form-label">Professor Respons√°vel</label>
                            <input type="text" class="form-control" id="editTurmaProfessor" name="nome_professor" 
                                   placeholder="Nome do professor respons√°vel pela turma..." maxlength="100">
                        </div>
                        <div class="mb-3">
                            <label for="editTurmaEmailProfessor" class="form-label">Email do Professor</label>
                            <input type="email" class="form-control" id="editTurmaEmailProfessor" name="email_professor" 
                                   placeholder="Email do professor respons√°vel (opcional)..." maxlength="255">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-pencil me-1"></i>Guardar Altera√ß√µes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar elimina√ß√£o de turma -->
    <div class="modal fade" id="deleteTurmaModal" tabindex="-1" aria-labelledby="deleteTurmaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteTurmaModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirmar Elimina√ß√£o
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('turma_crud') }}" method="post" id="deleteTurmaForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="crud_turma_delete">
                    <input type="hidden" name="turma_id" id="deleteTurmaId">
                    <div class="modal-body">
                        <p class="mb-3">
                            <strong>Tem certeza que deseja eliminar a turma "<span id="deleteTurmaNome"></span>"?</strong>
                        </p>
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Aten√ß√£o:</strong> Esta a√ß√£o ir√° eliminar:
                            <ul class="mb-0 mt-2">
                                <li>A turma e todos os seus <span id="deleteTurmaAlunos"></span> alunos</li>
                                <li>Todas as fotos associadas √† turma</li>
                            </ul>
                        </div>
                        <p class="text-muted mb-0">
                            <small><i class="bi bi-info-circle me-1"></i>Esta a√ß√£o n√£o pode ser desfeita.</small>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-1"></i>Eliminar Turma
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // === FILTROS DE TURMAS ===
        let turmaFilterState = {
            showAll: true,
            visibleTurmas: new Set(),
            initialized: false
        };
        
        // Carrega filtros - tenta do servidor primeiro, depois localStorage
        async function loadTurmaFilters() {
            try {
                // Tentar carregar do servidor primeiro
                const response = await fetch("{{ url_for('get_turma_filters') }}", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // console.log('Filtros carregados do servidor:', data);
                    
                    // Converter Array para Set
                    turmaFilterState = {
                        showAll: data.showAll !== undefined ? data.showAll : true,
                        visibleTurmas: new Set(data.visibleTurmas || []),
                        initialized: true
                    };
                    
                    // Verificar se as turmas salvas ainda existem na p√°gina
                    validateAndApplyFilters();
                    return;
                }
            } catch (error) {
                console.log('Servidor n√£o dispon√≠vel, tentando localStorage:', error);
            }
            
            // Fallback para localStorage
            try {
                const savedFilters = localStorage.getItem('turmaFilters');
                if (savedFilters) {
                    const data = JSON.parse(savedFilters);
                    
                    // Verificar se os filtros n√£o s√£o muito antigos (7 dias)
                    const daysSinceLastSave = (Date.now() - (data.timestamp || 0)) / (1000 * 60 * 60 * 24);
                    if (daysSinceLastSave > 7) {
                        // console.log('Filtros salvos s√£o muito antigos, inicializando padr√£o');
                        localStorage.removeItem('turmaFilters');
                        initializeDefaultFilters();
                        return;
                    }
                    
                    // console.log('Filtros carregados do localStorage:', data);
                    
                    // Converter Array para Set
                    turmaFilterState = {
                        showAll: data.showAll !== undefined ? data.showAll : true,
                        visibleTurmas: new Set(data.visibleTurmas || []),
                        initialized: true
                    };
                    
                    validateAndApplyFilters();
                } else {
                    // console.log('Nenhum filtro salvo encontrado, inicializando padr√£o');
                    initializeDefaultFilters();
                }
            } catch (error) {
                console.log('Erro ao carregar filtros, usando padr√£o:', error);
                initializeDefaultFilters();
            }
        }
        
        // Valida e aplica filtros carregados
        function validateAndApplyFilters() {
            // Verificar se as turmas salvas ainda existem na p√°gina
            const currentTurmaIds = new Set();
            document.querySelectorAll('.turma-item').forEach(item => {
                currentTurmaIds.add(item.dataset.turmaId);
            });
            
            // Filtrar turmas que n√£o existem mais
            const validVisibleTurmas = new Set();
            turmaFilterState.visibleTurmas.forEach(turmaId => {
                if (currentTurmaIds.has(turmaId)) {
                    validVisibleTurmas.add(turmaId);
                }
            });
            turmaFilterState.visibleTurmas = validVisibleTurmas;
            
            // Se n√£o h√° turmas vis√≠veis e showAll √© false, inicializar com padr√£o
            if (!turmaFilterState.showAll && turmaFilterState.visibleTurmas.size === 0) {
                // console.log('Estado inv√°lido detectado, inicializando padr√£o');
                initializeDefaultFilters();
                return;
            }
            
            // console.log('Aplicando filtros carregados:', turmaFilterState);
            applyFilters();
        }
        
        // Salva filtros - tenta no servidor primeiro, depois localStorage
        async function saveTurmaFilters() {
            const dataToSave = {
                showAll: turmaFilterState.showAll,
                visibleTurmas: Array.from(turmaFilterState.visibleTurmas),
                timestamp: Date.now()
            };
            
            console.log('Salvando filtros:', dataToSave);
            
            // Tentar salvar no servidor primeiro
            try {
                const response = await fetch("{{ url_for('save_turma_filters') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSave)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // console.log('Filtros salvos no servidor:', result);
                    
                    // Tamb√©m salvar no localStorage como backup
                    localStorage.setItem('turmaFilters', JSON.stringify(dataToSave));
                    
                    showFilterSavedFeedback('Filtros salvos no servidor');
                    return;
                }
            } catch (error) {
                console.log('Erro ao salvar no servidor, usando localStorage:', error);
            }
            
            // Fallback para localStorage
            try {
                localStorage.setItem('turmaFilters', JSON.stringify(dataToSave));
                // console.log('Filtros salvos no localStorage');
                showFilterSavedFeedback('Filtros salvos localmente');
            } catch (error) {
                console.error('Erro ao salvar filtros:', error);
            }
        }
        
        // Mostra feedback visual quando filtros s√£o salvos
        function showFilterSavedFeedback(message = 'Filtros salvos automaticamente') {
            // Criar elemento de feedback se n√£o existir
            let feedback = document.getElementById('filterSavedFeedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'filterSavedFeedback';
                feedback.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-success alert-dismissible fade';
                feedback.style.zIndex = '9999';
                document.body.appendChild(feedback);
            }
            
            // Atualizar conte√∫do
            feedback.innerHTML = `
                <i class="bi bi-check-circle-fill me-2"></i>
                ${message}
            `;
            
            // Mostrar feedback
            feedback.classList.add('show');
            
            // Esconder ap√≥s 2 segundos
            setTimeout(() => {
                if (feedback) {
                    feedback.classList.remove('show');
                }
            }, 2000);
        }
        
        // Inicializa filtros com todas as turmas vis√≠veis
        function initializeDefaultFilters() {
            const turmaItems = document.querySelectorAll('.turma-item');
            turmaFilterState.visibleTurmas = new Set();
            turmaItems.forEach(item => {
                turmaFilterState.visibleTurmas.add(item.dataset.turmaId);
            });
            turmaFilterState.showAll = true;
            turmaFilterState.initialized = true;
            // console.log('Filtros inicializados com padr√£o:', turmaFilterState);
            applyFilters(); // Aplicar filtros ap√≥s inicializar
        }
        
        // Gera lista de checkboxes para filtros
        function generateFilterList() {
            const filterList = document.getElementById('turmaFilterList');
            const turmaItems = document.querySelectorAll('.turma-item');
            
            filterList.innerHTML = '';
            
            // Criar container de grade para organizar chips em colunas
            const gridContainer = document.createElement('div');
            gridContainer.className = 'row g-2';
            
            turmaItems.forEach(item => {
                const turmaId = item.dataset.turmaId;
                const turmaNome = item.dataset.turmaNome;
                const isChecked = turmaFilterState.visibleTurmas.has(turmaId);
                
                // Criar coluna responsiva para cada chip
                const colDiv = document.createElement('div');
                colDiv.className = 'col-6 col-sm-4 col-md-3 col-lg-2';
                
                const chipHtml = `
                    <label class="turma-filter-chip ${isChecked ? 'selected' : ''}" for="turma-${turmaId}">
                        <input type="checkbox" id="turma-${turmaId}" 
                               ${isChecked ? 'checked' : ''} 
                               onchange="toggleTurmaVisibility('${turmaId}')"
                               style="display: none;">
                        <span class="chip-icon">
                            <i class="bi ${isChecked ? 'bi-check-circle-fill' : 'bi-circle'}"></i>
                        </span>
                        <span class="chip-text">${turmaNome}</span>
                    </label>
                `;
                
                colDiv.innerHTML = chipHtml;
                gridContainer.appendChild(colDiv);
            });
            
            filterList.appendChild(gridContainer);
        }
        
        // Aplica filtros √†s turmas
        function applyFilters() {
            const turmaItems = document.querySelectorAll('.turma-item');
            let visibleCount = 0;
            let totalAlunos = 0;
            let totalFotos = 0;
            
            turmaItems.forEach(item => {
                const turmaId = item.dataset.turmaId;
                const shouldShow = turmaFilterState.showAll || turmaFilterState.visibleTurmas.has(turmaId);
                
                if (shouldShow) {
                    item.style.display = '';
                    visibleCount++;
                    totalAlunos += parseInt(item.dataset.alunos || 0);
                    totalFotos += parseInt(item.dataset.fotos || 0);
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Atualizar contadores
            updateCounters(visibleCount, totalAlunos, totalFotos);
            
            // Atualizar bot√£o toggle
            updateToggleButton();
            
            // Regenerar lista de filtros
            generateFilterList();
        }
        
        // Atualiza contadores na interface
        function updateCounters(visibleCount, totalAlunos, totalFotos) {
            document.getElementById('visibleTurmasCount').textContent = visibleCount;
            document.getElementById('filteredCount').textContent = visibleCount;
            document.getElementById('visibleAlunosCount').textContent = totalAlunos;
            document.getElementById('visibleFotosCount').textContent = totalFotos;
            
            // Atualizar barra de progresso
            const percentage = totalAlunos > 0 ? Math.round((totalFotos / totalAlunos) * 100) : 0;
            document.getElementById('progressPercentage').textContent = percentage + '%';
            
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            
            // Atualizar classe da barra de progresso
            progressBar.className = 'progress-bar ';
            if (percentage === 100) {
                progressBar.className += 'bg-success';
                document.getElementById('progressPercentage').className = 'fw-bold text-success';
            } else if (percentage >= 75) {
                progressBar.className += 'bg-info';
                document.getElementById('progressPercentage').className = 'fw-bold text-info';
            } else if (percentage >= 50) {
                progressBar.className += 'bg-warning';
                document.getElementById('progressPercentage').className = 'fw-bold text-warning';
            } else {
                progressBar.className += 'bg-danger';
                document.getElementById('progressPercentage').className = 'fw-bold text-danger';
            }
        }
        
        // Atualiza bot√£o de toggle
        function updateToggleButton() {
            const toggleButton = document.getElementById('toggleAllTurmas');
            const toggleIcon = document.getElementById('toggleAllIcon');
            const toggleText = document.getElementById('toggleAllText');
            
            if (turmaFilterState.showAll) {
                toggleIcon.className = 'bi bi-eye-slash-fill';
                toggleText.textContent = 'Ocultar Todas';
                toggleButton.className = 'btn btn-sm btn-outline-danger';
            } else {
                toggleIcon.className = 'bi bi-eye-fill';
                toggleText.textContent = 'Mostrar Todas';
                toggleButton.className = 'btn btn-sm btn-outline-success';
            }
        }
        
        // Toggle mostrar/ocultar todas as turmas
        function toggleAllTurmas() {
            turmaFilterState.showAll = !turmaFilterState.showAll;
            applyFilters();
            saveTurmaFilters();
        }
        
        // Toggle menu de filtros
        function toggleFilterMenu() {
            const filterMenu = document.getElementById('filterMenu');
            const bsCollapse = new bootstrap.Collapse(filterMenu, {
                toggle: true
            });
        }
        
        // Toggle visibilidade de uma turma espec√≠fica
        function toggleTurmaVisibility(turmaId) {
            const chip = document.querySelector(`label[for="turma-${turmaId}"]`);
            const icon = chip.querySelector('.chip-icon i');
            
            if (turmaFilterState.visibleTurmas.has(turmaId)) {
                turmaFilterState.visibleTurmas.delete(turmaId);
                // Atualizar visual do chip
                chip.classList.remove('selected');
                icon.className = 'bi bi-circle';
            } else {
                turmaFilterState.visibleTurmas.add(turmaId);
                // Atualizar visual do chip
                chip.classList.add('selected');
                icon.className = 'bi bi-check-circle-fill';
            }
            
            // Se todas est√£o selecionadas, ativar showAll
            const totalTurmas = document.querySelectorAll('.turma-item').length;
            if (turmaFilterState.visibleTurmas.size === totalTurmas) {
                turmaFilterState.showAll = true;
            } else {
                turmaFilterState.showAll = false;
            }
            
            applyFilters();
            saveTurmaFilters();
        }
        
        // Selecionar todas as turmas
        function selectAllTurmas() {
            const turmaItems = document.querySelectorAll('.turma-item');
            turmaFilterState.visibleTurmas = new Set();
            turmaItems.forEach(item => {
                turmaFilterState.visibleTurmas.add(item.dataset.turmaId);
            });
            turmaFilterState.showAll = true;
            
            // Atualizar visual de todos os chips
            document.querySelectorAll('.turma-filter-chip').forEach(chip => {
                chip.classList.add('selected');
                const icon = chip.querySelector('.chip-icon i');
                icon.className = 'bi bi-check-circle-fill';
                const checkbox = chip.querySelector('input[type="checkbox"]');
                checkbox.checked = true;
            });
            
            applyFilters();
            saveTurmaFilters();
        }
        
        // Deselecionar todas as turmas
        function deselectAllTurmas() {
            turmaFilterState.visibleTurmas = new Set();
            turmaFilterState.showAll = false;
            
            // Atualizar visual de todos os chips
            document.querySelectorAll('.turma-filter-chip').forEach(chip => {
                chip.classList.remove('selected');
                const icon = chip.querySelector('.chip-icon i');
                icon.className = 'bi bi-circle';
                const checkbox = chip.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
            });
            
            applyFilters();
            saveTurmaFilters();
        }
        
        // === RESTO DO C√ìDIGO EXISTENTE ===
        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = '/logout';
            }
        }
        
        // Fun√ß√£o para adicionar nova turma
        function addTurma() {
            const modal = new bootstrap.Modal(document.getElementById('addTurmaModal'));
            document.getElementById('addTurmaNome').value = '';
            modal.show();
        }
        
        // Fun√ß√£o para editar turma
        // Event listeners para bot√µes de editar turma
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.edit-turma-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const turmaId = this.dataset.turmaId;
                    const turmaNome = this.dataset.turmaNome;
                    const nomeProfessor = this.dataset.nomeProfessor;
                    const emailProfessor = this.dataset.emailProfessor;
                    
                    editTurma(turmaId, turmaNome, nomeProfessor, emailProfessor);
                });
            });
        });

        function editTurma(turmaId, turmaNome, nomeProfessor, emailProfessor) {
            document.getElementById('editTurmaId').value = turmaId;
            document.getElementById('editTurmaNome').value = turmaNome;
            document.getElementById('editTurmaProfessor').value = nomeProfessor || '';
            document.getElementById('editTurmaEmailProfessor').value = emailProfessor || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editTurmaModal'));
            modal.show();
        }
        
        // Fun√ß√£o para confirmar elimina√ß√£o de turma
        function deleteTurma(turmaId, turmaNome, totalAlunos) {
            document.getElementById('deleteTurmaId').value = turmaId;
            document.getElementById('deleteTurmaNome').textContent = turmaNome;
            document.getElementById('deleteTurmaAlunos').textContent = totalAlunos;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteTurmaModal'));
            modal.show();
        }
        
        // Adicionar haptic feedback em dispositivos m√≥veis
        document.querySelectorAll('.turma-card, .btn').forEach(element => {
            element.addEventListener('touchstart', function() {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        });
        

        // === SCROLL PRESERVATION ===
        // const turmaName = "";
        const scrollStorageKey = "turmasScrollPosition";        
        // Restaurar posi√ß√£o de scroll ao carregar a p√°gina
        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem(scrollStorageKey);
            if (savedPosition) {
                const position = parseInt(savedPosition, 10);
                if (!isNaN(position)) {
                    // Aguardar um pouco para garantir que a p√°gina carregou completamente
                    setTimeout(() => {
                        window.scrollTo({
                            top: position,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
        }
        
        // Salvar posi√ß√£o de scroll antes de sair da p√°gina
        function saveScrollPosition() {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            localStorage.setItem(scrollStorageKey, scrollPosition.toString());
        }



// Salvar scroll em v√°rios eventos de sa√≠da
        window.addEventListener('beforeunload', saveScrollPosition);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um link for clicado
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && !link.classList.contains('stay-on-page')) {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um formul√°rio for submetido
        document.addEventListener('submit', function(e) {
            saveScrollPosition();
        });
        
        // Restaurar posi√ß√£o ao carregar
        document.addEventListener('DOMContentLoaded', restoreScrollPosition);
        
        // Limpar posi√ß√£o salva ap√≥s 1 hora (para evitar acumula√ß√£o)
        setTimeout(() => {
            localStorage.removeItem(scrollStorageKey);
        }, 3600000); // 1 hora

        // Fun√ß√£o para converter UTC para timezone local
        function formatLocalDateTime(utcDateString) {
            if (!utcDateString) return 'N/A';
            
            try {
                // Parse da data UTC
                const utcDate = new Date(utcDateString + 'Z'); // Adicionar Z para indicar UTC
                
                // Formatar para o timezone local
                return utcDate.toLocaleString('pt-PT', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('Erro ao formatar data:', error);
                return 'Data inv√°lida';
            }
        }

        // Converter todas as datas UTC para timezone local quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            const lastUpdatedElements = document.querySelectorAll('.last-updated-utc');
            lastUpdatedElements.forEach(element => {
                const utcDate = element.dataset.utcDate;
                element.textContent = formatLocalDateTime(utcDate);
            });
        });

        
        // === INICIALIZA√á√ÉO ===
        document.addEventListener('DOMContentLoaded', function() {
            //console.log('DOM carregado, inicializando filtros...');
            
            // Carregar filtros salvos
            loadTurmaFilters();
            
            // Fallback: aplicar filtros ap√≥s pequeno delay para garantir que funcionem
            setTimeout(() => {
                if (!turmaFilterState.initialized) {
                    // console.log('Filtros n√£o foram inicializados, for√ßando inicializa√ß√£o padr√£o...');
                    initializeDefaultFilters();
                } else {
                    // console.log('Reaplicando filtros como fallback...');
                    applyFilters();
                }
            }, 500);
            
            // Configurar listeners para expans√£o/contra√ß√£o de turmas
            const expandButtons = document.querySelectorAll('.btn-expand-turma');
            expandButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const turmaId = this.getAttribute('data-turma-id');
                    const turmaContent = document.getElementById('turma-content-' + turmaId);
                    const icon = this.querySelector('i');
                    
                    if (turmaContent.classList.contains('collapse')) {
                        turmaContent.classList.remove('collapse');
                        icon.classList.remove('bi-chevron-down');
                        icon.classList.add('bi-chevron-up');
                    } else {
                        turmaContent.classList.add('collapse');
                        icon.classList.remove('bi-chevron-up');
                        icon.classList.add('bi-chevron-down');
                    }
                });
            });
        });
    </script>

    <script>
    /**
    * Controla o comportamento do bot√£o "Voltar" no ecr√£ /turmas:
    *  - 1¬∫ back ‚Üí mostra aviso e bloqueia sa√≠da
    *  - 2¬∫ back (‚â§2s) ‚Üí permite sair (fecha PWA ou volta atr√°s)
    */

    let lastBackTime = 0;
    let isArming = false;

    /**
    * Mostra uma notifica√ß√£o (toast) simples no ecr√£
    */
    function showToast(message) {
    let toast = document.getElementById('backToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'backToast';
        toast.style.cssText = `
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 9999;
        `;
        document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => {
        toast.style.opacity = '0';
    }, 1400);
    }

    /**
    * Adiciona uma entrada falsa ao hist√≥rico para capturar o bot√£o "Voltar"
    */
    function armHistoryTrap() {
    history.pushState({ trap: true }, document.title, location.href);
    }

    /**
    * Lida com o evento de retrocesso (popstate)
    */
    function handlePopState() {
    if (isArming) return;

    const now = Date.now();
    const isSecondBack = now - lastBackTime < 2000;

    if (isSecondBack) {
        // Segunda vez ‚Üí permite o comportamento normal do browser
        return;
    }

    // Primeira vez ‚Üí intercepta, mostra aviso e reconfigura hist√≥rico
    lastBackTime = now;
    isArming = true;
    armHistoryTrap();
    isArming = false;
    showToast('Prima voltar novamente para sair');
    }

    /**
    * Remove o listener ao sair da p√°gina
    */
    function cleanupBackButtonHandler() {
    window.removeEventListener('popstate', handlePopState);
    }

    /**
    * Inicializa o comportamento no ecr√£ /turmas
    */
    function init() {
    const isOnTurmas = location.pathname.includes('/turmas');
    if (!isOnTurmas) return;

    // Arma o hist√≥rico e adiciona listener
    armHistoryTrap();
    window.addEventListener('popstate', handlePopState);
    window.addEventListener('beforeunload', cleanupBackButtonHandler);
    }

    // Inicializa no carregamento da p√°gina
    window.addEventListener('load', init);
    </script>

</body>
</html>