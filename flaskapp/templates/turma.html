<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Turma {{ current_turma.nome }} - Class Photo Booth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2b2b2b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Class Photo Booth">
    <link rel="apple-touch-icon" sizes="192x192" href="{{ url_for('static', filename='student_icon.jpg') }}">
</head>
<body class="turma-page">
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3 fixed-top">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center"  
                onclick="location.href='{{ url_for('index') }}'"
                style="cursor: pointer;">
                <span class="display-6 me-2">🎓</span>
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div class="fw-bold">Turma {{ current_turma.nome }}</div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <a href="{{ url_for('turmas') }}" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Voltar">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-md-inline">Voltar</span>
                </a>
                
                <div class="dropdown">
                    <button class="btn btn-light btn-sm rounded-pill px-3 dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Download">
                        <i class="bi bi-download me-1"></i>
                        <span class="d-none d-md-inline">Download</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="downloadDropdown">
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.zip') }}">
                            <i class="bi bi-file-earmark-zip me-2 text-primary"></i> {{ current_turma.nome_seguro }}.zip
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.thumbs.zip') }}">
                            <i class="bi bi-file-earmark-zip-fill me-2 text-info"></i> {{ current_turma.nome_seguro }}.thumbs.zip
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.docx') }}">
                            <i class="bi bi-file-earmark-word me-2 text-success"></i> {{ current_turma.nome_seguro }}.docx
                        </a></li>
                    </ul>
                </div>
                
                {% if current_user.role in ['editor', 'admin'] %}
                <button onclick="openNotificationModal()" class="btn btn-info btn-sm rounded-pill px-3" title="Notificar Professor">
                    <i class="bi bi-envelope me-1"></i>
                    <span class="d-none d-md-inline">Notificar</span>
                </button>
                {% else %}
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
                {% endif %}
            </div>
        </div>
    </nav>
    
    <!-- Espaço para compensar navbar fixo -->
    <div class="navbar-spacer"></div>

    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main class="container my-4 mb-md-5 mb-lg-4">
        <div class="row g-3">
            <!-- Card para adicionar novo aluno -->
            {% if current_user.role in ['editor', 'admin'] %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-3">
                <div class="student-card text-center h-100 cursor-pointer" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <div class="student-photo">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-person-plus-fill text-primary add-student-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-bold text-primary mb-1">Adicionar Aluno</h6>
                    <small class="text-muted">Novo aluno</small>
                </div>
                </div>
            </div>
            {% endif %}
        
        {% for aluno in alunos %}
        <div class="col-6 col-md-4 col-lg-3 col-xl-3">
            {% if current_user.role in ['editor', 'admin'] %}
            <div class="student-card h-100" 
                data-aluno-id="{{ aluno.id }}" 
                data-aluno-nome="{{ aluno.nome }}" 
                data-aluno-processo="{{ aluno.processo }}"
                ondragover="event.preventDefault(); this.classList.add('dragover');" 
                ondragleave="this.classList.remove('dragover');" 
                ondrop="handleStudentCardDrop(event, this);">
            {% else %}
            <div class="student-card h-100 cursor-default"
                data-aluno-id="{{ aluno.id }}" data-aluno-nome="{{ aluno.nome }}" data-aluno-processo="{{ aluno.processo }}"
                ondragover="event.preventDefault(); this.classList.add('dragover');" 
                ondragleave="this.classList.remove('dragover');" 
                ondrop="handleStudentCardDrop(event, this);">
            {% endif %}
                <div class="student-photo position-relative">

                    {% if aluno.foto_existe or aluno.foto_tirada %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <img src="{{ url_for('get_photo', folder_name=current_turma.nome_seguro, processo=aluno.processo) }}" 
                             alt="Foto de {{ aluno.nome }}" 
                             class="photo-img cursor-pointer"
                             onclick="goToCapturePhoto('{{ aluno.processo }}')">
                        {% else %}
                        <img src="{{ url_for('get_photo', folder_name=current_turma.nome_seguro, processo=aluno.processo) }}" 
                             alt="Foto de {{ aluno.nome }}" 
                             class="photo-img">
                        {% endif %}
                        
                        <!-- Ícone de foto recente (canto superior esquerdo) -->
                        {% if aluno.foto_tirada %}
                            {% if aluno.autorizacao %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge success" 
                             title="Foto tirada - Autorização concedida">
                            <i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>
                        </div>
                            {% else %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge danger" 
                             title="Foto tirada - Autorização NÃO concedida">
                            <i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>
                        </div>
                            {% endif %}
                        {% else %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge warning" 
                             title="Foto não tirada">
                            <i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>
                        </div>
                        {% endif %}
                        
                        {% if current_user.role in ['editor', 'admin'] %}
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle remove-photo-btn photo-remove-btn" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#removePhotoModal"
                            title="Clique para remover a foto"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-x photo-status-icon-xs"></i>
                        </button>
                        {% endif %}
                    {% else %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <img src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Sem foto" 
                             class="photo-img placeholder cursor-pointer"
                             onclick="goToCapturePhoto('{{ aluno.processo }}')">
                        {% else %}
                        <img src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Sem foto" 
                             class="photo-img placeholder">
                        {% endif %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-1 rounded-circle photo-remove-btn" 
                            title="Clique para tirar foto"
                            onclick="event.stopPropagation(); goToCapturePhoto('{{ aluno.processo }}');">
                            <i class="bi bi-camera photo-status-icon-xs"></i>
                        </button>
                        {% endif %}
                    {% endif %}
                    
                    <!-- Ícone de notas (canto inferior esquerdo da imagem) - só aparece se há notas -->
                    {% if aluno.notes and aluno.notes.strip() %}
                    <button class="btn btn-sm btn-info notes-toggle-btn notes-btn-on-image" 
                            data-aluno-id="{{ aluno.id }}"
                            title="Mostrar notas do aluno"
                            onclick="event.stopPropagation(); toggleStudentNotes({{ aluno.id }});">
                        <i class="bi bi-pencil-fill text-white notes-icon-xs"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="student-info">
                    <div class="student-name">{{ aluno.nome }} </div>
                    <div class="student-number">
                        {% if aluno.numero %}
                            Nº {{ aluno.numero }} • Proc. {{ aluno.processo }}
                        {% else %}
                            Proc. {{ aluno.processo }}
                        {% endif %}
                    </div>
                    
                    <!-- Área para mostrar notas (oculta por padrão) -->
                    <div class="student-notes mt-1" id="notes-{{ aluno.id }}" style="display: none;">
                        <small class="text-muted">
                            <i class="bi bi-sticky-fill me-1"></i>
                            <div class="notes-content">{{ aluno.notes }}</div>
                        </small>
                    </div>
                </div>
                
                <!-- Botões de ação do aluno -->
                <div class="student-actions mt-2">
                    <!-- Botão de preview sempre presente, mas oculto se não há foto -->
                    <button class="btn btn-sm btn-outline-info preview-photo-btn" 
                            data-processo="{{ aluno.processo }}" 
                            data-nome="{{ aluno.nome }}"
                            data-turma="{{ aluno.turma }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#previewPhotoModal"
                            onclick="event.stopPropagation(); openPreviewModal('{{ aluno.processo }}', '{{ aluno.nome }}', '{{ aluno.turma }}');"
                            title="Preview da foto original"
                            {% if aluno.foto_existe %}style="display: inline-block;"{% else %}style="display: none;"{% endif %}>
                        <i class="bi bi-eye"></i>
                    </button>

                    {% if current_user.role in ['editor', 'admin'] %}
                    <button class="btn btn-sm btn-outline-warning transfer-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}"
                            data-turma-atual="{{ current_turma.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#manualUploadPhotoStudentModal"
                            title="Upload de foto do aluno"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-file-earmark-person-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary edit-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}" 
                            data-numero="{{ aluno.numero or '' }}"
                            data-email="{{ aluno.email or '' }}"
                            data-notes="{{ aluno.notes or '' }}"
                            data-autorizacao="{{ 'true' if aluno.autorizacao else 'false' }}"
                            data-autorizacao-debug="{{ aluno.autorizacao }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#editStudentModal"
                            title="Editar aluno"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning transfer-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}"
                            data-turma-atual="{{ current_turma.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#transferStudentModal"
                            title="Transferir aluno para outra turma"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteStudentModal"
                            title="Excluir aluno"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal para adicionar aluno -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">
                        <i class="bi bi-person-plus-fill me-2"></i>
                        Adicionar Aluno - Turma {{ current_turma.nome }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="addStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_add_new">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control input-base" id="studentName" name="nome" required 
                                   placeholder="Digite o nome completo do aluno" maxlength="200">
                        </div>

                        <div class="mb-3">
                            <label for="studentNumber" class="form-label">Número na Turma</label>
                            <input type="number" class="form-control input-base" id="studentNumber" name="numero" 
                                   placeholder="Digite o número na turma (opcional)" min="1" max="999">
                        </div>

                        <div class="mb-3">
                            <label for="studentProcess" class="form-label">Número do Processo</label>
                            <input type="number" class="form-control input-base" id="studentProcess" name="processo" required 
                                   placeholder="Ex: NIF, número de estudante, etc." min="1" step="1">
                            <div class="form-text">Apenas números inteiros positivos (ex: NIF, número de estudante)</div>
                        </div>

                        <div class="mb-3">
                            <label for="studentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control input-base" id="studentEmail" name="email" 
                                   placeholder="Digite o email do aluno (opcional)" maxlength="255">
                        </div>

                        <div class="mb-3">
                            <label for="studentNotes" class="form-label">Notas</label>
                            <textarea class="form-control input-base" id="studentNotes" name="notes" rows="3" 
                                      placeholder="Digite notas sobre o aluno (opcional)" maxlength="1000"></textarea>
                            <div class="form-text">Informações adicionais sobre o aluno (máximo 1000 caracteres)</div>
                            <div id="studentNotesContainer"></div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="studentAutorizacao" name="autorizacao" checked>
                                <label class="form-check-label" for="studentAutorizacao">
                                    <strong>Autorização para Redes Sociais</strong>
                                </label>
                            </div>
                            <div class="form-text">O aluno autorizou o uso da sua imagem em redes sociais</div>
                        </div>

                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Informações importantes:</strong><br>
                                • O número do processo deve ser único em todas as turmas<br>
                                • O número na turma é opcional e pode repetir<br>
                                • A listagem será ordenada pelo número na turma<br>
                                • O nome pode ter até 200 caracteres<br>
                                • O email pode ter até 255 caracteres<br>
                                • As notas podem ter até 1000 caracteres
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Adicionar Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar aluno -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">
                        <i class="bi bi-pencil-fill me-2"></i>
                        Editar Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="editStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_edit">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        <input type="hidden" name="aluno_id" id="editAlunoId">

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentName" class="form-label">Nome Completo</label>
                                    <input type="text" class="form-control" id="editStudentName" name="nome" required
                                           placeholder="Digite o nome completo do aluno" maxlength="200">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentNumber" class="form-label">Número na Turma</label>
                                    <input type="number" class="form-control" id="editStudentNumber" name="numero"
                                           placeholder="Digite o número na turma (opcional)" min="1" max="999">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentProcess" class="form-label">Número do Processo</label>
                                    <input type="number" class="form-control" id="editStudentProcess" name="processo" required
                                           placeholder="Ex: NIF, número de estudante, etc." min="1" step="1">
                                    <div class="form-text">Apenas números inteiros positivos (ex: NIF, número de estudante)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editStudentEmail" name="email"
                                           placeholder="Digite o email do aluno (opcional)" maxlength="255">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editStudentNotes" class="form-label">Notas</label>
                            <div class="form-text">Informações adicionais sobre o aluno (máximo 1000 caracteres)</div>
                            <textarea class="form-control" id="editStudentNotes" name="notes" rows="3"
                                      placeholder="Digite notas sobre o aluno (opcional)" maxlength="1000"></textarea>
                            <div id="editStudentNotesContainer"></div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editStudentAutorizacao" name="autorizacao" value="on">
                                <label class="form-check-label" for="editStudentAutorizacao">
                                    <strong>Autorização para Redes Sociais</strong>
                                </label>
                            </div>
                            <div class="form-text">O aluno autorizou o uso da sua imagem em redes sociais</div>
                        </div>

                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Atenção:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Alterar o número do processo pode afetar fotos já tiradas</li>
                                <li>O número do processo deve ser único na escola</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i>Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para excluir aluno -->
    <div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteStudentModalLabel">
                        <i class="bi bi-trash-fill me-2"></i>
                        Excluir Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="deleteStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_delete">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        <input type="hidden" name="aluno_id" id="deleteAlunoId">
                        
                        <div class="alert alert-danger d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Atenção:</strong><br>
                                Esta ação não pode ser desfeita!
                            </div>
                        </div>
                        
                        <p class="mb-0">
                            Tem certeza que deseja excluir o aluno <strong id="deleteStudentName"></strong>?
                        </p>
                        <p class="text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            A foto do aluno também será removida permanentemente.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Excluir Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para transferir aluno -->
    <div class="modal fade" id="transferStudentModal" tabindex="-1" aria-labelledby="transferStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferStudentModalLabel">
                        <i class="bi bi-arrow-right-circle-fill me-2"></i>
                        Transferir Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="transferStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_transfer">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        <input type="hidden" name="aluno_id" id="transferAlunoId">
                        
                        <div class="mb-3">
                            <p class="mb-2">
                                <strong>Aluno:</strong> <span id="transferStudentName"></span><br>
                                <strong>Turma atual:</strong> <span id="transferCurrentTurma"></span>
                            </p>
                        </div>

                        <div class="mb-3">
                            <label for="transferTargetTurma" class="form-label">Turma de Destino</label>
                            <select class="form-select input-base" id="transferTargetTurma" name="turma_destino" required>
                                <option value="">Selecione a turma de destino</option>
                                <!-- Opções serão carregadas dinamicamente -->
                            </select>
                        </div>

                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Informações importantes:</strong><br>
                                • O aluno será movido para a turma selecionada<br>
                                • A foto do aluno será transferida junto<br>
                                • O número do processo deve ser único na escola<br>
                                • Esta operação não pode ser desfeita facilmente
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-right-circle"></i> Transferir Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para remover foto -->
    <div class="modal fade" id="removePhotoModal" tabindex="-1" aria-labelledby="removePhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removePhotoModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Remover Foto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="removePhotoForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_remove_photo">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        <input type="hidden" name="aluno_id" id="removePhotoAlunoId">
                        
                        <div class="alert alert-warning d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Atenção:</strong><br>
                                Esta ação irá remover apenas a foto do aluno!
                            </div>
                        </div>
                        
                        <p class="mb-0">
                            Tem certeza que deseja remover a foto do aluno <strong id="removePhotoStudentName"></strong>?
                        </p>
                        <p class="text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            O aluno permanecerá na turma, mas precisará tirar uma nova foto.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-camera"></i> Remover Foto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para preview da foto original -->
    <div class="modal fade" id="previewPhotoModal" tabindex="-1" aria-labelledby="previewPhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewPhotoModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Preview - <span id="previewStudentName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="position-relative d-inline-block">
                        <!-- Placeholder inicial -->
                        <img id="previewImage" 
                             src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Carregando foto..." 
                             class="img-fluid rounded shadow preview-image-modal">
                        
                        <!-- Loading spinner -->
                        <div id="previewSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-muted">
                        <small><i class="bi bi-info-circle me-1"></i>Foto original</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fechar
                    </button>
                    <a id="downloadPhotoBtn" href="#" class="btn btn-primary" download>
                        <i class="bi bi-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para upload manual de foto do aluno -->
    <div class="modal fade" id="manualUploadPhotoStudentModal" tabindex="-1" aria-labelledby="manualUploadPhotoStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manualUploadPhotoStudentModalLabel">
                        <i class="bi bi-file-earmark-person-fill me-2"></i>
                        Upload Foto de <span id="manualUploadStudentName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student_crud') }}" id="manualUploadPhotoStudentForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_manual_upload_photo">
                        <input type="hidden" name="turma" value="{{ current_turma.nome }}">
                        <input type="hidden" name="aluno_id" id="manualUploadAlunoId">
                        <div class="mb-3">
                            <label for="manualUploadPhotoFile" class="form-label">Selecionar foto</label>
                            <input type="file" class="form-control" id="manualUploadPhotoFile" name="foto" accept="image/*" required>
                            <div class="form-text">Apenas ficheiros de imagem (JPG, PNG, etc.)</div>
                        </div>
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Nota:</strong><br>
                                A foto será associada ao aluno selecionado.<br>
                                O ficheiro deve ser uma imagem clara e recente do aluno.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-upload"></i> Enviar Foto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal para notificar professor responsável -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notificationModalLabel">
                        <i class="bi bi-envelope-fill me-2"></i>
                        Notificar Professor Responsável
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="notificationForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="turma_nome" value="{{ current_turma.nome }}"/>
                        <input type="hidden" name="turma_nome_seguro" value="{{ current_turma.nome_seguro }}"/>

                        <div class="mb-3">
                            <label for="notificationEmail" class="form-label">Destino</label>
                            <input type="email" class="form-control input-base" id="notificationEmail"
                                   name="email" value="{{ current_turma.email_professor or '' }}" required readonly>
                            <div class="form-text">Email do professor responsável pela turma</div>
                        </div>

                        <div class="mb-3">
                            <label for="notificationSubject" class="form-label">Assunto</label>
                            <input type="text" class="form-control input-base" id="notificationSubject"
                                   name="subject" value="Informação: A sua turma {{ current_turma.nome }} foi atualizada" required>
                            <div class="form-text">Assunto do email de notificação</div>
                        </div>

                        <div class="mb-3">
                            <label for="notificationBody" class="form-label">Mensagem</label>
                            <textarea class="form-control input-base" id="notificationBody" name="body" rows="4" required>
Caro(a) Professor(a) {{ current_turma.nome_professor or 'Professor' }},

A sua turma "{{ current_turma.nome }}" foi recentemente atualizada com novas informações ou fotos dos alunos.
                            </textarea>
                            <div class="form-text">Corpo da mensagem de notificação</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> Enviar Email
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Mobile bottom buttons -->
    <!--
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-4">
                    <a href="{{ url_for('turmas') }}" class="btn btn-secondary w-100 btn-sm mobile-btn-inline">
                        <i class="bi bi-arrow-left"></i>
                        <small>Voltar</small>
                    </a>
                </div>
                <div class="col-4">
                    <div class="dropdown w-100">
                        <button class="btn btn-primary w-100 btn-sm dropdown-toggle mobile-btn-inline" type="button" id="mobileDownloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download"></i>
                            <small>Download</small>
                        </button>
                        <ul class="dropdown-menu w-100 shadow border-0" aria-labelledby="mobileDownloadDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.zip') }}">
                                <i class="bi bi-file-earmark-zip me-2 text-primary"></i> {{ current_turma.nome_seguro }}.zip
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.thumbs.zip') }}">
                                <i class="bi bi-file-earmark-zip-fill me-2 text-info"></i> {{ current_turma.nome_seguro }}.thumbs.zip
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=current_turma.nome_seguro + '.docx') }}">
                                <i class="bi bi-file-earmark-word me-2 text-success"></i> {{ current_turma.nome_seguro }}.docx
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-4">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 btn-sm mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
    -->

    <!-- Modal de Captura de Foto -->
    <!-- Modal para capturar foto - Fullscreen -->
    <div class="modal fade" id="capturePhotoModal" tabindex="-1" aria-labelledby="capturePhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content d-flex flex-column h-100">
                <!-- Header fixo -->
                <div class="modal-header bg-primary text-white flex-shrink-0">
                    <h5 class="modal-title" id="capturePhotoModalLabel">
                        <i class="bi bi-camera me-2"></i>Capturar Foto <span id="modalAlunoNome"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Body principal - layout flexível -->
                <div class="modal-body p-0 flex-grow-1 d-flex">
                    
                    <!-- Layout Portrait (Mobile Vertical) -->
                    <div class="d-flex d-md-none flex-column w-100 h-100">
                        <!-- Vídeo ocupa maior parte da tela -->
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-dark p-2">
                            <div class="camera-container position-relative w-100 h-100">
                                <video id="modalCameraVideo" autoplay class="w-100 h-100 rounded shadow" style="object-fit: cover;"></video>
                                
                                <!-- OVERLAY (GUIAS) para Mobile -->
                                <svg id="guidesMobile" class="guides-overlay" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
                                    <!-- Cruz central -->
                                    <g id="guide-cross-mobile" stroke="white" stroke-width="2" opacity="0.8">
                                        <line x1="500" y1="0" x2="500" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="500" x2="1000" y2="500" vector-effect="non-scaling-stroke"/>
                                    </g>

                                    <!-- Regra dos terços -->
                                    <g id="guide-thirds-mobile" stroke="white" stroke-width="2" opacity="0.5" style="display:none">
                                        <line x1="333.33" y1="0" x2="333.33" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="666.66" y1="0" x2="666.66" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="333.33" x2="1000" y2="333.33" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="666.66" x2="1000" y2="666.66" vector-effect="non-scaling-stroke"/>
                                    </g>

                                    <!-- Silhueta (face + ombros) -->
                                    <g id="guide-silhouette-mobile" fill="none" stroke="white" stroke-width="2" opacity="0.9" style="display:none" transform="translate(500,540) scale(1) translate(-500,-500)">
                                        <!-- Círculo da cabeça -->
                                        <circle cx="500" cy="400" r="120" vector-effect="non-scaling-stroke"/>
                                        <!-- Pescoço -->
                                        <path d="M460,520 C470,560 530,560 540,520" vector-effect="non-scaling-stroke"/>
                                        <!-- Ombros/peito -->
                                        <path d="M360,600 C420,550 580,550 640,600
                                                 C720,660 720,760 640,800
                                                 L360,800
                                                 C280,760 280,660 360,600 Z"
                                              vector-effect="non-scaling-stroke"/>
                                        <!-- Alvo central (nariz) -->
                                        <circle cx="500" cy="420" r="6" fill="white" stroke="none"/>
                                    </g>

                                    <!-- Vinheta/margens de segurança -->
                                    <rect x="20" y="20" width="960" height="960" fill="none" stroke="white" stroke-width="2" opacity="0.25"
                                          vector-effect="non-scaling-stroke" style="display:none" id="guide-frame-mobile"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Controles compactos na parte inferior -->
                        <div class="bg-white border-top p-3" style="min-height: 280px;">
                            <div class="d-grid gap-2">
                                <!-- Botão principal -->
                                <button type="button" id="modalCaptureButton" class="btn btn-primary btn-lg">
                                    <i class="bi bi-camera me-2"></i>Capturar Foto
                                </button>
                                
                                <!-- Guias auxiliares -->
                                <div class="text-center">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-grid-3x3 me-1"></i>Guias:</small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="guideMobile" id="guideCrossMobile" value="cross" checked>
                                        <label class="btn btn-outline-secondary" for="guideCrossMobile">Cruz</label>
                                        
                                        <input type="radio" class="btn-check" name="guideMobile" id="guideThirdsMobile" value="thirds">
                                        <label class="btn btn-outline-secondary" for="guideThirdsMobile">Terços</label>
                                        
                                        <input type="radio" class="btn-check" name="guideMobile" id="guideSilhouetteMobile" value="silhouette">
                                        <label class="btn btn-outline-secondary" for="guideSilhouetteMobile">Pessoa</label>
                                        
                                        <input type="radio" class="btn-check" name="guideMobile" id="guideNoneMobile" value="none">
                                        <label class="btn btn-outline-secondary" for="guideNoneMobile">Off</label>
                                    </div>
                                </div>
                                
                                <!-- Controles da Silhueta Mobile (visível apenas quando selecionada) -->
                                <div id="silhouetteControlsMobile" style="display:none;" class="text-center">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-arrows-fullscreen me-1"></i>Ajustar Pessoa:</small>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Tamanho:</label>
                                            <input id="silhouetteScaleMobile" type="range" class="form-range form-range-sm" min="0.7" max="2.5" step="0.01" value="1.0">
                                            <div class="small text-muted"><span id="scaleValueMobile">100%</span></div>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Posição:</label>
                                            <input id="silhouetteOffsetMobile" type="range" class="form-range form-range-sm" min="-200" max="200" step="5" value="0">
                                            <div class="small text-muted"><span id="offsetValueMobile">Centro</span></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Câmeras em linha -->
                                <div class="text-center">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-camera-video me-1"></i>Câmera:</small>
                                    <div id="modalCameraButtons" class="d-flex justify-content-center gap-1 flex-wrap"></div>
                                </div>
                                
                                <!-- Qualidade compacta -->
                                <div class="text-center">
                                    <small class="text-muted d-block mb-2"><i class="bi bi-gear me-1"></i>Qualidade:</small>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="photoQuality" id="qualityLow" value="low">
                                        <label class="btn btn-outline-primary" for="qualityLow">LOW</label>
                                        
                                        <input type="radio" class="btn-check" name="photoQuality" id="qualityMed" value="med" checked>
                                        <label class="btn btn-outline-primary" for="qualityMed">MED</label>
                                        
                                        <input type="radio" class="btn-check" name="photoQuality" id="qualityHigh" value="high">
                                        <label class="btn btn-outline-primary" for="qualityHigh">HIGH</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Layout Landscape (Desktop/Tablet Horizontal) -->
                    <div class="d-none d-md-flex w-100 h-100">
                        <!-- Vídeo - 75% da largura -->
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center bg-dark p-3" style="flex-basis: 75%;">
                            <div class="camera-container position-relative w-100 h-100">
                                <video id="modalCameraVideoDesktop" autoplay class="w-100 h-100 rounded shadow" style="object-fit: cover; max-height: 90vh;"></video>
                                
                                <!-- OVERLAY (GUIAS) para Desktop -->
                                <svg id="guidesDesktop" class="guides-overlay" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
                                    <!-- Cruz central -->
                                    <g id="guide-cross-desktop" stroke="white" stroke-width="2" opacity="0.8">
                                        <line x1="500" y1="0" x2="500" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="500" x2="1000" y2="500" vector-effect="non-scaling-stroke"/>
                                    </g>

                                    <!-- Regra dos terços -->
                                    <g id="guide-thirds-desktop" stroke="white" stroke-width="2" opacity="0.5" style="display:none">
                                        <line x1="333.33" y1="0" x2="333.33" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="666.66" y1="0" x2="666.66" y2="1000" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="333.33" x2="1000" y2="333.33" vector-effect="non-scaling-stroke"/>
                                        <line x1="0" y1="666.66" x2="1000" y2="666.66" vector-effect="non-scaling-stroke"/>
                                    </g>

                                    <!-- Silhueta (face + ombros) -->
                                    <g id="guide-silhouette-desktop" fill="none" stroke="white" stroke-width="2" opacity="0.9" style="display:none" transform="translate(500,540) scale(1) translate(-500,-500)">
                                        <!-- Círculo da cabeça -->
                                        <circle cx="500" cy="400" r="120" vector-effect="non-scaling-stroke"/>
                                        <!-- Pescoço -->
                                        <path d="M460,520 C470,560 530,560 540,520" vector-effect="non-scaling-stroke"/>
                                        <!-- Ombros/peito -->
                                        <path d="M360,600 C420,550 580,550 640,600
                                                 C720,660 720,760 640,800
                                                 L360,800
                                                 C280,760 280,660 360,600 Z"
                                              vector-effect="non-scaling-stroke"/>
                                        <!-- Alvo central (nariz) -->
                                        <circle cx="500" cy="420" r="6" fill="white" stroke="none"/>
                                    </g>

                                    <!-- Vinheta/margens de segurança -->
                                    <rect x="20" y="20" width="960" height="960" fill="none" stroke="white" stroke-width="2" opacity="0.25"
                                          vector-effect="non-scaling-stroke" style="display:none" id="guide-frame-desktop"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Controles laterais - 25% da largura -->
                        <div class="bg-light border-start p-4 d-flex flex-column" style="flex-basis: 25%; min-width: 350px;">
                            <div class="d-grid gap-3 h-100">
                                <!-- Botão principal -->
                                <button type="button" id="modalCaptureButtonDesktop" class="btn btn-primary btn-lg">
                                    <i class="bi bi-camera me-2"></i>Capturar Foto
                                </button>
                                
                                <!-- Seção Guias Auxiliares -->
                                <div>
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-grid-3x3 me-2"></i>Guias Auxiliares:
                                    </label>
                                    <div class="btn-group-vertical w-100" role="group">
                                        <input type="radio" class="btn-check" name="guideDesktop" id="guideCrossDesktop" value="cross" checked>
                                        <label class="btn btn-outline-secondary" for="guideCrossDesktop">
                                            <i class="bi bi-plus me-2"></i>Cruz Central
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="guideDesktop" id="guideThirdsDesktop" value="thirds">
                                        <label class="btn btn-outline-secondary" for="guideThirdsDesktop">
                                            <i class="bi bi-grid-3x3 me-2"></i>Regra dos Terços
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="guideDesktop" id="guideSilhouetteDesktop" value="silhouette">
                                        <label class="btn btn-outline-secondary" for="guideSilhouetteDesktop">
                                            <i class="bi bi-person me-2"></i>Silhueta Pessoa
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="guideDesktop" id="guideNoneDesktop" value="none">
                                        <label class="btn btn-outline-secondary" for="guideNoneDesktop">
                                            <i class="bi bi-eye-slash me-2"></i>Sem Guias
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Controles da Silhueta (visível apenas quando selecionada) -->
                                <div id="silhouetteControlsDesktop" style="display:none;">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-arrows-fullscreen me-2"></i>Ajustes da Silhueta:
                                    </label>
                                    <div class="mb-3">
                                        <label class="form-label small">Tamanho:</label>
                                        <input id="silhouetteScaleDesktop" type="range" class="form-range" min="0.7" max="2.5" step="0.01" value="1.0">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>70%</span>
                                            <span id="scaleValueDesktop">100%</span>
                                            <span>250%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small">Posição Vertical:</label>
                                        <input id="silhouetteOffsetDesktop" type="range" class="form-range" min="-200" max="200" step="5" value="0">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>↑ Cima</span>
                                            <span id="offsetValueDesktop">Centro</span>
                                            <span>↓ Baixo</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Seção Câmeras -->
                                <div>
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-camera-video me-2"></i>Câmeras Disponíveis:
                                    </label>
                                    <div id="modalCameraButtonsDesktop" class="d-grid gap-2"></div>
                                </div>
                                
                                <!-- Seção Qualidade -->
                                <div>
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-gear me-2"></i>Qualidade da Foto:
                                    </label>
                                    <div class="btn-group-vertical w-100" role="group">
                                        <input type="radio" class="btn-check" name="photoQualityDesktop" id="qualityLowDesktop" value="low">
                                        <label class="btn btn-outline-primary" for="qualityLowDesktop">
                                            <i class="bi bi-speedometer me-2"></i>LOW (640x480)
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="photoQualityDesktop" id="qualityMedDesktop" value="med" checked>
                                        <label class="btn btn-outline-primary" for="qualityMedDesktop">
                                            <i class="bi bi-speedometer2 me-2"></i>MED (1280x720)
                                        </label>
                                        
                                        <input type="radio" class="btn-check" name="photoQualityDesktop" id="qualityHighDesktop" value="high">
                                        <label class="btn btn-outline-primary" for="qualityHighDesktop">
                                            <i class="bi bi-lightning me-2"></i>HIGH (1920x1080)
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Info de atalhos -->
                                <div class="mt-auto text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <kbd>Enter</kbd> capturar • <kbd>Esc</kbd> fechar
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* CSS mínimo customizado - apenas o essencial que o Bootstrap não cobre */
        
        /* Botões de câmera compactos para mobile */
        #modalCameraButtons .btn {
            width: 60px;
            height: 60px;
            font-size: 0.7rem;
            padding: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        
        /* Botões de câmera expandidos para desktop */
        #modalCameraButtonsDesktop .btn {
            min-height: 50px;
            text-align: left;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
        }
        
        /* Camera container e guias auxiliares */
        .camera-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .guides-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Animações suaves para as guias */
        .guides-overlay g {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* Responsividade das guias */
        @media (max-width: 767.98px) {
            .guides-overlay {
                border-radius: 8px;
            }
        }
        
        /* Ensure video fills available space properly */
        #modalCameraVideo, #modalCameraVideoDesktop {
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Mobile specific adjustments */
        @media (max-width: 767.98px) {
            #modalCameraVideo {
                max-height: calc(100vh - 330px); /* Aumentado para dar espaço aos controles da silhueta */
            }
            /* Controles da silhueta mobile mais compactos */
            #silhouetteControlsMobile .form-range {
                height: 1.2rem;
            }
            #silhouetteControlsMobile .small {
                font-size: 0.75rem;
            }
        }
        
        /* Desktop specific adjustments */
        @media (min-width: 768px) {
            #modalCameraVideoDesktop {
                max-height: calc(100vh - 120px);
            }
        }
        
        /* Estilos para os controles das guias */
        .form-range {
            cursor: pointer;
        }
        
        .form-range::-webkit-slider-thumb {
            background-color: #0d6efd;
        }
        
        .form-range::-moz-range-thumb {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // Função para lidar com drop de imagem no cartão do aluno
        function handleStudentCardDrop(event, card) {
            event.preventDefault();
            card.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (!files || files.length === 0) return;
            const file = files[0];
            if (!file.type.match(/^image\/(jpeg|png)$/)) {
                alert('Apenas ficheiros JPG ou PNG são permitidos.');
                return;
            }
            // Preencher dados do aluno
            const alunoId = card.getAttribute('data-aluno-id');
            const alunoNome = card.getAttribute('data-aluno-nome');
            // Abrir modal manualUploadPhotoStudentModal
            document.getElementById('manualUploadAlunoId').value = alunoId;
            document.getElementById('manualUploadStudentName').textContent = alunoNome;
            // Setar o ficheiro no input file
            const input = document.getElementById('manualUploadPhotoFile');
            // Criar um DataTransfer para simular seleção
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('manualUploadPhotoStudentModal'));
            modal.show();
        }


        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = "{{ url_for('logout') }}";
            }
        }
        
        // Gerenciar cliques nos cards dos alunos
        document.querySelectorAll('.student-card').forEach(card => {
            card.addEventListener('touchstart', function() {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        });
        

        // Modal de adicionar aluno
        const addStudentModal = document.getElementById('addStudentModal');
        const addStudentForm = document.getElementById('addStudentForm');
        
        // Limpar form quando modal abrir
        addStudentModal.addEventListener('show.bs.modal', function() {
            addStudentForm.reset();
            setTimeout(() => {
                document.getElementById('studentName').focus();
            }, 500);
        });
        
        // Validação do formulário
        addStudentForm.addEventListener('submit', function(e) {
            const nome = document.getElementById('studentName').value.trim();
            const processo = document.getElementById('studentProcess').value.trim();
            
            if (!nome || !processo) {
                e.preventDefault();
                alert('Por favor, preencha todos os campos!');
                return;
            }
        });
        
        // Permitir apenas números e letras no campo processo
        document.getElementById('studentProcess').addEventListener('input', function(e) {
            // Remove caracteres especiais exceto números, letras e alguns símbolos comuns
            this.value = this.value.replace(/[^a-zA-Z0-9\/\-_.]/g, '');
        });

        // Gerenciar modal de editar aluno
        const editStudentModal = document.getElementById('editStudentModal');
        editStudentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget; // Botão que acionou o modal
            const id = button.dataset.id;
            const nome = button.dataset.nome;
            const processo = button.dataset.processo;
            const numero = button.dataset.numero || '';
            const email = button.dataset.email || '';
            const notes = button.dataset.notes || '';
            const autorizacao = button.dataset.autorizacao === 'true';
            
            document.getElementById('editAlunoId').value = id;
            document.getElementById('editStudentName').value = nome;
            document.getElementById('editStudentProcess').value = processo;
            document.getElementById('editStudentNumber').value = numero;
            document.getElementById('editStudentEmail').value = email;
            document.getElementById('editStudentNotes').value = notes;
            document.getElementById('editStudentAutorizacao').checked = autorizacao;
        });

        // Limpar modal quando for fechado
        editStudentModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('editStudentForm').reset();
        });

        // Gerenciar modal de excluir aluno
        document.querySelectorAll('.delete-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                
                document.getElementById('deleteAlunoId').value = id;
                document.getElementById('deleteStudentName').textContent = nome;
            });
        });

        // Gerenciar modal de transferir aluno
        document.querySelectorAll('.transfer-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                const processo = this.dataset.processo;
                const turmaAtual = this.dataset.turmaAtual;
                
                document.getElementById('transferAlunoId').value = id;
                document.getElementById('transferStudentName').textContent = nome;
                document.getElementById('transferCurrentTurma').textContent = turmaAtual;
                
                // Carregar lista de turmas via AJAX
                loadTurmasForTransfer(turmaAtual);
            });
        });
        
        // Função para carregar turmas disponíveis para transferência
        function loadTurmasForTransfer(turmaAtual) {
            fetch("{{ url_for('turmas', api='true') }}")
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('transferTargetTurma');
                    select.innerHTML = '<option value="">Selecione a turma de destino</option>';
                    
                    data.turmas.forEach(turma => {
                        if (turma !== turmaAtual) {
                            const option = document.createElement('option');
                            option.value = turma;
                            option.textContent = turma;
                            select.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar turmas:', error);
                    const select = document.getElementById('transferTargetTurma');
                    select.innerHTML = '<option value="">Erro ao carregar turmas</option>';
                });
        }

        // Validação do formulário de edição
        document.getElementById('editStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('editStudentName').value.trim();
            const processo = document.getElementById('editStudentProcess').value.trim();
            
            if (!nome || !processo) {
                e.preventDefault();
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            if (!confirm('Confirma as alterações no aluno?')) {
                e.preventDefault();
            }
        });

        // Validação do formulário de exclusão
        document.getElementById('deleteStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('deleteStudentName').textContent;
            
            if (!confirm(`ATENÇÃO: Tem certeza absoluta que deseja excluir o aluno "${nome}"?\n\nEsta ação é IRREVERSÍVEL!`)) {
                e.preventDefault();
            }
        });

        // Validação do formulário de transferência
        document.getElementById('transferStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('transferStudentName').textContent;
            const turmaDestino = document.getElementById('transferTargetTurma').value;
            
            if (!turmaDestino) {
                e.preventDefault();
                alert('Por favor, selecione uma turma de destino!');
                return;
            }
        });


        // Gerenciar modal de upload manual de foto do aluno

        // Gerenciar modal de upload manual de foto do aluno
        document.querySelectorAll('.transfer-student-btn').forEach(btn => {
            if (btn.dataset.bsTarget === '#manualUploadPhotoStudentModal') {
                btn.addEventListener('click', function() {
                    document.getElementById('manualUploadAlunoId').value = this.dataset.id;
                    document.getElementById('manualUploadStudentName').textContent = this.dataset.nome;
                });
            }
        });

        // Enviar foto manualmente via AJAX
        document.getElementById('manualUploadPhotoStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;

            // Mostrar feedback visual
            submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
            submitButton.disabled = true;

            // Obter dados do aluno
            const alunoId = form.querySelector('#manualUploadAlunoId').value;
            const alunoData = alunosData.find(a => String(a.id) === String(alunoId));
            if (!alunoData) {
                alert('Aluno não encontrado.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                return;
            }
            const nome_seguro = "{{ current_turma.nome_seguro }}";
            const processo = alunoData.processo;

            // Obter ficheiro
            const fileInput = form.querySelector('#manualUploadPhotoFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Selecione uma imagem.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                return;
            }

            // Ler ficheiro como base64
            const reader = new FileReader();
            reader.onload = function(ev) {
                const base64data = ev.target.result;
                // Enviar para o mesmo endpoint da captura
                const uploadUrl = "{{ url_for('upload_photo', nome_seguro=current_turma.nome_seguro, processo='PROCESSO_PLACEHOLDER') }}".replace('PROCESSO_PLACEHOLDER', processo);
                fetch(uploadUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64data })
                })
                .then(response => {
                    if (response.ok) {
                        // Fechar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('manualUploadPhotoStudentModal'));
                        modal.hide();

                        // Restaurar botão
                        submitButton.innerHTML = originalButtonText;
                        submitButton.disabled = false;

                        // Atualizar foto dinamicamente
                        updateStudentPhotoAfterCapture(processo);
                        
                        // Criar mensagem de sucesso
                        createFlashMessage(`Foto de ${alunoData.nome} enviada com sucesso!`, 'success');
                    } else {
                        throw new Error('Erro no upload');
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar foto:', error);
                    alert('Erro ao enviar a foto. Tente novamente.');
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                });
            };
            reader.onerror = function() {
                alert('Erro ao ler o ficheiro.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        // Gerenciar modal de preview da foto (usando delegação de eventos)
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                const previewBtn = e.target.closest('.preview-photo-btn');
                if (previewBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const processo = previewBtn.dataset.processo;
                    const nome = previewBtn.dataset.nome;
                    const turma = previewBtn.dataset.turma;
                    
                    // Preparar dados do modal
                    document.getElementById('previewStudentName').textContent = nome;
                    
                    // Preparar URL da foto original
                    const originalPhotoUrl = "{{ url_for('get_photo', folder_name=current_turma.nome_seguro, processo='PROCESSO_PLACEHOLDER') }}".replace('PROCESSO_PLACEHOLDER', processo) + "?size=original";
                    
                    // Preparar botão de download
                    const downloadBtn = document.getElementById('downloadPhotoBtn');
                    downloadBtn.href = originalPhotoUrl;
                    downloadBtn.download = `${nome}_${processo}.jpg`;
                    
                    // Reset da imagem para placeholder e mostrar spinner
                    const previewImage = document.getElementById('previewImage');
                    const spinner = document.getElementById('previewSpinner');
                    
                    previewImage.src = "{{ url_for('static', filename='student_icon.jpg') }}";
                    previewImage.alt = "Carregando foto...";
                    spinner.classList.remove('d-none');
                    
                    // Abrir modal usando Bootstrap diretamente
                    const modal = new bootstrap.Modal(document.getElementById('previewPhotoModal'));
                    modal.show();
                    
                    // Carregar foto original após pequeno delay
                    setTimeout(() => {
                        const img = new Image();
                        
                        img.onload = function() {
                            spinner.classList.add('d-none');
                            previewImage.src = originalPhotoUrl;
                            previewImage.alt = `Foto original de ${nome}`;
                        };
                        
                        img.onerror = function() {
                            console.error('Erro ao carregar foto para preview:', originalPhotoUrl);
                            spinner.classList.add('d-none');
                            previewImage.alt = "Erro ao carregar foto";
                        };
                        
                        img.src = originalPhotoUrl;
                    }, 200);
                }
            });
        });

        // Gerenciar modal de remover foto
        document.querySelectorAll('.remove-photo-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                
                document.getElementById('removePhotoAlunoId').value = id;
                document.getElementById('removePhotoStudentName').textContent = nome;
            });
        });

        // Validação do formulário de remoção de foto - agora com AJAX
        document.getElementById('removePhotoForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir submit tradicional
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            // Mostrar feedback visual
            submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Removendo...';
            submitButton.disabled = true;
            
            // Enviar requisição AJAX
            fetch("{{ url_for('student_crud') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('removePhotoModal'));
                    modal.hide();
                    
                    // Restaurar botão
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                    
                    // Obter dados do aluno
                    const alunoId = formData.get('aluno_id');
                    const studentName = document.getElementById('removePhotoStudentName').textContent;
                    
                    // Atualizar foto dinamicamente
                    updateStudentPhotoAfterRemoval(alunoId, studentName);
                } else {
                    throw new Error('Erro na remoção');
                }
            })
            .catch(error => {
                console.error('Erro ao remover foto:', error);
                alert('Erro ao remover a foto. Tente novamente.');
                
                // Restaurar botão
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            });
        });

        // Permitir apenas números e letras no campo processo do modal de edição
        document.getElementById('editStudentProcess').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^a-zA-Z0-9\/\-_.]/g, '');
        });

        // === SCROLL PRESERVATION ===
        const turmaName = "{{ current_turma.nome_seguro }}";
        const scrollStorageKey = `turmaScrollPosition_${turmaName}`;
        
        // Dados dos alunos para uso nas funções JavaScript
        const alunosData = {{ alunos|tojson|safe }};
        
        // Função para atualizar ícones baseado nos dados atuais
        function updateAllStudentIcons() {
            alunosData.forEach(aluno => {
                const card = document.querySelector(`[data-aluno-processo="${aluno.processo}"]`);
                if (!card) return;
                
                const badge = card.querySelector('.photo-status-badge');
                if (!badge) return;
                
                // Remover classes existentes
                badge.classList.remove('success', 'danger', 'warning');
                
                // Aplicar classe e título baseado no estado atual
                if (aluno.foto_tirada) {
                    if (aluno.autorizacao) {
                        badge.classList.add('success');
                        badge.title = 'Foto tirada - Autorização concedida';
                        badge.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    } else {
                        badge.classList.add('danger');
                        badge.title = 'Foto tirada - Autorização NÃO concedida';
                        badge.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    }
                } else {
                    badge.classList.add('warning');
                    badge.title = 'Foto não tirada';
                    badge.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
                }
            });
        }
        
        // Atualizar ícones na inicialização
        document.addEventListener('DOMContentLoaded', function() {
            updateAllStudentIcons();
        });
        
        // Restaurar posição de scroll ao carregar a página
        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem(scrollStorageKey);
            if (savedPosition) {
                const position = parseInt(savedPosition, 10);
                if (!isNaN(position)) {
                    // Aguardar um pouco para garantir que a página carregou completamente
                    setTimeout(() => {
                        window.scrollTo({
                            top: position,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
        }
        
        // Salvar posição de scroll antes de sair da página
        function saveScrollPosition() {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            localStorage.setItem(scrollStorageKey, scrollPosition.toString());
        }
        
        // Função para ir para captura de foto (salvando scroll)
        function goToCapturePhoto(processo) {
            // Verificar se o utilizador tem permissões
            const userRole = '{{ current_user.role }}';
            if (!['editor', 'admin'].includes(userRole)) {
                alert('Não tem permissões para capturar fotografias.');
                return;
            }
            
            // Encontrar o card do aluno pelo processo
            const alunoData = alunosData.find(a => a.processo === processo);
            
            if (alunoData) {
                // Preencher nome do aluno no modal header
                document.getElementById('modalAlunoNome').textContent = alunoData.nome;
            } else {
                // Fallback se não encontrar
                document.getElementById('modalAlunoNome').textContent = `Processo ${processo}`;
            }
            
            // Armazenar processo atual para uso na captura
            window.currentProcesso = processo;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('capturePhotoModal'));
            modal.show();
        }
        
        // Salvar scroll em vários eventos de saída
        window.addEventListener('beforeunload', saveScrollPosition);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um link for clicado
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && !link.classList.contains('stay-on-page')) {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um formulário for submetido
        document.addEventListener('submit', function(e) {
            saveScrollPosition();
        });
        
        // Restaurar posição ao carregar
        document.addEventListener('DOMContentLoaded', restoreScrollPosition);
        
        // Limpar posição salva após 1 hora (para evitar acumulação)
        setTimeout(() => {
            localStorage.removeItem(scrollStorageKey);
        }, 3600000); // 1 hora
        
        // Função para abrir modal de preview (fallback)
        function openPreviewModal(processo, nome, turma) {
            // Preparar dados do modal
            document.getElementById('previewStudentName').textContent = nome;
            
            // Preparar URL da foto original
            const originalPhotoUrl = "{{ url_for('get_photo', folder_name=current_turma.nome_seguro, processo='PROCESSO_PLACEHOLDER') }}".replace('PROCESSO_PLACEHOLDER', processo) + "?size=original";
            
            // Preparar botão de download
            const downloadBtn = document.getElementById('downloadPhotoBtn');
            downloadBtn.href = originalPhotoUrl;
            downloadBtn.download = `${nome}_${processo}.jpg`;
            
            // Reset da imagem para placeholder e mostrar spinner
            const previewImage = document.getElementById('previewImage');
            const spinner = document.getElementById('previewSpinner');
            
            previewImage.src = "{{ url_for('static', filename='student_icon.jpg') }}";
            previewImage.alt = "Carregando foto...";
            spinner.classList.remove('d-none');
            
            // Carregar foto original
            setTimeout(() => {
                const img = new Image();
                
                img.onload = function() {
                    spinner.classList.add('d-none');
                    previewImage.src = originalPhotoUrl;
                    previewImage.alt = `Foto original de ${nome}`;
                };
                
                img.onerror = function() {
                    console.error('Erro ao carregar foto para preview (fallback):', originalPhotoUrl);
                    spinner.classList.add('d-none');
                    previewImage.alt = "Erro ao carregar foto";
                };
                
                img.src = originalPhotoUrl;
            }, 100);
        }
        
        // Tornar função global
        window.openPreviewModal = openPreviewModal;

        // ============================================
        // MODAL DE CAPTURA DE FOTO
        // ============================================
        
        let modalStream;
        // Constantes para localStorage
        const CAMERA_STORAGE_KEY = 'classPhotoBooth_selectedCamera';
        const QUALITY_STORAGE_KEY = 'classPhotoBooth_photoQuality';
        
        // Configurações de qualidade
        const QUALITY_SETTINGS = {
            'low': {
                video: { width: { ideal: 640 }, height: { ideal: 480 } },
                jpeg: 0.95,
                label: 'LOW (640x480)'
            },
            'med': {
                video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                jpeg: 0.95,
                label: 'MED (1280x720)'
            },
            'high': {
                video: { width: { ideal: 1920 }, height: { ideal: 1080 } },
                jpeg: 0.95,
                label: 'HIGH (1920x1080)'
            }
        };
        
        function initPhotoQuality() {
            // Obter qualidade salva ou usar 'med' como padrão
            const savedQuality = localStorage.getItem(QUALITY_STORAGE_KEY) || 'med';
            
            // Selecionar o radio button correto
            const qualityRadio = document.querySelector(`input[name="photoQuality"][value="${savedQuality}"]`);
            if (qualityRadio) {
                qualityRadio.checked = true;
            }
            
            // Adicionar evento para salvar quando mudar
            document.querySelectorAll('input[name="photoQuality"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        localStorage.setItem(QUALITY_STORAGE_KEY, this.value);
                        console.log('Qualidade alterada para:', QUALITY_SETTINGS[this.value].label);
                        
                        // Reiniciar câmera com nova qualidade se estiver ativa
                        if (modalStream) {
                            const savedCameraId = localStorage.getItem(CAMERA_STORAGE_KEY);
                            startModalCamera(savedCameraId);
                        }
                    }
                });
            });
        }
        
        async function initModalCamera() {
            // Detectar se estamos em mobile ou desktop
            const isMobile = window.innerWidth < 768;
            const modalVideo = isMobile ? 
                document.getElementById('modalCameraVideo') : 
                document.getElementById('modalCameraVideoDesktop');
            const modalCameraButtons = isMobile ? 
                document.getElementById('modalCameraButtons') : 
                document.getElementById('modalCameraButtonsDesktop');
            
            // Limpar botões anteriores
            modalCameraButtons.innerHTML = '';
            
            try {
                // Obter dispositivos de vídeo
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Criar botões para cada câmera
                videoDevices.forEach((device, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-outline-secondary';
                    button.setAttribute('data-camera-id', device.deviceId);
                    
                    const cameraName = device.label || `Câmera ${index + 1}`;
                    
                    if (isMobile) {
                        // Layout compacto para mobile
                        const shortName = cameraName.length > 8 ? cameraName.substring(0, 8) + '...' : cameraName;
                        button.innerHTML = `
                            <i class="bi bi-camera mb-1"></i>
                            <small>${shortName}</small>
                        `;
                    } else {
                        // Layout expandido para desktop
                        button.innerHTML = `
                            <i class="bi bi-camera me-2"></i>${cameraName}
                        `;
                    }
                    
                    // Event listener para trocar de câmera
                    button.addEventListener('click', () => {
                        selectModalCamera(device.deviceId, button);
                    });
                    
                    modalCameraButtons.appendChild(button);
                });
                
                // Recuperar a câmera selecionada anteriormente
                const savedCameraId = localStorage.getItem(CAMERA_STORAGE_KEY);
                let initialCameraId = null;
                let initialButton = null;
                
                // Verificar se a câmera salva ainda está disponível
                if (savedCameraId) {
                    const cameraExists = videoDevices.some(device => device.deviceId === savedCameraId);
                    if (cameraExists) {
                        initialCameraId = savedCameraId;
                        initialButton = modalCameraButtons.querySelector(`[data-camera-id="${savedCameraId}"]`);
                    }
                }
                
                // Se não há câmera salva ou não está disponível, usar a primeira
                if (!initialCameraId && videoDevices.length > 0) {
                    initialCameraId = videoDevices[0].deviceId;
                    initialButton = modalCameraButtons.firstElementChild;
                }
                
                // Iniciar câmera (com a salva ou padrão)
                if (initialCameraId && initialButton) {
                    await selectModalCamera(initialCameraId, initialButton);
                }
                
            } catch (error) {
                console.error('Erro ao acessar câmeras:', error);
                alert('Erro ao acessar câmeras. Verifique as permissões.');
            }
        }

        async function selectModalCamera(deviceId, selectedButton) {
            // Detectar se estamos em mobile ou desktop
            const isMobile = window.innerWidth < 768;
            const modalCameraButtons = isMobile ? 
                document.getElementById('modalCameraButtons') : 
                document.getElementById('modalCameraButtonsDesktop');
            
            // Atualizar estilos dos botões - todas as câmeras ficam secondary
            const allButtons = modalCameraButtons.querySelectorAll('button');
            
            allButtons.forEach(button => {
                button.className = 'btn btn-outline-secondary';
            });
            
            // A câmera selecionada fica primary
            if (selectedButton) {
                selectedButton.className = 'btn btn-primary';
            }
            
            // Iniciar a câmera selecionada
            await startModalCamera(deviceId);
        }

        async function startModalCamera(deviceId) {
            // Detectar se estamos em mobile ou desktop e selecionar o vídeo correto
            const isMobile = window.innerWidth < 768;
            const modalVideo = isMobile ? 
                document.getElementById('modalCameraVideo') : 
                document.getElementById('modalCameraVideoDesktop');
            
            if (modalStream) {
                modalStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                // Obter qualidade selecionada (procurar em mobile e desktop)
                const selectedQuality = 
                    document.querySelector('input[name="photoQuality"]:checked')?.value ||
                    document.querySelector('input[name="photoQualityDesktop"]:checked')?.value || 
                    'med';
                const qualitySettings = QUALITY_SETTINGS[selectedQuality];
                
                // Construir constraints com qualidade e câmera
                const constraints = {
                    video: {
                        ...qualitySettings.video,
                        ...(deviceId ? { deviceId: { exact: deviceId } } : {})
                    }
                };
                
                console.log('Iniciando câmera com qualidade:', qualitySettings.label);
                modalStream = await navigator.mediaDevices.getUserMedia(constraints);
                modalVideo.srcObject = modalStream;
                
                // Salvar a câmera selecionada no localStorage
                if (deviceId) {
                    localStorage.setItem(CAMERA_STORAGE_KEY, deviceId);
                }
            } catch (error) {
                console.error('Erro ao acessar câmera:', error);
                // Se falhar com a câmera específica, tentar a padrão
                if (deviceId) {
                    await startModalCamera();
                } else {
                    alert('Erro ao acessar a câmera. Verifique as permissões.');
                }
            }
        }
        
        function stopModalCamera() {
            if (modalStream) {
                modalStream.getTracks().forEach(track => track.stop());
                modalStream = null;
            }
        }
        
        // Event listeners básicos para o modal (a inicialização completa está no sistema de guias)
        document.getElementById('capturePhotoModal').addEventListener('hidden.bs.modal', function () {
            stopModalCamera();
        });

        // Função para captura de foto que funciona tanto para mobile quanto desktop
        function capturePhoto(captureButton) {
            // Detectar qual vídeo está ativo (mobile ou desktop)
            const isMobile = window.innerWidth < 768;
            const modalVideo = isMobile ? 
                document.getElementById('modalCameraVideo') : 
                document.getElementById('modalCameraVideoDesktop');
            
            if (!window.currentProcesso) {
                alert('Erro: processo não identificado.');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = modalVideo.videoWidth;
            canvas.height = modalVideo.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(modalVideo, 0, 0, canvas.width, canvas.height);
            
            // Obter qualidade selecionada (mobile ou desktop)
            const selectedQuality = 
                document.querySelector('input[name="photoQuality"]:checked')?.value ||
                document.querySelector('input[name="photoQualityDesktop"]:checked')?.value || 
                'med';
            const jpegQuality = QUALITY_SETTINGS[selectedQuality].jpeg;
            
            console.log('Capturando foto com qualidade JPEG:', jpegQuality);
            const photoData = canvas.toDataURL('image/jpeg', jpegQuality);
            
            // Mostrar feedback visual
            captureButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processando...';
            captureButton.disabled = true;
            
            const uploadUrl = "{{ url_for('upload_photo', nome_seguro=current_turma.nome_seguro, processo='PROCESSO_PLACEHOLDER') }}".replace('PROCESSO_PLACEHOLDER', window.currentProcesso);
            fetch(uploadUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: photoData })
            })
            .then(response => {
                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('capturePhotoModal'));
                    modal.hide();
                    
                    // Restaurar botão de captura
                    captureButton.innerHTML = '<i class="bi bi-camera me-2"></i>Capturar Foto';
                    captureButton.disabled = false;
                    
                    // Atualizar foto dinamicamente sem recarregar a página
                    updateStudentPhotoAfterCapture(window.currentProcesso);
                    
                    // Criar mensagem de sucesso
                    createFlashMessage(`Foto capturada com sucesso para ${window.currentProcesso}!`, 'success');
                } else {
                    throw new Error('Erro no upload');
                }
            })
            .catch(error => {
                console.error('Erro ao fazer upload:', error);
                alert('Erro ao salvar a foto. Tente novamente.');
                
                // Restaurar botão de captura
                captureButton.innerHTML = '<i class="bi bi-camera me-2"></i>Capturar Foto';
                captureButton.disabled = false;
            });
        }

        // Event listeners para ambos os botões de captura
        document.getElementById('modalCaptureButton').addEventListener('click', function() {
            capturePhoto(this);
        });
        
        document.getElementById('modalCaptureButtonDesktop').addEventListener('click', function() {
            capturePhoto(this);
        });
        
        // ============ SISTEMA DE GUIAS AUXILIARES ============
        
        // Função para atualizar guias (mobile e desktop)
        function updateGuides() {
            // Mobile
            const guideMobileRadios = document.querySelectorAll('input[name="guideMobile"]');
            const selectedMobileGuide = [...guideMobileRadios].find(radio => radio.checked)?.value || 'cross';
            
            const gCrossMobile = document.getElementById('guide-cross-mobile');
            const gThirdsMobile = document.getElementById('guide-thirds-mobile');
            const gSilhouetteMobile = document.getElementById('guide-silhouette-mobile');
            const gFrameMobile = document.getElementById('guide-frame-mobile');
            const silhouetteControlsMobile = document.getElementById('silhouetteControlsMobile');
            
            // Ocultar todas as guias mobile
            gCrossMobile.style.display = 'none';
            gThirdsMobile.style.display = 'none';
            gSilhouetteMobile.style.display = 'none';
            gFrameMobile.style.display = 'none';
            silhouetteControlsMobile.style.display = 'none';
            
            // Mostrar guia selecionada mobile
            switch (selectedMobileGuide) {
                case 'cross':
                    gCrossMobile.style.display = '';
                    break;
                case 'thirds':
                    gThirdsMobile.style.display = '';
                    gFrameMobile.style.display = '';
                    break;
                case 'silhouette':
                    gSilhouetteMobile.style.display = '';
                    silhouetteControlsMobile.style.display = '';
                    break;
                case 'none':
                    // Todas ficam ocultas
                    break;
            }
            
            // Desktop
            const guideDesktopRadios = document.querySelectorAll('input[name="guideDesktop"]');
            const selectedDesktopGuide = [...guideDesktopRadios].find(radio => radio.checked)?.value || 'cross';
            
            const gCrossDesktop = document.getElementById('guide-cross-desktop');
            const gThirdsDesktop = document.getElementById('guide-thirds-desktop');
            const gSilhouetteDesktop = document.getElementById('guide-silhouette-desktop');
            const gFrameDesktop = document.getElementById('guide-frame-desktop');
            const silhouetteControlsDesktop = document.getElementById('silhouetteControlsDesktop');
            
            // Ocultar todas as guias desktop
            gCrossDesktop.style.display = 'none';
            gThirdsDesktop.style.display = 'none';
            gSilhouetteDesktop.style.display = 'none';
            gFrameDesktop.style.display = 'none';
            silhouetteControlsDesktop.style.display = 'none';
            
            // Mostrar guia selecionada desktop
            switch (selectedDesktopGuide) {
                case 'cross':
                    gCrossDesktop.style.display = '';
                    break;
                case 'thirds':
                    gThirdsDesktop.style.display = '';
                    gFrameDesktop.style.display = '';
                    break;
                case 'silhouette':
                    gSilhouetteDesktop.style.display = '';
                    silhouetteControlsDesktop.style.display = '';
                    break;
                case 'none':
                    // Todas ficam ocultas
                    break;
            }
            
            // Salvar preferência no localStorage
            localStorage.setItem('photoGuidePreference', JSON.stringify({
                mobile: selectedMobileGuide,
                desktop: selectedDesktopGuide
            }));
        }
        
        // Função para obter a chave de configuração baseada na qualidade e orientação
        function getSilhouetteStorageKey() {
            // Detectar orientação
            const isVertical = window.innerWidth < window.innerHeight;
            const orientation = isVertical ? 'vertical' : 'horizontal';
            
            // Detectar qualidade selecionada
            const isMobile = window.innerWidth < 768;
            const qualityInputs = isMobile ? 
                document.querySelectorAll('input[name="photoQuality"]') :
                document.querySelectorAll('input[name="photoQualityDesktop"]');
            
            let quality = 'med'; // Default
            for (const input of qualityInputs) {
                if (input.checked) {
                    quality = input.value;
                    break;
                }
            }
            
            return `silhouetteSettings_cam_${quality}_${orientation}`;
        }
        
        // Função para aplicar transformações na silhueta (desktop)
        function applySilhouetteTransform() {
            const scaleSlider = document.getElementById('silhouetteScaleDesktop');
            const offsetSlider = document.getElementById('silhouetteOffsetDesktop');
            const scaleValue = document.getElementById('scaleValueDesktop');
            const offsetValue = document.getElementById('offsetValueDesktop');
            const silhouetteGroup = document.getElementById('guide-silhouette-desktop');
            
            if (scaleSlider && offsetSlider && silhouetteGroup) {
                const scale = parseFloat(scaleSlider.value);
                const offset = parseInt(offsetSlider.value);
                
                // Atualizar transformação (offset vertical aplicado)
                const centerY = 540 + offset; // Centro base + offset
                silhouetteGroup.setAttribute('transform', `translate(500,${centerY}) scale(${scale}) translate(-500,-500)`);
                
                // Atualizar labels de valores
                if (scaleValue) scaleValue.textContent = `${Math.round(scale * 100)}%`;
                if (offsetValue) {
                    if (offset === 0) {
                        offsetValue.textContent = 'Centro';
                    } else if (offset < 0) {
                        offsetValue.textContent = `${Math.abs(offset)}px ↑`;
                    } else {
                        offsetValue.textContent = `${offset}px ↓`;
                    }
                }
                
                // Salvar no localStorage com chave específica
                const storageKey = getSilhouetteStorageKey();
                localStorage.setItem(storageKey, JSON.stringify({
                    scale: scale,
                    offset: offset
                }));
                
                // Debug info
                console.log(`Guardado em: ${storageKey}`, {scale, offset});
            }
        }
        
        // Função para aplicar transformações na silhueta (mobile)
        function applySilhouetteTransformMobile() {
            const scaleSlider = document.getElementById('silhouetteScaleMobile');
            const offsetSlider = document.getElementById('silhouetteOffsetMobile');
            const scaleValue = document.getElementById('scaleValueMobile');
            const offsetValue = document.getElementById('offsetValueMobile');
            const silhouetteGroup = document.getElementById('guide-silhouette-mobile');
            
            if (scaleSlider && offsetSlider && silhouetteGroup) {
                const scale = parseFloat(scaleSlider.value);
                const offset = parseInt(offsetSlider.value);
                
                // Atualizar transformação (offset vertical aplicado)
                const centerY = 540 + offset; // Centro base + offset
                silhouetteGroup.setAttribute('transform', `translate(500,${centerY}) scale(${scale}) translate(-500,-500)`);
                
                // Atualizar labels de valores
                if (scaleValue) scaleValue.textContent = `${Math.round(scale * 100)}%`;
                if (offsetValue) {
                    if (offset === 0) {
                        offsetValue.textContent = 'Centro';
                    } else if (offset < 0) {
                        offsetValue.textContent = `${Math.abs(offset)}px ↑`;
                    } else {
                        offsetValue.textContent = `${offset}px ↓`;
                    }
                }
                
                // Salvar no localStorage com chave específica
                const storageKey = getSilhouetteStorageKey();
                localStorage.setItem(storageKey, JSON.stringify({
                    scale: scale,
                    offset: offset
                }));
                
                // Debug info
                console.log(`Guardado em: ${storageKey}`, {scale, offset});
            }
        }
        
        // Função para carregar configurações da silhueta para o contexto atual
        function loadSilhouetteSettings() {
            const storageKey = getSilhouetteStorageKey();
            const savedSettings = localStorage.getItem(storageKey);
            
            console.log(`Carregando de: ${storageKey}`);
            
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                
                // Desktop sliders
                const scaleSlider = document.getElementById('silhouetteScaleDesktop');
                const offsetSlider = document.getElementById('silhouetteOffsetDesktop');
                
                if (scaleSlider && settings.scale !== undefined) scaleSlider.value = settings.scale;
                if (offsetSlider && settings.offset !== undefined) offsetSlider.value = settings.offset;
                
                // Mobile sliders
                const scaleSliderMobile = document.getElementById('silhouetteScaleMobile');
                const offsetSliderMobile = document.getElementById('silhouetteOffsetMobile');
                
                if (scaleSliderMobile && settings.scale !== undefined) scaleSliderMobile.value = settings.scale;
                if (offsetSliderMobile && settings.offset !== undefined) offsetSliderMobile.value = settings.offset;
                
                console.log(`Configurações carregadas:`, settings);
                return true;
            }
            
            console.log(`Nenhuma configuração encontrada para: ${storageKey}`);
            return false;
        }
        
        // Função para reagir a mudanças de qualidade e recarregar configurações
        function onQualityChange() {
            console.log('Qualidade alterada, recarregando configurações da silhueta...');
            loadSilhouetteSettings();
            applySilhouetteTransform();
            applySilhouetteTransformMobile();
        }

        // Inicializar controles das guias quando o modal abrir
        document.getElementById('capturePhotoModal').addEventListener('shown.bs.modal', function () {
            // Event listeners para guias mobile
            document.querySelectorAll('input[name="guideMobile"]').forEach(radio => {
                radio.addEventListener('change', updateGuides);
            });
            
            // Event listeners para guias desktop
            document.querySelectorAll('input[name="guideDesktop"]').forEach(radio => {
                radio.addEventListener('change', updateGuides);
            });
            
            // Event listeners para controles da silhueta desktop
            const scaleSlider = document.getElementById('silhouetteScaleDesktop');
            const offsetSlider = document.getElementById('silhouetteOffsetDesktop');
            
            if (scaleSlider) {
                scaleSlider.addEventListener('input', applySilhouetteTransform);
            }
            if (offsetSlider) {
                offsetSlider.addEventListener('input', applySilhouetteTransform);
            }
            
            // Event listeners para controles da silhueta mobile
            const scaleSliderMobile = document.getElementById('silhouetteScaleMobile');
            const offsetSliderMobile = document.getElementById('silhouetteOffsetMobile');
            
            if (scaleSliderMobile) {
                scaleSliderMobile.addEventListener('input', applySilhouetteTransformMobile);
            }
            if (offsetSliderMobile) {
                offsetSliderMobile.addEventListener('input', applySilhouetteTransformMobile);
            }
            
            // Restaurar preferências do localStorage
            try {
                const savedGuides = localStorage.getItem('photoGuidePreference');
                if (savedGuides) {
                    const guides = JSON.parse(savedGuides);
                    
                    // Aplicar preferência mobile
                    const mobileRadio = document.querySelector(`input[name="guideMobile"][value="${guides.mobile}"]`);
                    if (mobileRadio) mobileRadio.checked = true;
                    
                    // Aplicar preferência desktop
                    const desktopRadio = document.querySelector(`input[name="guideDesktop"][value="${guides.desktop}"]`);
                    if (desktopRadio) desktopRadio.checked = true;
                }
                
                // Carregar configurações da silhueta específicas para qualidade/orientação atual
                loadSilhouetteSettings();
                
            } catch (e) {
                console.log('Erro ao restaurar preferências das guias:', e);
            }
            
            // Event listeners para mudanças de qualidade (recarregar configurações da silhueta)
            document.querySelectorAll('input[name="photoQuality"], input[name="photoQualityDesktop"]').forEach(radio => {
                radio.addEventListener('change', onQualityChange);
            });
            
            // Event listener para mudanças de orientação (resize)
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    console.log('Orientação alterada, recarregando configurações...');
                    loadSilhouetteSettings();
                    updateGuides();
                    applySilhouetteTransform();
                    applySilhouetteTransformMobile();
                }, 300);
            });
            
            // Aplicar guias iniciais
            updateGuides();
            applySilhouetteTransform();
            applySilhouetteTransformMobile();
            
            // Inicializar qualidade da foto
            initPhotoQuality();
            
            // Inicializar câmera
            initModalCamera();
            
            // Re-inicializar listeners de redimensionamento para detectar mudanças de orientação
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    initModalCamera(); // Re-inicializar câmera se necessário
                    updateGuides(); // Re-aplicar guias após mudança de orientação
                }, 300);
            });
        });
        
        // ============ FIM DO SISTEMA DE GUIAS AUXILIARES ============
        
        // Função para atualizar a foto do aluno dinamicamente após captura
        function updateStudentPhotoAfterCapture(processo) {
            // Encontrar o card do aluno pelo processo
            const alunoData = alunosData.find(a => a.processo === processo);
            
            if (!alunoData) {
                console.error('Aluno não encontrado para processo:', processo);
                return;
            }
            
            // Encontrar o card do aluno pelo atributo data-aluno-processo
            const targetCard = document.querySelector(`[data-aluno-processo="${processo}"]`);
            
            if (!targetCard) {
                console.error('Card do aluno não encontrado para processo:', processo);
                return;
            }
            
            // Encontrar a imagem dentro do card
            const photoImg = targetCard.querySelector('.photo-img');
            const photoContainer = targetCard.querySelector('.student-photo');
            const studentActions = targetCard.querySelector('.student-actions');
            
            if (!photoImg || !photoContainer) {
                console.error('Elementos da foto não encontrados:', {photoImg, photoContainer});
                return;
            }
            
            // Adicionar timestamp para forçar reload da imagem (cache busting)
            const timestamp = new Date().getTime();
            const newPhotoUrl = "{{ url_for('get_photo', folder_name=current_turma.nome_seguro, processo='PROCESSO_PLACEHOLDER') }}".replace('PROCESSO_PLACEHOLDER', processo) + `?t=${timestamp}`;
            
            // Criar nova imagem para pré-carregar
            const newImg = new Image();
            
            newImg.onload = function() {
                // Atualizar a imagem principal
                photoImg.src = newPhotoUrl;
                photoImg.alt = `Foto de ${alunoData.nome}`;
                photoImg.classList.remove('placeholder');
                
                // Adicionar onclick para captura de foto se for editor/admin
                const userRole = '{{ current_user.role }}';
                if (['editor', 'admin'].includes(userRole)) {
                    photoImg.onclick = function() { goToCapturePhoto(processo); };
                    photoImg.style.cursor = 'pointer';
                }
                const cameraBtn = photoContainer.querySelector('.btn-secondary');
                if (cameraBtn) {
                    // Criar botão de remover foto
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle remove-photo-btn';
                    removeBtn.setAttribute('data-id', String(alunoData.id));
                    removeBtn.setAttribute('data-nome', alunoData.nome);
                    removeBtn.setAttribute('data-bs-toggle', 'modal');
                    removeBtn.setAttribute('data-bs-target', '#removePhotoModal');
                    removeBtn.title = 'Clique para remover a foto';
                    removeBtn.style.cssText = 'width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = function(event) {
                        event.stopPropagation();
                    };
                    removeBtn.innerHTML = '<i class="bi bi-x photo-status-icon-xs"></i>';
                    
                    // Adicionar event listener para o modal de remover foto
                    removeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const id = this.dataset.id;
                        const nome = this.dataset.nome;
                        
                        document.getElementById('removePhotoAlunoId').value = id;
                        document.getElementById('removePhotoStudentName').textContent = nome;
                    });
                    
                    // Substituir botão de câmera pelo de remover
                    photoContainer.replaceChild(removeBtn, cameraBtn);
                }
                
                // Adicionar ícone de "foto recente" no canto superior esquerdo
                if (!photoContainer.querySelector('.recent-photo-icon')) {
                    const recentIcon = document.createElement('div');
                    recentIcon.className = 'position-absolute top-0 start-0 m-1 recent-photo-icon';
                    
                    // Verificar autorização para definir cor e título
                    if (alunoData.autorizacao) {
                        recentIcon.title = 'Foto tirada - Autorização concedida';
                        recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #28a745; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                    } else {
                        recentIcon.title = 'Foto tirada - Autorização NÃO concedida';
                        recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #dc3545; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                    }
                    
                    recentIcon.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    photoContainer.appendChild(recentIcon);
                }
                
                // Mostrar botão de preview (sempre presente, mas oculto se não há foto)
                if (studentActions) {
                    const previewBtn = studentActions.querySelector('.preview-photo-btn');
                    if (previewBtn) {
                        previewBtn.style.display = 'inline-block';
                    }
                }
                
                // Atualizar contador de fotos na navbar
                updatePhotoCounter();
                
                // Adicionar efeito visual de "nova foto"
                photoImg.style.opacity = '0';
                photoImg.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    photoImg.style.transition = 'all 0.3s ease';
                    photoImg.style.opacity = '1';
                    photoImg.style.transform = 'scale(1)';
                }, 100);
            };
            
            newImg.onerror = function() {
                console.error('Erro ao carregar nova foto do aluno:', processo);
                createFlashMessage('Erro ao atualizar foto. Tente novamente.', 'error');
            };
            
            // Iniciar carregamento da nova imagem
            newImg.src = newPhotoUrl;
        }
        
        // Função para atualizar contador de fotos na navbar
        function updatePhotoCounter() {
            const navbarInfo = document.querySelector('.navbar-brand small');
            if (navbarInfo) {
                // Contar fotos atuais na página
                const photosCount = document.querySelectorAll('.photo-img:not(.placeholder)').length;
                const totalStudents = alunosData.length;
                
                navbarInfo.innerHTML = `${totalStudents} aluno${totalStudents !== 1 ? 's' : ''} • ${photosCount} foto${photosCount !== 1 ? 's' : ''}`;
            }
        }
        
        // Função para atualizar a foto do aluno dinamicamente após remoção
        function updateStudentPhotoAfterRemoval(alunoId, studentName) {
            // Encontrar o card do aluno pelo ID
            const allCards = document.querySelectorAll('.student-card');
            let targetCard = null;
            
            // Procurar o card que contém este aluno pelo botão de remoção
            allCards.forEach(card => {
                const removeBtn = card.querySelector('.remove-photo-btn');
                if (removeBtn && removeBtn.dataset.id === alunoId) {
                    targetCard = card;
                }
            });
            
            if (!targetCard) {
                console.error('Card do aluno não encontrado para ID:', alunoId);
                return;
            }
            
            // Encontrar elementos dentro do card
            const photoImg = targetCard.querySelector('.photo-img');
            const photoContainer = targetCard.querySelector('.student-photo');
            const studentActions = targetCard.querySelector('.student-actions');
            const removeBtn = photoContainer.querySelector('.remove-photo-btn');
            const previewBtn = studentActions ? studentActions.querySelector('.preview-photo-btn') : null;
            
            if (!photoImg || !photoContainer) {
                console.error('Elementos da foto não encontrados no card');
                return;
            }
            
            // Reverter imagem para placeholder
            photoImg.src = "{{ url_for('static', filename='student_icon.jpg') }}";
            photoImg.alt = "Clique para capturar foto";
            photoImg.classList.add('placeholder');
            
            // Remover botão de remoção de foto e adicionar botão de câmera
            if (removeBtn) {
                // Obter processo do aluno para o botão de câmera
                const alunoProcesso = targetCard.getAttribute('data-aluno-processo');
                
                // Criar botão de câmera
                const cameraBtn = document.createElement('button');
                cameraBtn.className = 'btn btn-sm btn-secondary position-absolute top-0 end-0 m-1 rounded-circle';
                cameraBtn.title = 'Clique para capturar foto';
                cameraBtn.style.cssText = 'width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center;';
                cameraBtn.onclick = function(event) {
                    event.stopPropagation();
                    goToCapturePhoto(alunoProcesso);
                };
                cameraBtn.innerHTML = '<i class="bi bi-camera photo-status-icon-xs"></i>';
                
                // Substituir botão de remover pelo de câmera
                photoContainer.replaceChild(cameraBtn, removeBtn);
            }
            
            // Trocar ícone de "foto tirada" pelo ícone de "foto não tirada"
            const recentIcon = photoContainer.querySelector('.recent-photo-icon');
            if (recentIcon) {
                // Atualizar para emoji tonto (foto não tirada)
                recentIcon.title = 'Foto não tirada';
                recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #ffc107; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                recentIcon.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
            } else {
                // Criar ícone de "foto não tirada" se não existir
                const dizzyIcon = document.createElement('div');
                dizzyIcon.className = 'position-absolute top-0 start-0 m-1 recent-photo-icon';
                dizzyIcon.title = 'Foto não tirada';
                dizzyIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #ffc107; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                dizzyIcon.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
                photoContainer.appendChild(dizzyIcon);
            }
            
            // Ocultar botão de preview se existir
            if (previewBtn) {
                previewBtn.style.display = 'none';
            }
            
            // Atualizar contador de fotos na navbar
            updatePhotoCounter();
            
            // Criar mensagem flash dinâmica
            createFlashMessage(`Foto de ${studentName} removida com sucesso!`, 'success');
            
            // Adicionar efeito visual de "foto removida"
            photoImg.style.opacity = '0';
            photoImg.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                photoImg.style.transition = 'all 0.3s ease';
                photoImg.style.opacity = '1';
                photoImg.style.transform = 'scale(1)';
            }, 100);
        }
        
        // Função para criar mensagem flash dinâmica que imita o sistema Flask
        function createFlashMessage(message, category) {
            // Encontrar o container das mensagens flash existentes
            const flashContainer = document.querySelector('.container .alert');
            let targetContainer;
            
            if (flashContainer) {
                // Se já existem mensagens flash, usar o mesmo container
                targetContainer = flashContainer.parentElement;
            } else {
                // Se não existem mensagens, criar container após a navbar
                const navbar = document.querySelector('.navbar');
                targetContainer = document.createElement('div');
                targetContainer.className = 'container mt-3';
                navbar.parentNode.insertBefore(targetContainer, navbar.nextSibling);
            }
            
            // Criar a mensagem flash com o mesmo estilo das mensagens Flask
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${category === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            
            const iconClass = category === 'error' ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill';
            
            alertDiv.innerHTML = `
                <i class="bi ${iconClass} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            targetContainer.appendChild(alertDiv);
            
            // Remover automaticamente após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                    // Se não há mais mensagens, remover o container
                    if (targetContainer.children.length === 0 && !targetContainer.querySelector('.alert')) {
                        targetContainer.remove();
                    }
                }
            }, 5000);
        }

        // Atalhos de teclado no modal
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('capturePhotoModal');
            const isModalOpen = modal.classList.contains('show');
            
            if (isModalOpen) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('modalCaptureButton').click();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();
                }
            }
        });

        // Função para mostrar/ocultar notas dos alunos
        function toggleStudentNotes(alunoId) {
            const notesDiv = document.getElementById(`notes-${alunoId}`);
            const toggleBtn = document.querySelector(`[data-aluno-id="${alunoId}"].notes-toggle-btn`);
            
            if (!notesDiv || !toggleBtn) return;
            
            // Se as notas estão visíveis, oculta elas
            if (notesDiv.style.display !== 'none') {
                hideStudentNotes(alunoId);
                return;
            }
            
            // Mostra as notas
            notesDiv.style.display = 'block';
            
            // Muda o ícone para indicar que as notas estão visíveis
            const icon = toggleBtn.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-sticky-fill text-warning notes-icon-xs';
                toggleBtn.title = 'Ocultar notas do aluno';
                toggleBtn.classList.remove('btn-info');
                toggleBtn.classList.add('btn-warning');
            }
            
            // Configura o timer para ocultar automaticamente após 10 segundos
            setTimeout(() => {
                hideStudentNotes(alunoId);
            }, 10000); // 10 segundos
        }
        
        // Função para ocultar notas
        function hideStudentNotes(alunoId) {
            const notesDiv = document.getElementById(`notes-${alunoId}`);
            const toggleBtn = document.querySelector(`[data-aluno-id="${alunoId}"].notes-toggle-btn`);
            
            if (!notesDiv || !toggleBtn) return;
            
            // Adiciona classe de fade out
            notesDiv.classList.add('fade-out');
            
            // Após a animação, oculta completamente
            setTimeout(() => {
                notesDiv.style.display = 'none';
                notesDiv.classList.remove('fade-out');
                
                // Restaura o ícone original
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    icon.className = 'bi bi-pencil-fill text-white notes-icon-xs';
                    toggleBtn.title = 'Mostrar notas do aluno';
                    toggleBtn.classList.remove('btn-warning');
                    toggleBtn.classList.add('btn-info');
                }
            }, 300); // Tempo da animação
        }

        // ========== FUNCIONALIDADE DE ATA LHOS PARA NOTAS ==========
        // Textos de atalho para notas dos alunos
        const notesShortcuts = {
            'Crohn': 'Doença de Crohn',
            'Celíaco': 'Celíaco',

            'Glúten': 'Intolerância ao Glúten',
            'Lactose': 'Intolerância à Lactose',
            'Leguminosas': 'Intolerância às Leguminosas',
            'Ovos': 'Intolerância aos Ovos',
            'Marisco': 'Intolerância ao Marisco',
            'Peixe': 'Intolerância ao Peixe',
            'Salsicha': 'Intolerância Salsicha de Conserva',

            'Leite': 'Alergia à proteína do leite',
            'Atum': 'Alergia ao Atum',
            
            'Porco': 'Carne de Porco',
            'Halal': 'Comida Halal'
        };

        // Função para injetar texto na textarea
        function injectNoteText(textareaId, text) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            const currentValue = textarea.value.trim();
            const newText = text;

            // Se já houver texto, adicionar uma vírgula e espaço
            if (currentValue) {
                textarea.value = currentValue + ', ' + newText;
            } else {
                textarea.value = newText;
            }

            // Focar na textarea e posicionar cursor no final
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            // Trigger input event para validações
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // Criar botões de atalho para uma textarea específica
        function createNotesShortcutButtons(textareaId, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Criar scroll container
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'notes-shortcuts-container';
            scrollContainer.style.cssText = `
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
                padding: 0.5rem 0;
                margin-top: 0.5rem;
                scrollbar-width: thin;
                scrollbar-color: #6c757d #f8f9fa;
            `;

            // Adicionar scrollbar customizado para webkit
            const style = document.createElement('style');
            style.textContent = `
                .notes-shortcuts-container::-webkit-scrollbar {
                    height: 6px;
                }
                .notes-shortcuts-container::-webkit-scrollbar-track {
                    background: #f8f9fa;
                    border-radius: 3px;
                }
                .notes-shortcuts-container::-webkit-scrollbar-thumb {
                    background: #6c757d;
                    border-radius: 3px;
                }
                .notes-shortcuts-container::-webkit-scrollbar-thumb:hover {
                    background: #5a6268;
                }
            `;
            document.head.appendChild(style);

            // Criar botões para cada atalho
            Object.keys(notesShortcuts).forEach(shortcut => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-outline-secondary btn-sm notes-shortcut-btn';
                button.textContent = shortcut;
                button.title = `Inserir: ${notesShortcuts[shortcut]}`;
                button.style.cssText = `
                    white-space: nowrap;
                    flex-shrink: 0;
                    font-size: 0.75rem;
                    padding: 0.25rem 0.5rem;
                    border-radius: 0.375rem;
                `;

                // Adicionar evento de clique
                button.addEventListener('click', () => {
                    injectNoteText(textareaId, notesShortcuts[shortcut]);
                });

                scrollContainer.appendChild(button);
            });

            container.appendChild(scrollContainer);
        }

        // Inicializar botões de atalho quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Botões para modal de adicionar aluno
            createNotesShortcutButtons('studentNotes', 'studentNotesContainer');

            // Botões para modal de editar aluno
            createNotesShortcutButtons('editStudentNotes', 'editStudentNotesContainer');
        });

        // === FUNÇÕES PARA MODAL DE NOTIFICAÇÃO ===
        function openNotificationModal() {
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
        }

        // Função para enviar notificação por email
        document.getElementById('notificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const email = formData.get('email');
            const subject = formData.get('subject');
            const body = formData.get('body');
            const turmaNome = formData.get('turma_nome');
            const turmaNomeSeguro = formData.get('turma_nome_seguro');

            // Validar se o email está preenchido
            if (!email || !email.trim()) {
                // Em vez de alert, vamos mostrar uma mensagem de erro no modal
                showModalAlert('Email do professor não está configurado para esta turma.', 'danger');
                return;
            }

            // Mostrar loading no botão
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
            submitButton.disabled = true;

            try {
                // Tentar enviar via AJAX primeiro
                const response = await fetch('/api/send_notification_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrf_token')
                    },
                    body: JSON.stringify({
                        email: email,
                        subject: subject,
                        body: body,
                        turma_nome: turmaNome,
                        turma_nome_seguro: turmaNomeSeguro
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Em vez de alert, vamos mostrar uma mensagem de sucesso no modal
                    showModalAlert('Email de notificação enviado com sucesso! O processamento será feito em segundo plano.', 'success');
                    // Fechar modal após 2 segundos
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('notificationModal'));
                        modal.hide();
                        this.reset();
                    }, 2000);
                } else {
                    // Em vez de alert, mostrar erro no modal
                    showModalAlert('Erro ao enviar email: ' + (result.error || 'Erro desconhecido'), 'danger');
                }

            } catch (error) {
                console.error('Erro AJAX:', error);
                // Fallback: enviar como formulário normal para usar flash messages
                console.log('Tentando fallback com submissão de formulário...');
                this.submit();
            } finally {
                // Restaurar botão
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // Função auxiliar para mostrar alertas no modal
        function showModalAlert(message, type = 'info') {
            // Remover alertas anteriores
            const existingAlerts = document.querySelectorAll('.modal-alert');
            existingAlerts.forEach(alert => alert.remove());

            // Criar novo alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show modal-alert mt-2`;
            alertDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info'}-fill me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Inserir no modal
            const modalBody = document.querySelector('#notificationModal .modal-body');
            if (modalBody) {
                modalBody.insertBefore(alertDiv, modalBody.firstChild);
            }
        }

    </script>
</body>
</html>
