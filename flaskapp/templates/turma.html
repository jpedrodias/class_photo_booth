<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Turma {{ turma }} - Class Photo Booth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body class="turma-page">
    <!-- Navbar -->
    <nav class="navbar navbar-dark navbar-custom navbar-expand-lg py-3">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <span class="display-6 me-2">🎓</span>
                <div>
                    <div class="fw-bold">Turma {{ turma }}</div>
                    <small class="text-white-50 d-block">{{ alunos|length }} aluno{{ 's' if alunos|length != 1 else '' }} • {{ fotos_existentes }} foto{{ 's' if fotos_existentes != 1 else '' }}</small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <a href="{{ url_for('turmas') }}" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Voltar">
                    <i class="bi bi-arrow-left me-1"></i>
                    <span class="d-none d-md-inline">Voltar</span>
                </a>
                
                <div class="dropdown">
                    <button class="btn btn-light btn-sm rounded-pill px-3 dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Download">
                        <i class="bi bi-download me-1"></i>
                        <span class="d-none d-md-inline">Download</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="downloadDropdown">
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.zip') }}">
                            <i class="bi bi-file-earmark-zip me-2 text-primary"></i> {{ nome_seguro }}.zip
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.thumbs.zip') }}">
                            <i class="bi bi-file-earmark-zip-fill me-2 text-info"></i> {{ nome_seguro }}.thumbs.zip
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.docx') }}">
                            <i class="bi bi-file-earmark-word me-2 text-success"></i> {{ nome_seguro }}.docx
                        </a></li>
                    </ul>
                </div>
                
                <button onclick="confirmLogout()" class="btn btn-outline-light btn-sm rounded-pill px-3" title="Sair">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Sair</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mensagens flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else ('info' if category == 'info' else 'success') }} alert-dismissible fade show" role="alert">
                        {% if category == 'error' %}
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        {% elif category == 'info' %}
                            <i class="bi bi-info-circle-fill me-2"></i>
                        {% else %}
                            <i class="bi bi-check-circle-fill me-2"></i>
                        {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main class="container my-4 mb-md-5 mb-lg-4">
        <div class="row g-3">
            <!-- Card para adicionar novo aluno -->
            {% if current_user.role in ['editor', 'admin'] %}
            <div class="col-6 col-md-4 col-lg-3 col-xl-3">
                <div class="student-card text-center h-100 cursor-pointer" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <div class="student-photo">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <i class="bi bi-person-plus-fill text-primary add-student-icon"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-bold text-primary mb-1">Adicionar Aluno</h6>
                    <small class="text-muted">Novo aluno</small>
                </div>
                </div>
            </div>
            {% endif %}
        
        {% for aluno in alunos %}
        <div class="col-6 col-md-4 col-lg-3 col-xl-3">
            {% if current_user.role in ['editor', 'admin'] %}
            <div class="student-card h-100" 
                data-aluno-id="{{ aluno.id }}" 
                data-aluno-nome="{{ aluno.nome }}" 
                data-aluno-processo="{{ aluno.processo }}"
                ondragover="event.preventDefault(); this.classList.add('dragover');" 
                ondragleave="this.classList.remove('dragover');" 
                ondrop="handleStudentCardDrop(event, this);">
            {% else %}
            <div class="student-card h-100 cursor-default"
                data-aluno-id="{{ aluno.id }}" data-aluno-nome="{{ aluno.nome }}" data-aluno-processo="{{ aluno.processo }}"
                ondragover="event.preventDefault(); this.classList.add('dragover');" 
                ondragleave="this.classList.remove('dragover');" 
                ondrop="handleStudentCardDrop(event, this);">
            {% endif %}
                <div class="student-photo position-relative">

                    {% if aluno.foto_existe or aluno.foto_tirada %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <img src="{{ url_for('get_photo', folder_name=nome_seguro, processo=aluno.processo) }}" 
                             alt="Foto de {{ aluno.nome }}" 
                             class="photo-img cursor-pointer"
                             onclick="goToCapturePhoto('{{ aluno.processo }}')">
                        {% else %}
                        <img src="{{ url_for('get_photo', folder_name=nome_seguro, processo=aluno.processo) }}" 
                             alt="Foto de {{ aluno.nome }}" 
                             class="photo-img">
                        {% endif %}
                        
                        <!-- Ícone de foto recente (canto superior esquerdo) -->
                        {% if aluno.foto_tirada %}
                            {% if aluno.autorizacao %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge success" 
                             title="Foto tirada - Autorização concedida">
                            <i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>
                        </div>
                            {% else %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge danger" 
                             title="Foto tirada - Autorização NÃO concedida">
                            <i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>
                        </div>
                            {% endif %}
                        {% else %}
                        <div class="position-absolute top-0 start-0 m-1 photo-status-badge warning" 
                             title="Foto não tirada">
                            <i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>
                        </div>
                        {% endif %}
                        
                        {% if current_user.role in ['editor', 'admin'] %}
                        <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle remove-photo-btn photo-remove-btn" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#removePhotoModal"
                            title="Clique para remover a foto"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-x photo-status-icon-xs"></i>
                        </button>
                        {% endif %}
                    {% else %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <img src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Sem foto" 
                             class="photo-img placeholder cursor-pointer"
                             onclick="goToCapturePhoto('{{ aluno.processo }}')">
                        {% else %}
                        <img src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Sem foto" 
                             class="photo-img placeholder">
                        {% endif %}
                        {% if current_user.role in ['editor', 'admin'] %}
                        <button class="btn btn-sm btn-secondary position-absolute top-0 end-0 m-1 rounded-circle photo-remove-btn" 
                            title="Clique para tirar foto"
                            onclick="event.stopPropagation(); goToCapturePhoto('{{ aluno.processo }}');">
                            <i class="bi bi-camera photo-status-icon-xs"></i>
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="student-info">
                    <div class="student-name">{{ aluno.nome }} </div>
                    <div class="student-number">
                        {% if aluno.numero %}
                            Nº {{ aluno.numero }} • Proc. {{ aluno.processo }}
                        {% else %}
                            Proc. {{ aluno.processo }}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Botões de ação do aluno -->
                <div class="student-actions mt-2">
                    <!-- Botão de preview sempre presente, mas oculto se não há foto -->
                    <button class="btn btn-sm btn-outline-info preview-photo-btn" 
                            data-processo="{{ aluno.processo }}" 
                            data-nome="{{ aluno.nome }}"
                            data-turma="{{ aluno.turma }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#previewPhotoModal"
                            onclick="event.stopPropagation(); openPreviewModal('{{ aluno.processo }}', '{{ aluno.nome }}', '{{ aluno.turma }}');"
                            title="Preview da foto original"
                            {% if aluno.foto_existe %}style="display: inline-block;"{% else %}style="display: none;"{% endif %}>
                        <i class="bi bi-eye"></i>
                    </button>

                    {% if current_user.role in ['editor', 'admin'] %}
                    <button class="btn btn-sm btn-outline-warning transfer-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}"
                            data-turma-atual="{{ turma }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#manualUploadPhotoStudentModal"
                            title="Upload de foto do aluno"
                            onclick="event.stopPropagation();">
                            <i class="bi bi-file-earmark-person-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary edit-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}" 
                            data-numero="{{ aluno.numero or '' }}"
                            data-email="{{ aluno.email or '' }}"
                            data-autorizacao="{{ 'true' if aluno.autorizacao else 'false' }}"
                            data-autorizacao-debug="{{ aluno.autorizacao }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#editStudentModal"
                            title="Editar aluno"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning transfer-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}" 
                            data-processo="{{ aluno.processo }}"
                            data-turma-atual="{{ turma }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#transferStudentModal"
                            title="Transferir aluno para outra turma"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-arrow-right"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-student-btn stay-on-page" 
                            data-id="{{ aluno.id }}" 
                            data-nome="{{ aluno.nome }}"
                            data-bs-toggle="modal" 
                            data-bs-target="#deleteStudentModal"
                            title="Excluir aluno"
                            onclick="event.stopPropagation();">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Modal para adicionar aluno -->
    <div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStudentModalLabel">
                        <i class="bi bi-person-plus-fill me-2"></i>
                        Adicionar Aluno - Turma {{ turma }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="addStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_add_new">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        
                        <div class="mb-3">
                            <label for="studentName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control input-base" id="studentName" name="nome" required 
                                   placeholder="Digite o nome completo do aluno" maxlength="200">
                        </div>

                        <div class="mb-3">
                            <label for="studentNumber" class="form-label">Número na Turma</label>
                            <input type="number" class="form-control input-base" id="studentNumber" name="numero" 
                                   placeholder="Digite o número na turma (opcional)" min="1" max="999">
                        </div>

                        <div class="mb-3">
                            <label for="studentProcess" class="form-label">Número do Processo</label>
                            <input type="number" class="form-control input-base" id="studentProcess" name="processo" required 
                                   placeholder="Ex: NIF, número de estudante, etc." min="1" step="1">
                            <div class="form-text">Apenas números inteiros positivos (ex: NIF, número de estudante)</div>
                        </div>

                        <div class="mb-3">
                            <label for="studentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control input-base" id="studentEmail" name="email" 
                                   placeholder="Digite o email do aluno (opcional)" maxlength="255">
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="studentAutorizacao" name="autorizacao" checked>
                                <label class="form-check-label" for="studentAutorizacao">
                                    <strong>Autorização para Redes Sociais</strong>
                                </label>
                            </div>
                            <div class="form-text">O aluno autorizou o uso da sua imagem em redes sociais</div>
                        </div>

                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Informações importantes:</strong><br>
                                • O número do processo deve ser único dentro da turma<br>
                                • O número na turma é opcional e pode repetir<br>
                                • A listagem será ordenada pelo número na turma<br>
                                • O nome pode ter até 200 caracteres<br>
                                • O número do processo pode ter até 50 caracteres
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle"></i> Adicionar Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar aluno -->
    <div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editStudentModalLabel">
                        <i class="bi bi-pencil-fill me-2"></i>
                        Editar Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="editStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_edit">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        <input type="hidden" name="aluno_id" id="editAlunoId">
                        
                        <div class="mb-3">
                            <label for="editStudentName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control input-base" id="editStudentName" name="nome" required 
                                   placeholder="Digite o nome completo do aluno" maxlength="200">
                        </div>

                        <div class="mb-3">
                            <label for="editStudentNumber" class="form-label">Número na Turma</label>
                            <input type="number" class="form-control input-base" id="editStudentNumber" name="numero" 
                                   placeholder="Digite o número na turma (opcional)" min="1" max="999">
                        </div>

                        <div class="mb-3">
                            <label for="editStudentProcess" class="form-label">Número do Processo</label>
                            <input type="number" class="form-control input-base" id="editStudentProcess" name="processo" required 
                                   placeholder="Ex: NIF, número de estudante, etc." min="1" step="1">
                            <div class="form-text">Apenas números inteiros positivos (ex: NIF, número de estudante)</div>
                        </div>

                        <div class="mb-3">
                            <label for="editStudentEmail" class="form-label">Email</label>
                            <input type="email" class="form-control input-base" id="editStudentEmail" name="email" 
                                   placeholder="Digite o email do aluno (opcional)" maxlength="255">
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editStudentAutorizacao" name="autorizacao">
                                <label class="form-check-label" for="editStudentAutorizacao">
                                    <strong>Autorização para Redes Sociais</strong>
                                </label>
                            </div>
                            <div class="form-text">O aluno autorizou o uso da sua imagem em redes sociais</div>
                        </div>

                        <div class="alert alert-warning d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle me-2 mt-1"></i>
                            <div>
                                <strong>Atenção:</strong><br>
                                • Alterar o número do processo pode afetar fotos já tiradas<br>
                                • O número do processo deve ser único na turma
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para excluir aluno -->
    <div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteStudentModalLabel">
                        <i class="bi bi-trash-fill me-2"></i>
                        Excluir Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="deleteStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_delete">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        <input type="hidden" name="aluno_id" id="deleteAlunoId">
                        
                        <div class="alert alert-danger d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Atenção:</strong><br>
                                Esta ação não pode ser desfeita!
                            </div>
                        </div>
                        
                        <p class="mb-0">
                            Tem certeza que deseja excluir o aluno <strong id="deleteStudentName"></strong>?
                        </p>
                        <p class="text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            A foto do aluno também será removida permanentemente.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Excluir Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para transferir aluno -->
    <div class="modal fade" id="transferStudentModal" tabindex="-1" aria-labelledby="transferStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transferStudentModalLabel">
                        <i class="bi bi-arrow-right-circle-fill me-2"></i>
                        Transferir Aluno
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="transferStudentForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_transfer">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        <input type="hidden" name="aluno_id" id="transferAlunoId">
                        
                        <div class="mb-3">
                            <p class="mb-2">
                                <strong>Aluno:</strong> <span id="transferStudentName"></span><br>
                                <strong>Turma atual:</strong> <span id="transferCurrentTurma"></span>
                            </p>
                        </div>

                        <div class="mb-3">
                            <label for="transferTargetTurma" class="form-label">Turma de Destino</label>
                            <select class="form-select input-base" id="transferTargetTurma" name="turma_destino" required>
                                <option value="">Selecione a turma de destino</option>
                                <!-- Opções serão carregadas dinamicamente -->
                            </select>
                        </div>

                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Informações importantes:</strong><br>
                                • O aluno será movido para a turma selecionada<br>
                                • A foto do aluno será transferida junto<br>
                                • O número do processo deve ser único na turma de destino<br>
                                • Esta operação não pode ser desfeita facilmente
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-right-circle"></i> Transferir Aluno
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para remover foto -->
    <div class="modal fade" id="removePhotoModal" tabindex="-1" aria-labelledby="removePhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removePhotoModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Remover Foto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="removePhotoForm">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_remove_photo">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        <input type="hidden" name="aluno_id" id="removePhotoAlunoId">
                        
                        <div class="alert alert-warning d-flex align-items-start">
                            <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                            <div>
                                <strong>Atenção:</strong><br>
                                Esta ação irá remover apenas a foto do aluno!
                            </div>
                        </div>
                        
                        <p class="mb-0">
                            Tem certeza que deseja remover a foto do aluno <strong id="removePhotoStudentName"></strong>?
                        </p>
                        <p class="text-muted small mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            O aluno permanecerá na turma, mas precisará tirar uma nova foto.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-camera"></i> Remover Foto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para preview da foto original -->
    <div class="modal fade" id="previewPhotoModal" tabindex="-1" aria-labelledby="previewPhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewPhotoModalLabel">
                        <i class="bi bi-camera-fill me-2"></i>
                        Preview - <span id="previewStudentName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center p-4">
                    <div class="position-relative d-inline-block">
                        <!-- Placeholder inicial -->
                        <img id="previewImage" 
                             src="{{ url_for('static', filename='student_icon.jpg') }}" 
                             alt="Carregando foto..." 
                             class="img-fluid rounded shadow preview-image-modal">
                        
                        <!-- Loading spinner -->
                        <div id="previewSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-muted">
                        <small><i class="bi bi-info-circle me-1"></i>Foto original</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Fechar
                    </button>
                    <a id="downloadPhotoBtn" href="#" class="btn btn-primary" download>
                        <i class="bi bi-download"></i> Download
                    </a>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para upload manual de foto do aluno -->
    <div class="modal fade" id="manualUploadPhotoStudentModal" tabindex="-1" aria-labelledby="manualUploadPhotoStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manualUploadPhotoStudentModalLabel">
                        <i class="bi bi-file-earmark-person-fill me-2"></i>
                        Upload Foto de <span id="manualUploadStudentName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('student') }}" id="manualUploadPhotoStudentForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <!-- Inputs hidden -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="action" value="crud_student_manual_upload_photo">
                        <input type="hidden" name="turma" value="{{ turma }}">
                        <input type="hidden" name="aluno_id" id="manualUploadAlunoId">
                        <div class="mb-3">
                            <label for="manualUploadPhotoFile" class="form-label">Selecionar foto</label>
                            <input type="file" class="form-control" id="manualUploadPhotoFile" name="foto" accept="image/*" required>
                            <div class="form-text">Apenas ficheiros de imagem (JPG, PNG, etc.)</div>
                        </div>
                        <div class="alert alert-info d-flex align-items-start">
                            <i class="bi bi-info-circle me-2 mt-1"></i>
                            <div>
                                <strong>Nota:</strong><br>
                                A foto será associada ao aluno selecionado.<br>
                                O ficheiro deve ser uma imagem clara e recente do aluno.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-upload"></i> Enviar Foto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Mobile bottom buttons -->
    <div class="d-lg-none fixed-bottom bg-light border-top p-3">
        <div class="container">
            <div class="row g-2">
                <div class="col-4">
                    <a href="{{ url_for('turmas') }}" class="btn btn-secondary w-100 btn-sm mobile-btn-inline">
                        <i class="bi bi-arrow-left"></i>
                        <small>Voltar</small>
                    </a>
                </div>
                <div class="col-4">
                    <div class="dropdown w-100">
                        <button class="btn btn-primary w-100 btn-sm dropdown-toggle mobile-btn-inline" type="button" id="mobileDownloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download"></i>
                            <small>Download</small>
                        </button>
                        <ul class="dropdown-menu w-100 shadow border-0" aria-labelledby="mobileDownloadDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.zip') }}">
                                <i class="bi bi-file-earmark-zip me-2 text-primary"></i> {{ nome_seguro }}.zip
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.thumbs.zip') }}">
                                <i class="bi bi-file-earmark-zip-fill me-2 text-info"></i> {{ nome_seguro }}.thumbs.zip
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('download', ficheiro=nome_seguro + '.docx') }}">
                                <i class="bi bi-file-earmark-word me-2 text-success"></i> {{ nome_seguro }}.docx
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-4">
                    <button onclick="confirmLogout()" class="btn btn-outline-secondary w-100 btn-sm mobile-btn-inline">
                        <i class="bi bi-box-arrow-right"></i>
                        <small>Sair</small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Captura de Foto -->
    <div class="modal fade" id="capturePhotoModal" tabindex="-1" aria-labelledby="capturePhotoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen modal-dialog-centered">
            <div class="modal-content d-flex flex-column h-100">
                <div class="modal-header bg-primary text-white flex-shrink-0">
                    <h5 class="modal-title" id="capturePhotoModalLabel">
                        <i class="bi bi-camera me-2"></i>Capturar Foto <span id="modalAlunoNome"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 flex-grow-1 d-flex flex-column">
                    <!-- Layout responsivo baseado na orientação -->
                    <div class="capture-layout flex-grow-1">
                        <!-- Seção da câmara (2/3 do espaço) -->
                        <div class="capture-video-section">
                            <div class="p-3 h-100 d-flex flex-column">
                                <div class="video-container flex-grow-1 d-flex align-items-center justify-content-center">
                                    <video id="modalCameraVideo" autoplay class="border rounded shadow-sm"></video>
                                </div>
                            </div>
                        </div>
                        
        <!-- Seção dos controles (1/3 do espaço) -->
                        <div class="capture-controls-section">
                            <div class="p-2 h-100 d-flex flex-column">
                                <div class="d-grid gap-2">
                                    <button type="button" id="modalCaptureButton" class="btn btn-primary btn-lg">
                                        <i class="bi bi-camera me-2"></i>Capturar Foto
                                    </button>
                                    
                                    <div class="camera-section">
                                        <label class="form-label fw-semibold mb-1">
                                            <i class="bi bi-camera-video me-2"></i>Câmera:
                                        </label>
                                        <div id="modalCameraButtons" class="d-flex flex-wrap gap-1 justify-content-center"></div>
                                    </div>
                                    
                                    <div class="quality-section">
                                        <label class="form-label fw-semibold mb-1">
                                            <i class="bi bi-gear me-2"></i>Qualidade:
                                        </label>
                                        <div class="btn-group w-100" role="group" aria-label="Qualidade da foto">
                                            <input type="radio" class="btn-check" name="photoQuality" id="qualityLow" value="low">
                                            <label class="btn btn-outline-primary btn-sm" for="qualityLow">
                                                <i class="bi bi-speedometer me-1"></i>LOW
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="photoQuality" id="qualityMed" value="med" checked>
                                            <label class="btn btn-outline-primary btn-sm" for="qualityMed">
                                                <i class="bi bi-speedometer2 me-1"></i>MED
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="photoQuality" id="qualityHigh" value="high">
                                            <label class="btn btn-outline-primary btn-sm" for="qualityHigh">
                                                <i class="bi bi-lightning me-1"></i>HIGH
                                            </label>
                                        </div>
                                        <small class="text-muted mt-1 d-block text-center">
                                            LOW: 640x480 • MED: 1280x720 • HIGH: 1920x1080
                                        </small>
                                    </div>
                                    
                                    <div class="text-center">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <kbd>Enter</kbd> capturar • <kbd>Esc</kbd> fechar
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer d-block d-md-none">
                    <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-2"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Layout de captura responsivo */
        .capture-layout {
            display: flex;
            min-height: 100%;
        }
        
        /* Portrait (vertical) - padrão para mobile */
        @media (orientation: portrait), (max-width: 767px) {
            .capture-layout {
                flex-direction: column;
                height: 100vh; /* Altura total da viewport */
                width: 100vw; /* Largura total da viewport */
                position: relative;
            }
            
            .capture-video-section {
                flex: 1; /* Cresce para ocupar espaço disponível */
                min-height: 0;
                height: calc(100vh - 140px); /* Muito mais espaço para a câmera - apenas 140px para controles */
                width: 100%;
                overflow: hidden;
            }
            
            .capture-controls-section {
                flex: 0 0 110px; /* Altura ajustada para acomodar todas as funcionalidades */
                height: 110px;
                min-height: 110px;
                max-height: 110px;
                width: 100vw; /* Largura total da viewport */
                position: relative;
                left: 0;
                right: 0;
                border-top: 1px solid #dee2e6;
                overflow-y: auto; /* Scroll para conteúdo que não cabe */
                display: flex !important;
                visibility: visible !important;
                background: white;
                z-index: 5;
            }
            
            #modalCameraVideo {
                max-height: calc(100vh - 150px); /* Espaço para a câmera com funcionalidades */
                max-width: 100%;
                width: 100%;
                object-fit: cover;
            }
            
            /* Garantir que o botão de captura seja sempre visível */
            #modalCaptureButton {
                min-height: 36px !important; /* Altura ainda mais reduzida */
                font-size: 0.8rem !important;
                padding: 0.4rem 0.6rem !important;
                margin-bottom: 0.1rem !important; /* Margem mínima */
                display: block !important;
                visibility: visible !important;
                position: sticky !important; /* Manter visível no topo */
                top: 0 !important;
                z-index: 10 !important;
                background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
                border: none !important;
                color: white !important;
                border-radius: 0.375rem !important;
            }
        }
        
        /* Landscape (horizontal) - tablets e desktop */
        @media (orientation: landscape) and (min-width: 768px) {
            .capture-layout {
                flex-direction: row;
                height: 100%;
            }
            
            .capture-video-section {
                flex: 2; /* 2/3 do espaço */
                min-height: 0;
                max-width: 66.66%; /* Garante que não excede 2/3 */
            }
            
            .capture-controls-section {
                flex: 1; /* 1/3 do espaço */
                min-height: 0;
                max-width: 33.33%; /* Garante que não excede 1/3 */
                border-left: 1px solid #dee2e6;
                overflow-y: auto; /* Scroll se necessário */
            }
            
            #modalCameraVideo {
                max-height: 70vh;
                max-width: 100%;
                object-fit: cover;
            }
        }
        
        /* Mobile landscape específico */
        @media (orientation: landscape) and (max-height: 500px) {
            .capture-video-section {
                max-width: 60%; /* Menos espaço para dar mais aos controles */
            }
            
            .capture-controls-section {
                max-width: 40%; /* Mais espaço para os controles */
            }
            
            #modalCameraVideo {
                max-height: 60vh;
            }
            
            .capture-controls-section .btn {
                padding: 0.5rem 0.75rem; /* Botões maiores */
                font-size: 0.9rem;
            }
            
            .capture-controls-section .form-label {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            
            /* Garantir visibilidade do botão principal */
            #modalCaptureButton {
                min-height: 40px !important;
                font-size: 0.9rem !important;
                padding: 0.5rem 1rem !important;
            }
        }
        
        /* Ajustes para o vídeo */
        .video-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #modalCameraVideo {
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        /* Botões de câmera e controles - SEMPRE VISÍVEIS */
        @media (max-width: 767px) {
            /* Garantir que todos os controles sejam visíveis */
            .capture-controls-section {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                max-height: calc(100vh - 75vh) !important; /* Altura dinâmica para preencher espaço */
                min-height: 110px !important;
                height: auto !important; /* Altura automática */
                width: 100vw !important; /* Largura total da viewport */
                position: absolute !important; /* Posicionamento absoluto */
                bottom: 60px !important; /* Deixa espaço para o botão cancelar */
                left: 0 !important;
                right: 0 !important;
                overflow-y: auto !important; /* Scroll para conteúdo extra */
                background: white !important;
                border-top: 2px solid #dee2e6 !important;
                z-index: 10 !important;
            }
            
            .camera-section, .quality-section {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            #modalCameraButtons {
                display: flex !important;
                visibility: visible !important;
                flex-wrap: wrap !important;
                gap: 0.15rem !important; /* Gap reduzido */
                justify-content: center !important;
            }
            
            #modalCameraButtons .btn {
                font-size: 0.6rem !important; /* Texto ainda menor */
                padding: 0.15rem 0.25rem !important; /* Padding muito reduzido */
                min-height: 24px !important; /* Altura muito menor */
                display: inline-flex !important;
                visibility: visible !important;
            }
            
            /* Ajuste específico para orientação vertical */
            .capture-controls-section .d-grid {
                gap: 0.1rem !important; /* Gap mínimo */
                display: grid !important;
            }
            
            .capture-controls-section .btn-lg {
                padding: 0.4rem 0.6rem !important; /* Padding muito reduzido */
                font-size: 0.8rem !important; /* Fonte menor */
                min-height: 36px !important; /* Altura muito reduzida */
            }
            
            /* Priorizar o botão de captura - sempre no topo */
            #modalCaptureButton {
                order: -1 !important; /* Força o botão a aparecer primeiro */
                margin-bottom: 0.1rem !important; /* Margem mínima */
                background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
                border: none !important;
                color: white !important;
                font-weight: bold !important;
                display: block !important;
                visibility: visible !important;
                position: sticky !important; /* Manter fixo no topo do scroll */
                top: 0 !important;
                z-index: 15 !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
                border-radius: 0.375rem !important;
            }
            
            /* Compactar outros elementos */
            .capture-controls-section .form-label {
                font-size: 0.65rem !important; /* Fonte menor */
                margin-bottom: 0.05rem !important; /* Margem mínima */
                display: block !important;
                visibility: visible !important;
                line-height: 1.1 !important;
            }
            
            .capture-controls-section .btn-group {
                display: flex !important;
                visibility: visible !important;
            }
            
            .capture-controls-section .btn-group .btn {
                font-size: 0.6rem !important; /* Fonte menor */
                padding: 0.15rem 0.25rem !important; /* Padding mínimo */
                min-height: 24px !important; /* Altura muito menor */
                display: inline-flex !important;
                visibility: visible !important;
                flex: 1 !important;
            }
            
            .capture-controls-section small {
                font-size: 0.55rem !important; /* Fonte muito pequena mas visível */
                display: block !important; /* Mostrar novamente */
                visibility: visible !important;
                line-height: 1.1 !important;
                margin-top: 0.1rem !important;
            }
            
            /* Forçar que o container dos controles seja visível e ocupe largura total */
            .capture-controls-section .p-2 {
                display: flex !important;
                flex-direction: column !important;
                visibility: visible !important;
                min-height: 110px !important; /* Altura para funcionalidades */
                max-height: 110px !important;
                width: 100% !important;
                overflow-y: auto !important;
                padding: 0.15rem 0.4rem 0.15rem 0.4rem !important; /* Padding ajustado */
                margin: 0 !important;
            }
            
            /* Ajustar o modal body para o novo espaço dos controles */
            .modal-body {
                padding-bottom: 110px !important; /* Espaço para a secção de controles */
            }
            
            /* Garantir que a câmera não seja coberta */
            .capture-video-section {
                margin-bottom: 110px !important; /* Margem ajustada */
                height: calc(100vh - 190px) !important; /* Espaço para a câmera */
            }
            
            /* Eliminar espaço entre controles e footer */
            .modal-footer.d-block.d-md-none {
                padding: 0 !important;
                margin: 0 !important;
                border-top: none !important;
                background: white !important; /* Fundo branco para continuidade */
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 11 !important; /* Acima dos controles */
                height: 60px !important; /* Altura fixa para o botão */
            }
            
            .modal-footer.d-block.d-md-none .btn {
                margin: 0 !important;
                border-radius: 0 !important;
                border-top: 1px solid #dee2e6 !important;
                height: 60px !important; /* Altura do botão */
                line-height: 1.2 !important;
            }
            
            /* Garantir que o modal body não tenha padding inferior desnecessário */
            .modal-body {
                padding-bottom: 170px !important; /* Espaço para controles + botão cancelar */
            }
        }
    </style>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        // Função para lidar com drop de imagem no cartão do aluno
        function handleStudentCardDrop(event, card) {
            event.preventDefault();
            card.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (!files || files.length === 0) return;
            const file = files[0];
            if (!file.type.match(/^image\/(jpeg|png)$/)) {
                alert('Apenas ficheiros JPG ou PNG são permitidos.');
                return;
            }
            // Preencher dados do aluno
            const alunoId = card.getAttribute('data-aluno-id');
            const alunoNome = card.getAttribute('data-aluno-nome');
            // Abrir modal manualUploadPhotoStudentModal
            document.getElementById('manualUploadAlunoId').value = alunoId;
            document.getElementById('manualUploadStudentName').textContent = alunoNome;
            // Setar o ficheiro no input file
            const input = document.getElementById('manualUploadPhotoFile');
            // Criar um DataTransfer para simular seleção
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            // Abrir o modal
            const modal = new bootstrap.Modal(document.getElementById('manualUploadPhotoStudentModal'));
            modal.show();
        }


        function confirmLogout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = "{{ url_for('logout') }}";
            }
        }
        
        // Gerenciar cliques nos cards dos alunos
        document.querySelectorAll('.student-card').forEach(card => {
            card.addEventListener('touchstart', function() {
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        });
        

        // Modal de adicionar aluno
        const addStudentModal = document.getElementById('addStudentModal');
        const addStudentForm = document.getElementById('addStudentForm');
        
        // Limpar form quando modal abrir
        addStudentModal.addEventListener('show.bs.modal', function() {
            addStudentForm.reset();
            setTimeout(() => {
                document.getElementById('studentName').focus();
            }, 500);
        });
        
        // Validação do formulário
        addStudentForm.addEventListener('submit', function(e) {
            const nome = document.getElementById('studentName').value.trim();
            const processo = document.getElementById('studentProcess').value.trim();
            
            if (!nome || !processo) {
                e.preventDefault();
                alert('Por favor, preencha todos os campos!');
                return;
            }
        });
        
        // Permitir apenas números e letras no campo processo
        document.getElementById('studentProcess').addEventListener('input', function(e) {
            // Remove caracteres especiais exceto números, letras e alguns símbolos comuns
            this.value = this.value.replace(/[^a-zA-Z0-9\/\-_.]/g, '');
        });

        // Gerenciar modal de editar aluno
        document.querySelectorAll('.edit-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                const processo = this.dataset.processo;
                const numero = this.dataset.numero;
                const email = this.dataset.email;
                const autorizacao = this.dataset.autorizacao === 'true';
                const autorizacaoDebug = this.dataset.autorizacaoDebug;
                
                document.getElementById('editAlunoId').value = id;
                document.getElementById('editStudentName').value = nome;
                document.getElementById('editStudentProcess').value = processo;
                document.getElementById('editStudentNumber').value = numero;
                document.getElementById('editStudentEmail').value = email;
                document.getElementById('editStudentAutorizacao').checked = autorizacao;
            });
        });

        // Gerenciar modal de excluir aluno
        document.querySelectorAll('.delete-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                
                document.getElementById('deleteAlunoId').value = id;
                document.getElementById('deleteStudentName').textContent = nome;
            });
        });

        // Gerenciar modal de transferir aluno
        document.querySelectorAll('.transfer-student-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                const processo = this.dataset.processo;
                const turmaAtual = this.dataset.turmaAtual;
                
                document.getElementById('transferAlunoId').value = id;
                document.getElementById('transferStudentName').textContent = nome;
                document.getElementById('transferCurrentTurma').textContent = turmaAtual;
                
                // Carregar lista de turmas via AJAX
                loadTurmasForTransfer(turmaAtual);
            });
        });
        
        // Função para carregar turmas disponíveis para transferência
        function loadTurmasForTransfer(turmaAtual) {
            fetch("{{ url_for('turmas', api='true') }}")
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('transferTargetTurma');
                    select.innerHTML = '<option value="">Selecione a turma de destino</option>';
                    
                    data.turmas.forEach(turma => {
                        if (turma !== turmaAtual) {
                            const option = document.createElement('option');
                            option.value = turma;
                            option.textContent = turma;
                            select.appendChild(option);
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar turmas:', error);
                    const select = document.getElementById('transferTargetTurma');
                    select.innerHTML = '<option value="">Erro ao carregar turmas</option>';
                });
        }

        // Validação do formulário de edição
        document.getElementById('editStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('editStudentName').value.trim();
            const processo = document.getElementById('editStudentProcess').value.trim();
            
            if (!nome || !processo) {
                e.preventDefault();
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }
            
            if (!confirm('Confirma as alterações no aluno?')) {
                e.preventDefault();
            }
        });

        // Validação do formulário de exclusão
        document.getElementById('deleteStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('deleteStudentName').textContent;
            
            if (!confirm(`ATENÇÃO: Tem certeza absoluta que deseja excluir o aluno "${nome}"?\n\nEsta ação é IRREVERSÍVEL!`)) {
                e.preventDefault();
            }
        });

        // Validação do formulário de transferência
        document.getElementById('transferStudentForm').addEventListener('submit', function(e) {
            const nome = document.getElementById('transferStudentName').textContent;
            const turmaDestino = document.getElementById('transferTargetTurma').value;
            
            if (!turmaDestino) {
                e.preventDefault();
                alert('Por favor, selecione uma turma de destino!');
                return;
            }
        });


        // Gerenciar modal de upload manual de foto do aluno

        // Gerenciar modal de upload manual de foto do aluno
        document.querySelectorAll('.transfer-student-btn').forEach(btn => {
            if (btn.dataset.bsTarget === '#manualUploadPhotoStudentModal') {
                btn.addEventListener('click', function() {
                    document.getElementById('manualUploadAlunoId').value = this.dataset.id;
                    document.getElementById('manualUploadStudentName').textContent = this.dataset.nome;
                });
            }
        });

        // Enviar foto manualmente via AJAX
        document.getElementById('manualUploadPhotoStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;

            // Mostrar feedback visual
            submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Enviando...';
            submitButton.disabled = true;

            // Obter dados do aluno
            const alunoId = form.querySelector('#manualUploadAlunoId').value;
            const alunoData = alunosData.find(a => String(a.id) === String(alunoId));
            if (!alunoData) {
                alert('Aluno não encontrado.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                return;
            }
            const nome_seguro = "{{ nome_seguro }}";
            const processo = alunoData.processo;

            // Obter ficheiro
            const fileInput = form.querySelector('#manualUploadPhotoFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('Selecione uma imagem.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
                return;
            }

            // Ler ficheiro como base64
            const reader = new FileReader();
            reader.onload = function(ev) {
                const base64data = ev.target.result;
                // Enviar para o mesmo endpoint da captura
                fetch(`/upload/photo/${nome_seguro}/${processo}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: base64data })
                })
                .then(response => {
                    if (response.ok) {
                        // Fechar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('manualUploadPhotoStudentModal'));
                        modal.hide();

                        // Restaurar botão
                        submitButton.innerHTML = originalButtonText;
                        submitButton.disabled = false;

                        // Atualizar foto dinamicamente
                        updateStudentPhotoAfterCapture(processo);
                        
                        // Criar mensagem de sucesso
                        createFlashMessage(`Foto de ${alunoData.nome} enviada com sucesso!`, 'success');
                    } else {
                        throw new Error('Erro no upload');
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar foto:', error);
                    alert('Erro ao enviar a foto. Tente novamente.');
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                });
            };
            reader.onerror = function() {
                alert('Erro ao ler o ficheiro.');
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        // Gerenciar modal de preview da foto (usando delegação de eventos)
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                const previewBtn = e.target.closest('.preview-photo-btn');
                if (previewBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const processo = previewBtn.dataset.processo;
                    const nome = previewBtn.dataset.nome;
                    const turma = previewBtn.dataset.turma;
                    
                    // Preparar dados do modal
                    document.getElementById('previewStudentName').textContent = nome;
                    
                    // Preparar URL da foto original
                    const originalPhotoUrl = `/photos/{{ nome_seguro }}/${processo}.jpg?size=original`;
                    
                    // Preparar botão de download
                    const downloadBtn = document.getElementById('downloadPhotoBtn');
                    downloadBtn.href = originalPhotoUrl;
                    downloadBtn.download = `${nome}_${processo}.jpg`;
                    
                    // Reset da imagem para placeholder e mostrar spinner
                    const previewImage = document.getElementById('previewImage');
                    const spinner = document.getElementById('previewSpinner');
                    
                    previewImage.src = "{{ url_for('static', filename='student_icon.jpg') }}";
                    previewImage.alt = "Carregando foto...";
                    spinner.classList.remove('d-none');
                    
                    // Abrir modal usando Bootstrap diretamente
                    const modal = new bootstrap.Modal(document.getElementById('previewPhotoModal'));
                    modal.show();
                    
                    // Carregar foto original após pequeno delay
                    setTimeout(() => {
                        const img = new Image();
                        
                        img.onload = function() {
                            spinner.classList.add('d-none');
                            previewImage.src = originalPhotoUrl;
                            previewImage.alt = `Foto original de ${nome}`;
                        };
                        
                        img.onerror = function() {
                            console.error('Erro ao carregar foto para preview:', originalPhotoUrl);
                            spinner.classList.add('d-none');
                            previewImage.alt = "Erro ao carregar foto";
                        };
                        
                        img.src = originalPhotoUrl;
                    }, 200);
                }
            });
        });

        // Gerenciar modal de remover foto
        document.querySelectorAll('.remove-photo-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const id = this.dataset.id;
                const nome = this.dataset.nome;
                
                document.getElementById('removePhotoAlunoId').value = id;
                document.getElementById('removePhotoStudentName').textContent = nome;
            });
        });

        // Validação do formulário de remoção de foto - agora com AJAX
        document.getElementById('removePhotoForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir submit tradicional
            
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            // Mostrar feedback visual
            submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Removendo...';
            submitButton.disabled = true;
            
            // Enviar requisição AJAX
            fetch("{{ url_for('student') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('removePhotoModal'));
                    modal.hide();
                    
                    // Restaurar botão
                    submitButton.innerHTML = originalButtonText;
                    submitButton.disabled = false;
                    
                    // Obter dados do aluno
                    const alunoId = formData.get('aluno_id');
                    const studentName = document.getElementById('removePhotoStudentName').textContent;
                    
                    // Atualizar foto dinamicamente
                    updateStudentPhotoAfterRemoval(alunoId, studentName);
                } else {
                    throw new Error('Erro na remoção');
                }
            })
            .catch(error => {
                console.error('Erro ao remover foto:', error);
                alert('Erro ao remover a foto. Tente novamente.');
                
                // Restaurar botão
                submitButton.innerHTML = originalButtonText;
                submitButton.disabled = false;
            });
        });

        // Permitir apenas números e letras no campo processo do modal de edição
        document.getElementById('editStudentProcess').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^a-zA-Z0-9\/\-_.]/g, '');
        });

        // === SCROLL PRESERVATION ===
        const turmaName = "{{ turma }}";
        const scrollStorageKey = `turmaScrollPosition_${turmaName}`;
        
        // Dados dos alunos para uso nas funções JavaScript
        const alunosData = {{ alunos|tojson|safe }};
        
        // Função para atualizar ícones baseado nos dados atuais
        function updateAllStudentIcons() {
            alunosData.forEach(aluno => {
                const card = document.querySelector(`[data-aluno-processo="${aluno.processo}"]`);
                if (!card) return;
                
                const badge = card.querySelector('.photo-status-badge');
                if (!badge) return;
                
                // Remover classes existentes
                badge.classList.remove('success', 'danger', 'warning');
                
                // Aplicar classe e título baseado no estado atual
                if (aluno.foto_tirada) {
                    if (aluno.autorizacao) {
                        badge.classList.add('success');
                        badge.title = 'Foto tirada - Autorização concedida';
                        badge.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    } else {
                        badge.classList.add('danger');
                        badge.title = 'Foto tirada - Autorização NÃO concedida';
                        badge.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    }
                } else {
                    badge.classList.add('warning');
                    badge.title = 'Foto não tirada';
                    badge.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
                }
            });
        }
        
        // Atualizar ícones na inicialização
        document.addEventListener('DOMContentLoaded', function() {
            updateAllStudentIcons();
        });
        
        // Restaurar posição de scroll ao carregar a página
        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem(scrollStorageKey);
            if (savedPosition) {
                const position = parseInt(savedPosition, 10);
                if (!isNaN(position)) {
                    // Aguardar um pouco para garantir que a página carregou completamente
                    setTimeout(() => {
                        window.scrollTo({
                            top: position,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
        }
        
        // Salvar posição de scroll antes de sair da página
        function saveScrollPosition() {
            const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            localStorage.setItem(scrollStorageKey, scrollPosition.toString());
        }
        
        // Função para ir para captura de foto (salvando scroll)
        function goToCapturePhoto(processo) {
            // Verificar se o utilizador tem permissões
            const userRole = '{{ current_user.role }}';
            if (!['editor', 'admin'].includes(userRole)) {
                alert('Não tem permissões para capturar fotografias.');
                return;
            }
            
            // Encontrar o card do aluno pelo processo
            const alunoData = alunosData.find(a => a.processo === processo);
            
            if (alunoData) {
                // Preencher nome do aluno no modal header
                document.getElementById('modalAlunoNome').textContent = alunoData.nome;
            } else {
                // Fallback se não encontrar
                document.getElementById('modalAlunoNome').textContent = `Processo ${processo}`;
            }
            
            // Armazenar processo atual para uso na captura
            window.currentProcesso = processo;
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('capturePhotoModal'));
            modal.show();
        }
        
        // Salvar scroll em vários eventos de saída
        window.addEventListener('beforeunload', saveScrollPosition);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um link for clicado
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && !link.classList.contains('stay-on-page')) {
                saveScrollPosition();
            }
        });
        
        // Salvar scroll quando um formulário for submetido
        document.addEventListener('submit', function(e) {
            saveScrollPosition();
        });
        
        // Restaurar posição ao carregar
        document.addEventListener('DOMContentLoaded', restoreScrollPosition);
        
        // Limpar posição salva após 1 hora (para evitar acumulação)
        setTimeout(() => {
            localStorage.removeItem(scrollStorageKey);
        }, 3600000); // 1 hora
        
        // Função para abrir modal de preview (fallback)
        function openPreviewModal(processo, nome, turma) {
            // Preparar dados do modal
            document.getElementById('previewStudentName').textContent = nome;
            
            // Preparar URL da foto original
            const originalPhotoUrl = `/photos/{{ nome_seguro }}/${processo}.jpg?size=original`;
            
            // Preparar botão de download
            const downloadBtn = document.getElementById('downloadPhotoBtn');
            downloadBtn.href = originalPhotoUrl;
            downloadBtn.download = `${nome}_${processo}.jpg`;
            
            // Reset da imagem para placeholder e mostrar spinner
            const previewImage = document.getElementById('previewImage');
            const spinner = document.getElementById('previewSpinner');
            
            previewImage.src = "{{ url_for('static', filename='student_icon.jpg') }}";
            previewImage.alt = "Carregando foto...";
            spinner.classList.remove('d-none');
            
            // Carregar foto original
            setTimeout(() => {
                const img = new Image();
                
                img.onload = function() {
                    spinner.classList.add('d-none');
                    previewImage.src = originalPhotoUrl;
                    previewImage.alt = `Foto original de ${nome}`;
                };
                
                img.onerror = function() {
                    console.error('Erro ao carregar foto para preview (fallback):', originalPhotoUrl);
                    spinner.classList.add('d-none');
                    previewImage.alt = "Erro ao carregar foto";
                };
                
                img.src = originalPhotoUrl;
            }, 100);
        }
        
        // Tornar função global
        window.openPreviewModal = openPreviewModal;

        // ============================================
        // MODAL DE CAPTURA DE FOTO
        // ============================================
        
        let modalStream;
        // Constantes para localStorage
        const CAMERA_STORAGE_KEY = 'classPhotoBooth_selectedCamera';
        const QUALITY_STORAGE_KEY = 'classPhotoBooth_photoQuality';
        
        // Configurações de qualidade
        const QUALITY_SETTINGS = {
            'low': {
                video: { width: { ideal: 640 }, height: { ideal: 480 } },
                jpeg: 0.95,
                label: 'LOW (640x480)'
            },
            'med': {
                video: { width: { ideal: 1280 }, height: { ideal: 720 } },
                jpeg: 0.95,
                label: 'MED (1280x720)'
            },
            'high': {
                video: { width: { ideal: 1920 }, height: { ideal: 1080 } },
                jpeg: 0.95,
                label: 'HIGH (1920x1080)'
            }
        };
        
        function initPhotoQuality() {
            // Obter qualidade salva ou usar 'med' como padrão
            const savedQuality = localStorage.getItem(QUALITY_STORAGE_KEY) || 'med';
            
            // Selecionar o radio button correto
            const qualityRadio = document.querySelector(`input[name="photoQuality"][value="${savedQuality}"]`);
            if (qualityRadio) {
                qualityRadio.checked = true;
            }
            
            // Adicionar evento para salvar quando mudar
            document.querySelectorAll('input[name="photoQuality"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        localStorage.setItem(QUALITY_STORAGE_KEY, this.value);
                        console.error('Qualidade alterada para:', QUALITY_SETTINGS[this.value].label);
                        
                        // Reiniciar câmera com nova qualidade se estiver ativa
                        if (modalStream) {
                            const savedCameraId = localStorage.getItem(CAMERA_STORAGE_KEY);
                            startModalCamera(savedCameraId);
                        }
                    }
                });
            });
        }
        
        async function initModalCamera() {
            const modalVideo = document.getElementById('modalCameraVideo');
            const modalCameraButtons = document.getElementById('modalCameraButtons');
            
            // Limpar botões anteriores
            modalCameraButtons.innerHTML = '';
            
            try {
                // Obter dispositivos de vídeo
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Criar botões para cada câmera
                videoDevices.forEach((device, index) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-secondary';
                    button.setAttribute('data-camera-id', device.deviceId);
                    button.style.cssText = `
                        width: 80px;
                        height: 80px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        line-height: 1.2;
                        text-align: center;
                        border-radius: 8px;
                        padding: 8px 4px;
                        white-space: normal;
                        word-break: break-word;
                    `;
                    
                    const cameraName = device.label || `Câmera ${index + 1}`;
                    const shortName = cameraName.length > 12 ? cameraName.substring(0, 12) + '...' : cameraName;
                    
                    button.innerHTML = `
                        <i class="bi bi-camera mb-1 camera-btn-icon"></i>
                        <span class="camera-btn-label">${shortName}</span>
                    `;
                    
                    // Event listener para trocar de câmera
                    button.addEventListener('click', () => {
                        selectModalCamera(device.deviceId, button);
                    });
                    
                    modalCameraButtons.appendChild(button);
                });
                
                // Recuperar a câmera selecionada anteriormente
                const savedCameraId = localStorage.getItem(CAMERA_STORAGE_KEY);
                let initialCameraId = null;
                let initialButton = null;
                
                // Verificar se a câmera salva ainda está disponível
                if (savedCameraId) {
                    const cameraExists = videoDevices.some(device => device.deviceId === savedCameraId);
                    if (cameraExists) {
                        initialCameraId = savedCameraId;
                        initialButton = modalCameraButtons.querySelector(`[data-camera-id="${savedCameraId}"]`);
                    }
                }
                
                // Se não há câmera salva ou não está disponível, usar a primeira
                if (!initialCameraId && videoDevices.length > 0) {
                    initialCameraId = videoDevices[0].deviceId;
                    initialButton = modalCameraButtons.firstElementChild;
                }
                
                // Iniciar câmera (com a salva ou padrão)
                if (initialCameraId && initialButton) {
                    await selectModalCamera(initialCameraId, initialButton);
                }
                
            } catch (error) {
                console.error('Erro ao acessar câmeras:', error);
                alert('Erro ao acessar câmeras. Verifique as permissões.');
            }
        }
        
        async function selectModalCamera(deviceId, selectedButton) {
            // Atualizar estilos dos botões - todas as câmeras ficam secondary
            const modalCameraButtons = document.getElementById('modalCameraButtons');
            const allButtons = modalCameraButtons.querySelectorAll('button');
            
            allButtons.forEach(button => {
                button.className = 'btn btn-secondary';
            });
            
            // A câmera selecionada fica primary
            if (selectedButton) {
                selectedButton.className = 'btn btn-primary';
            }
            
            // Iniciar a câmera selecionada
            await startModalCamera(deviceId);
        }
        
        async function startModalCamera(deviceId) {
            const modalVideo = document.getElementById('modalCameraVideo');
            
            if (modalStream) {
                modalStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                // Obter qualidade selecionada
                const selectedQuality = document.querySelector('input[name="photoQuality"]:checked')?.value || 'med';
                const qualitySettings = QUALITY_SETTINGS[selectedQuality];
                
                // Construir constraints com qualidade e câmera
                const constraints = {
                    video: {
                        ...qualitySettings.video,
                        ...(deviceId ? { deviceId: { exact: deviceId } } : {})
                    }
                };
                
                console.error('Iniciando câmera com qualidade:', qualitySettings.label);
                modalStream = await navigator.mediaDevices.getUserMedia(constraints);
                modalVideo.srcObject = modalStream;
                
                // Salvar a câmera selecionada no localStorage
                if (deviceId) {
                    localStorage.setItem(CAMERA_STORAGE_KEY, deviceId);
                }
            } catch (error) {
                console.error('Erro ao acessar câmera:', error);
                // Se falhar com a câmera específica, tentar a padrão
                if (deviceId) {
                    await startModalCamera();
                } else {
                    alert('Erro ao acessar a câmera. Verifique as permissões.');
                }
            }
        }
        
        function stopModalCamera() {
            if (modalStream) {
                modalStream.getTracks().forEach(track => track.stop());
                modalStream = null;
            }
        }
        
        // Event listeners para o modal
        document.getElementById('capturePhotoModal').addEventListener('shown.bs.modal', function () {
            initPhotoQuality();
            initModalCamera();
        });
        
        document.getElementById('capturePhotoModal').addEventListener('hidden.bs.modal', function () {
            stopModalCamera();
        });
        
        // Captura de foto no modal
        document.getElementById('modalCaptureButton').addEventListener('click', function() {
            const modalVideo = document.getElementById('modalCameraVideo');
            const captureButton = this;
            
            if (!window.currentProcesso) {
                alert('Erro: processo não identificado.');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = modalVideo.videoWidth;
            canvas.height = modalVideo.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(modalVideo, 0, 0, canvas.width, canvas.height);
            
            // Obter qualidade selecionada para compressão JPEG
            const selectedQuality = document.querySelector('input[name="photoQuality"]:checked')?.value || 'med';
            const jpegQuality = QUALITY_SETTINGS[selectedQuality].jpeg;
            
            console.error('Capturando foto com qualidade JPEG:', jpegQuality);
            const photoData = canvas.toDataURL('image/jpeg', jpegQuality);
            
            // Mostrar feedback visual
            captureButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processando...';
            captureButton.disabled = true;
            
            fetch(`/upload/photo/{{ nome_seguro }}/${window.currentProcesso}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: photoData })
            })
            .then(response => {
                if (response.ok) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('capturePhotoModal'));
                    modal.hide();
                    
                    // Restaurar botão de captura
                    captureButton.innerHTML = '<i class="bi bi-camera me-2"></i>Capturar Foto';
                    captureButton.disabled = false;
                    
                    // Atualizar foto dinamicamente sem recarregar a página
                    updateStudentPhotoAfterCapture(window.currentProcesso);
                    
                    // Criar mensagem de sucesso
                    const alunoData = alunosData.find(a => a.processo === window.currentProcesso);
                    if (alunoData) {
                        createFlashMessage(`Foto de ${alunoData.nome} capturada com sucesso!`, 'success');
                    }
                } else {
                    alert('Erro ao capturar a foto.');
                    captureButton.innerHTML = '<i class="bi bi-camera me-2"></i>Capturar Foto';
                    captureButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Erro ao capturar foto:', error);
                alert('Erro ao capturar a foto.');
                captureButton.innerHTML = '<i class="bi bi-camera me-2"></i>Capturar Foto';
                captureButton.disabled = false;
            });
        });
        
        // Função para atualizar a foto do aluno dinamicamente após captura
        function updateStudentPhotoAfterCapture(processo) {
            // Encontrar o card do aluno pelo processo
            const alunoData = alunosData.find(a => a.processo === processo);
            
            if (!alunoData) {
                console.error('Aluno não encontrado para processo:', processo);
                return;
            }
            
            // Encontrar o card do aluno pelo atributo data-aluno-processo
            const targetCard = document.querySelector(`[data-aluno-processo="${processo}"]`);
            
            if (!targetCard) {
                console.error('Card do aluno não encontrado para processo:', processo);
                return;
            }
            
            // Encontrar a imagem dentro do card
            const photoImg = targetCard.querySelector('.photo-img');
            const photoContainer = targetCard.querySelector('.student-photo');
            const studentActions = targetCard.querySelector('.student-actions');
            
            if (!photoImg || !photoContainer) {
                console.error('Elementos da foto não encontrados:', {photoImg, photoContainer});
                return;
            }
            
            // Adicionar timestamp para forçar reload da imagem (cache busting)
            const timestamp = new Date().getTime();
            const newPhotoUrl = `/photos/{{ nome_seguro }}/${processo}.jpg?t=${timestamp}`;
            
            // Criar nova imagem para pré-carregar
            const newImg = new Image();
            
            newImg.onload = function() {
                // Atualizar a imagem principal
                photoImg.src = newPhotoUrl;
                photoImg.alt = `Foto de ${alunoData.nome}`;
                photoImg.classList.remove('placeholder');
                
                // Adicionar onclick para captura de foto se for editor/admin
                const userRole = '{{ current_user.role }}';
                if (['editor', 'admin'].includes(userRole)) {
                    photoImg.onclick = function() { goToCapturePhoto(processo); };
                    photoImg.style.cursor = 'pointer';
                }
                const cameraBtn = photoContainer.querySelector('.btn-secondary');
                if (cameraBtn) {
                    // Criar botão de remover foto
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle remove-photo-btn';
                    removeBtn.setAttribute('data-id', String(alunoData.id));
                    removeBtn.setAttribute('data-nome', alunoData.nome);
                    removeBtn.setAttribute('data-bs-toggle', 'modal');
                    removeBtn.setAttribute('data-bs-target', '#removePhotoModal');
                    removeBtn.title = 'Clique para remover a foto';
                    removeBtn.style.cssText = 'width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = function(event) {
                        event.stopPropagation();
                    };
                    removeBtn.innerHTML = '<i class="bi bi-x photo-status-icon-xs"></i>';
                    
                    // Adicionar event listener para o modal de remover foto
                    removeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const id = this.dataset.id;
                        const nome = this.dataset.nome;
                        
                        document.getElementById('removePhotoAlunoId').value = id;
                        document.getElementById('removePhotoStudentName').textContent = nome;
                    });
                    
                    // Substituir botão de câmera pelo de remover
                    photoContainer.replaceChild(removeBtn, cameraBtn);
                }
                
                // Adicionar ícone de "foto recente" no canto superior esquerdo
                if (!photoContainer.querySelector('.recent-photo-icon')) {
                    const recentIcon = document.createElement('div');
                    recentIcon.className = 'position-absolute top-0 start-0 m-1 recent-photo-icon';
                    
                    // Verificar autorização para definir cor e título
                    if (alunoData.autorizacao) {
                        recentIcon.title = 'Foto tirada - Autorização concedida';
                        recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #28a745; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                    } else {
                        recentIcon.title = 'Foto tirada - Autorização NÃO concedida';
                        recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #dc3545; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                    }
                    
                    recentIcon.innerHTML = '<i class="bi bi-emoji-smile-fill text-white photo-status-icon-sm"></i>';
                    photoContainer.appendChild(recentIcon);
                }
                
                // Mostrar botão de preview (sempre presente, mas oculto se não há foto)
                if (studentActions) {
                    const previewBtn = studentActions.querySelector('.preview-photo-btn');
                    if (previewBtn) {
                        previewBtn.style.display = 'inline-block';
                    }
                }
                
                // Atualizar contador de fotos na navbar
                updatePhotoCounter();
                
                // Adicionar efeito visual de "nova foto"
                photoImg.style.opacity = '0';
                photoImg.style.transform = 'scale(0.8)';
                
                setTimeout(() => {
                    photoImg.style.transition = 'all 0.3s ease';
                    photoImg.style.opacity = '1';
                    photoImg.style.transform = 'scale(1)';
                }, 100);
            };
            
            newImg.onerror = function() {
                console.error('Erro ao carregar nova foto do aluno:', processo);
                createFlashMessage('Erro ao atualizar foto. Tente novamente.', 'error');
            };
            
            // Iniciar carregamento da nova imagem
            newImg.src = newPhotoUrl;
        }
        
        // Função para atualizar contador de fotos na navbar
        function updatePhotoCounter() {
            const navbarInfo = document.querySelector('.navbar-brand small');
            if (navbarInfo) {
                // Contar fotos atuais na página
                const photosCount = document.querySelectorAll('.photo-img:not(.placeholder)').length;
                const totalStudents = alunosData.length;
                
                navbarInfo.innerHTML = `${totalStudents} aluno${totalStudents !== 1 ? 's' : ''} • ${photosCount} foto${photosCount !== 1 ? 's' : ''}`;
            }
        }
        
        // Função para atualizar a foto do aluno dinamicamente após remoção
        function updateStudentPhotoAfterRemoval(alunoId, studentName) {
            // Encontrar o card do aluno pelo ID
            const allCards = document.querySelectorAll('.student-card');
            let targetCard = null;
            
            // Procurar o card que contém este aluno pelo botão de remoção
            allCards.forEach(card => {
                const removeBtn = card.querySelector('.remove-photo-btn');
                if (removeBtn && removeBtn.dataset.id === alunoId) {
                    targetCard = card;
                }
            });
            
            if (!targetCard) {
                console.error('Card do aluno não encontrado para ID:', alunoId);
                return;
            }
            
            // Encontrar elementos dentro do card
            const photoImg = targetCard.querySelector('.photo-img');
            const photoContainer = targetCard.querySelector('.student-photo');
            const studentActions = targetCard.querySelector('.student-actions');
            const removeBtn = photoContainer.querySelector('.remove-photo-btn');
            const previewBtn = studentActions ? studentActions.querySelector('.preview-photo-btn') : null;
            
            if (!photoImg || !photoContainer) {
                console.error('Elementos da foto não encontrados no card');
                return;
            }
            
            // Reverter imagem para placeholder
            photoImg.src = "{{ url_for('static', filename='student_icon.jpg') }}";
            photoImg.alt = "Clique para capturar foto";
            photoImg.classList.add('placeholder');
            
            // Remover botão de remoção de foto e adicionar botão de câmera
            if (removeBtn) {
                // Obter processo do aluno para o botão de câmera
                const alunoProcesso = targetCard.getAttribute('data-aluno-processo');
                
                // Criar botão de câmera
                const cameraBtn = document.createElement('button');
                cameraBtn.className = 'btn btn-sm btn-secondary position-absolute top-0 end-0 m-1 rounded-circle';
                cameraBtn.title = 'Clique para capturar foto';
                cameraBtn.style.cssText = 'width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center;';
                cameraBtn.onclick = function(event) {
                    event.stopPropagation();
                    goToCapturePhoto(alunoProcesso);
                };
                cameraBtn.innerHTML = '<i class="bi bi-camera photo-status-icon-xs"></i>';
                
                // Substituir botão de remover pelo de câmera
                photoContainer.replaceChild(cameraBtn, removeBtn);
            }
            
            // Trocar ícone de "foto tirada" pelo ícone de "foto não tirada"
            const recentIcon = photoContainer.querySelector('.recent-photo-icon');
            if (recentIcon) {
                // Atualizar para emoji tonto (foto não tirada)
                recentIcon.title = 'Foto não tirada';
                recentIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #ffc107; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                recentIcon.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
            } else {
                // Criar ícone de "foto não tirada" se não existir
                const dizzyIcon = document.createElement('div');
                dizzyIcon.className = 'position-absolute top-0 start-0 m-1 recent-photo-icon';
                dizzyIcon.title = 'Foto não tirada';
                dizzyIcon.style.cssText = 'width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background-color: #ffc107; border-radius: 50%; box-shadow: 0px 2px 4px rgba(0,0,0,0.3);';
                dizzyIcon.innerHTML = '<i class="bi bi-emoji-dizzy-fill text-white photo-status-icon-sm"></i>';
                photoContainer.appendChild(dizzyIcon);
            }
            
            // Ocultar botão de preview se existir
            if (previewBtn) {
                previewBtn.style.display = 'none';
            }
            
            // Atualizar contador de fotos na navbar
            updatePhotoCounter();
            
            // Criar mensagem flash dinâmica
            createFlashMessage(`Foto de ${studentName} removida com sucesso!`, 'success');
            
            // Adicionar efeito visual de "foto removida"
            photoImg.style.opacity = '0';
            photoImg.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                photoImg.style.transition = 'all 0.3s ease';
                photoImg.style.opacity = '1';
                photoImg.style.transform = 'scale(1)';
            }, 100);
        }
        
        // Função para criar mensagem flash dinâmica que imita o sistema Flask
        function createFlashMessage(message, category) {
            // Encontrar o container das mensagens flash existentes
            const flashContainer = document.querySelector('.container .alert');
            let targetContainer;
            
            if (flashContainer) {
                // Se já existem mensagens flash, usar o mesmo container
                targetContainer = flashContainer.parentElement;
            } else {
                // Se não existem mensagens, criar container após a navbar
                const navbar = document.querySelector('.navbar');
                targetContainer = document.createElement('div');
                targetContainer.className = 'container mt-3';
                navbar.parentNode.insertBefore(targetContainer, navbar.nextSibling);
            }
            
            // Criar a mensagem flash com o mesmo estilo das mensagens Flask
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${category === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.setAttribute('role', 'alert');
            
            const iconClass = category === 'error' ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill';
            
            alertDiv.innerHTML = `
                <i class="bi ${iconClass} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            targetContainer.appendChild(alertDiv);
            
            // Remover automaticamente após 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                    // Se não há mais mensagens, remover o container
                    if (targetContainer.children.length === 0 && !targetContainer.querySelector('.alert')) {
                        targetContainer.remove();
                    }
                }
            }, 5000);
        }

        // Atalhos de teclado no modal
        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('capturePhotoModal');
            const isModalOpen = modal.classList.contains('show');
            
            if (isModalOpen) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('modalCaptureButton').click();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();
                }
            }
        });

    </script>
</body>
</html>
